<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - Manajemen Sekolah</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #e9ecef; }
        .wrapper { display: flex; width: 100%; align-items: stretch; }
        #sidebar { min-width: 250px; max-width: 250px; background: #212529; color: #fff; transition: all 0.3s; z-index: 1031; }
        #sidebar.active { margin-left: -250px; }
        #sidebar .sidebar-header { padding: 20px; background: #343a40; position: relative; }
        #sidebar ul.components { padding: 20px 0; }
        #sidebar ul p { color: #fff; padding: 10px; }
        #sidebar ul li a { padding: 12px 20px; font-size: 1.1em; display: block; color: #ced4da; border-left: 4px solid transparent; text-decoration: none; transition: all 0.2s; }
        #sidebar ul li a:hover { color: #fff; background: #343a40; border-left: 4px solid #007bff; }
        #sidebar ul li.active > a, a[aria-expanded="true"] { color: #fff; background: #007bff; border-left: 4px solid #80bdff; }
        a[data-toggle="collapse"] { position: relative; }
        .dropdown-toggle::after { display: block; position: absolute; top: 50%; right: 20px; transform: translateY(-50%); }
        #content { width: 100%; padding: 0; min-height: 100vh; transition: all 0.3s; }
        .card-title-centered { text-align: center; }
        .overlay { display: none; position: fixed; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.7); z-index: 1030; }
        .overlay.active { display: block; }
        #sidebarCloseBtn { position: absolute; top: 15px; right: 15px; }
        .stat-card .display-4 { font-weight: 700; }
        .stat-card i { font-size: 2.5rem; opacity: 0.3; }
        
        @media (max-width: 768px) {
            #sidebar { margin-left: -250px; position: fixed; top: 0; left: 0; height: 100vh; }
            #sidebar.active { margin-left: 0; }
            #sidebarCollapse { display: block; }
            #action-buttons { flex-wrap: wrap; justify-content: flex-end; }
            #action-buttons > div > button { margin-bottom: 0.5rem; }
        }
    </style>
</head>
<body>

    <!-- Login Container -->
    <div class="container" id="login-container">
        <div class="row justify-content-center align-items-center" style="height: 100vh;">
            <div class="col-md-6 col-lg-5">
                <div class="card shadow-lg border-0 rounded-lg p-4">
                    <div class="card-body">
                        <div class="back-link-container text-center mb-4">
                            <a href="index.html" class="text-muted text-decoration-none d-inline-flex align-items-center">
                                <i class="fas fa-arrow-left mr-2"></i> Kembali ke Halaman Utama
                            </a>
                        </div>
                        <h3 class="card-title-centered text-primary font-weight-bolder mb-4">
                            <i class="fas fa-user-shield mr-2"></i> Login Admin
                        </h3>
                        <form id="loginFormAdmin">
                            <div class="form-group">
                                <label for="username">Username Admin:</label>
                                <input type="text" id="username" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="password">Password:</label>
                                <input type="password" id="password" class="form-control" required>
                            </div>
                            <button type="submit" id="loginButton" class="btn btn-primary btn-block">Login</button>
                            <div id="login-error" class="alert alert-danger mt-3" style="display:none;"></div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="wrapper" id="main-wrapper" style="display:none;">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h3>Panel Admin</h3>
                <button type="button" id="sidebarCloseBtn" class="btn btn-sm btn-light d-md-none">&times;</button>
            </div>
            <ul class="list-unstyled components">
                <li class="active"><a href="#" id="dashboard-link"><i class="fas fa-tachometer-alt mr-2"></i> Dasbor Utama</a></li>
                <li>
                    <a href="#studentSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle"><i class="fas fa-user-graduate mr-2"></i> Manajemen Siswa</a>
                    <ul class="collapse list-unstyled" id="studentSubmenu">
                        <div id="class-list-container"></div>
                    </ul>
                </li>
                <li>
                    <a href="#" id="manage-staff-link"><i class="fas fa-users-cog mr-2"></i> Manajemen Staf</a>
                </li>
            </ul>
            <ul class="list-unstyled CTAs p-3">
                 <li><button id="promote-class-btn" class="btn btn-warning btn-block mb-2"><i class="fas fa-graduation-cap mr-2"></i> PROSES KENAIKAN KELAS</button></li>
                 <li><button id="logoutButton" class="btn btn-danger btn-block"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button></li>
            </ul>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-info d-md-none">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <span class="navbar-brand mb-0 h1 d-none d-md-block">Panel Admin Sekolah</span>
                </div>
            </nav>
            <div class="p-4">
                <div id="main-content-header" class="mb-4">
                    <h4 id="content-title" class="text-dark font-weight-bold">Selamat Datang</h4>
                    <p id="content-subtitle" class="text-muted">Pilih menu dari sidebar untuk memulai.</p>
                </div>
                
                <!-- Dashboard View -->
                <div id="dashboard-view">
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="card text-white bg-success shadow h-100 stat-card">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">Siswa Aktif</h5>
                                        <h2 class="display-4" id="total-aktif">...</h2>
                                    </div>
                                    <i class="fas fa-user-check"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card text-white bg-primary shadow h-100 stat-card">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">Siswa Lulus</h5>
                                        <h2 class="display-4" id="total-lulus">...</h2>
                                    </div>
                                    <i class="fas fa-user-graduate"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card text-white bg-secondary shadow h-100 stat-card">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title">Siswa Pindah</h5>
                                        <h2 class="display-4" id="total-pindah">...</h2>
                                    </div>
                                    <i class="fas fa-user-minus"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Jumlah Siswa per Kelas</h5>
                                    <canvas id="classChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="row mt-4">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-body">
                                    <h5 class="card-title">Ekspor Data</h5>
                                    <p class="card-text">Unduh semua data siswa dalam format file CSV.</p>
                                    <button id="export-csv-btn" class="btn btn-info"><i class="fas fa-file-csv mr-2"></i> Ekspor Semua Data Siswa (CSV)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student Management View -->
                <div id="student-management-view" style="display:none;">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                                 <input type="text" id="searchInputSiswa" class="form-control" style="max-width: 400px;" placeholder="Cari nama siswa di kelas ini...">
                                 <div id="action-buttons" class="d-flex mt-2 mt-md-0">
                                    <div id="default-actions">
                                        <button class="btn btn-warning" id="bulk-edit-btn"><i class="fas fa-pencil-alt"></i> Edit Massal</button>
                                        <button class="btn btn-secondary" id="reorder-absent-btn"><i class="fas fa-sort-numeric-down"></i> Urutkan</button>
                                        <button class="btn btn-success" id="add-student-btn"><i class="fas fa-plus"></i> Tambah</button>
                                        <button class="btn btn-info" id="bulk-add-btn"><i class="fas fa-users"></i> Massal</button>
                                    </div>
                                    <div id="edit-mode-actions" style="display:none;">
                                        <button class="btn btn-success" id="save-bulk-changes-btn"><i class="fas fa-save"></i> Simpan</button>
                                        <button class="btn btn-secondary" id="cancel-bulk-edit-btn"><i class="fas fa-times"></i> Batal</button>
                                    </div>
                                 </div>
                            </div>
                            <div id="student-list-container" class="table-responsive"></div>
                        </div>
                    </div>
                </div>

                <!-- Staff Management View -->
                <div id="staff-management-view" style="display:none;">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <input type="text" id="searchInputStaff" class="form-control w-50" placeholder="Cari nama atau username...">
                                <button class="btn btn-success" id="add-staff-btn"><i class="fas fa-plus"></i> Tambah Staf Baru</button>
                            </div>
                            <div id="staff-list-container" class="table-responsive"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="overlay"></div>

    <!-- Modals -->
    <!-- Student Modals -->
    <div class="modal fade" id="studentModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="modalTitle"></h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body"><form id="studentForm">
            <input type="hidden" id="editNisn" readonly>
            <div class="row">
                <div class="col-md-6 form-group"><label>NISN</label><input type="text" id="nisn" class="form-control" required></div>
                <div class="col-md-6 form-group"><label>Nama Lengkap</label><input type="text" id="nama" class="form-control" required></div>
                <div class="col-md-6 form-group"><label>Kelas</label><input type="text" id="kelas" class="form-control" required></div>
                <div class="col-md-6 form-group"><label>Nomor Absen</label><input type="number" id="nomorAbsen" class="form-control" placeholder="Contoh: 1, 2, 3..."></div>
                <div class="col-md-6 form-group"><label>Tanggal Lahir (Format: DDMMYYYY)</label><input type="text" id="tglLahir" class="form-control" placeholder="Contoh: 05082010"></div>
                <div class="col-md-6 form-group"><label>Nama Orang Tua</label><input type="text" id="namaOrtu" class="form-control"></div>
                <div class="col-md-6 form-group"><label>Nomor WhatsApp</label><input type="text" id="nomorWa" class="form-control" placeholder="Contoh: 08123456789"></div>
                <div class="col-md-6 form-group"><label>Status Siswa</label><select id="status" class="form-control"><option value="Aktif">Aktif</option><option value="Lulus">Lulus</option><option value="Pindah">Pindah</option></select></div>
            </div>
        </form></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" id="saveStudentBtn" class="btn btn-primary"></button></div>
    </div></div></div>
    <div class="modal fade" id="bulkAddModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Tambah Siswa Secara Massal</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body">
            <p class="text-muted">Salin data dari spreadsheet dan tempel di bawah. Pastikan urutan kolomnya adalah: <br><strong>NISN, Nama, Kelas, No. Absen, Tgl Lahir (DDMMYYYY), Nama Ortu, No. WA</strong></p>
            <textarea id="bulkData" class="form-control" rows="10" placeholder="Contoh:&#10;123456789,Budi Doremi,4,1,01012015,Ayah Budi,08123456789"></textarea>
            <div id="bulk-progress" class="mt-3" style="display:none;"></div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" id="processBulkAddBtn" class="btn btn-primary">Proses & Simpan</button></div>
    </div></div></div>
    <div class="modal fade" id="reorderModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Urutkan Nomor Absen</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body">
            <p class="text-muted">Gunakan tombol panah untuk mengubah urutan.</p>
            <ul class="list-group" id="reorder-list"></ul>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" id="saveOrderBtn" class="btn btn-primary">Simpan Urutan</button></div>
    </div></div></div>
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header bg-danger text-white"><h5 class="modal-title">Konfirmasi Hapus</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body">
            <p>Apakah Anda yakin ingin menghapus data siswa:</p>
            <h5 id="studentNameToDelete" class="text-center font-weight-bold"></h5>
            <input type="hidden" id="nisnToDelete">
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" id="confirmDeleteBtn" class="btn btn-danger">Ya, Hapus</button></div>
    </div></div></div>
    <div class="modal fade" id="naikKelasConfirmModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header bg-warning text-dark"><h5 class="modal-title">Konfirmasi Kenaikan Kelas</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body">
            <p>Anda akan memproses kenaikan kelas untuk <strong>semua siswa aktif</strong>.</p>
            <ul class="list-group list-group-flush">
                <li class="list-group-item">Siswa Kelas 1 → <strong>Kelas 2</strong></li>
                <li class="list-group-item">Siswa Kelas 2 → <strong>Kelas 3</strong></li>
                <li class="list-group-item">Siswa Kelas 3 → <strong>Kelas 4</strong></li>
                <li class="list-group-item">Siswa Kelas 4 → <strong>Kelas 5</strong></li>
                <li class="list-group-item">Siswa Kelas 5 → <strong>Kelas 6</strong></li>
                <li class="list-group-item">Siswa Kelas 6 → Status <strong>Lulus</strong></li>
            </ul>
            <p class="text-danger font-weight-bold mt-3">PERHATIAN: Tindakan ini tidak dapat dibatalkan.</p>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" id="confirmNaikKelasBtn" class="btn btn-warning">Ya, Proses Kenaikan Kelas</button></div>
    </div></div></div>

    <!-- Staff Modals -->
    <div class="modal fade" id="staffModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="staffModalTitle"></h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body"><form id="staffForm">
            <input type="hidden" id="editDocId">
            <div class="row">
                <div class="col-md-6 form-group"><label>Nama Lengkap</label><input type="text" id="namaLengkap" class="form-control" required></div>
                <div class="col-md-6 form-group"><label>Username</label><input type="text" id="staffUsername" class="form-control" required></div>
                <div class="col-md-6 form-group"><label>Password</label><input type="password" id="staffPassword" class="form-control" required></div>
                <div class="col-md-6 form-group"><label>Peran (Role)</label>
                    <select id="role" class="form-control">
                        <option value="admin">Admin</option>
                        <option value="walikelas">Wali Kelas</option>
                        <option value="mapel">Guru Mapel</option>
                    </select>
                </div>
                <div class="col-md-6 form-group"><label>Kelas yang Diampu</label><input type="text" id="kelasDiampu" class="form-control" placeholder="Kosongkan jika bukan wali kelas"></div>
            </div>
        </form></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" id="saveStaffBtn" class="btn btn-primary"></button></div>
    </div></div></div>
    <div class="modal fade" id="deleteStaffConfirmModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header bg-danger text-white"><h5 class="modal-title">Konfirmasi Hapus</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body">
            <p>Apakah Anda yakin ingin menghapus data staf:</p>
            <h5 id="staffNameToDelete" class="text-center font-weight-bold"></h5>
            <input type="hidden" id="docIdToDelete">
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" id="confirmDeleteStaffBtn" class="btn btn-danger">Ya, Hapus</button></div>
    </div></div></div>


<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- GANTI DENGAN KONFIGURASI FIREBASE ANDA ---
    const firebaseConfig = {
        apiKey: "AIzaSyD4nAPhGV-USPyElTyHwiDZO0ZvUGRoK5E",
        authDomain: "sistem-absensi-sdn-cicohag.firebaseapp.com",
        projectId: "sistem-absensi-sdn-cicohag",
        storageBucket: "sistem-absensi-sdn-cicohag.appspot.com",
        messagingSenderId: "540116242535",
        appId: "1:540116242535:web:41e3e1e7456ecf1c6584c2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const loginContainer = document.getElementById('login-container');
    const mainWrapper = document.getElementById('main-wrapper');
    let allStudents = [];
    let allStaff = [];
    let currentClass = null;
    let isBulkEditMode = false;
    let classChart = null;

    // --- Login & Logout Logic ---
    document.getElementById('loginFormAdmin').addEventListener('submit', async (e) => {
        e.preventDefault();
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('login-error');
        loginButton.disabled = true;
        loginButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const snapshot = await db.collection('staff').where('username', '==', username).where('password', '==', password).where('role', '==', 'admin').get();
            if (snapshot.empty) throw new Error("Username atau password salah, atau Anda bukan admin.");

            loginContainer.style.display = 'none';
            mainWrapper.style.display = 'flex';
            renderStaticClasses();
            showDashboardView();
        } catch (error) {
            loginError.textContent = error.message;
            loginError.style.display = 'block';
        } finally {
            loginButton.disabled = false;
            loginButton.innerHTML = 'Login';
        }
    });

    document.getElementById('logoutButton').addEventListener('click', () => {
        mainWrapper.style.display = 'none';
        loginContainer.style.display = 'block';
        document.getElementById('loginFormAdmin').reset();
    });

    // --- Sidebar & View Toggling ---
    $('#sidebarCollapse').on('click', function () {
        $('#sidebar').addClass('active');
        $('.overlay').addClass('active');
    });

    $('.overlay, #sidebarCloseBtn').on('click', function () {
        $('#sidebar').removeClass('active');
        $('.overlay').removeClass('active');
    });

    function showView(viewId) {
        $('#dashboard-view').hide();
        $('#student-management-view').hide();
        $('#staff-management-view').hide();
        $(`#${viewId}`).show();
    }

    function renderStaticClasses() {
        const classContainer = document.getElementById('class-list-container');
        const classes = ["Kelas 1", "Kelas 2", "Kelas 3", "Kelas 4", "Kelas 5", "Kelas 6"];
        classContainer.innerHTML = classes.map(cls => `
            <li><a href="#" class="class-link" data-class="${cls}">${cls}</a></li>
        `).join('');
    }

    document.getElementById('dashboard-link').addEventListener('click', (e) => {
        e.preventDefault();
        showDashboardView();
    });

    document.getElementById('class-list-container').addEventListener('click', (e) => {
        e.preventDefault();
        if (e.target.classList.contains('class-link')) {
            currentClass = e.target.dataset.class;
            $('#sidebar ul li').removeClass('active');
            $(e.target).closest('ul').closest('li').addClass('active');
            
            $('#content-title').text(`Data Siswa Kelas: ${currentClass}`);
            $('#content-subtitle').text(`Kelola data siswa untuk kelas ${currentClass}.`);
            showView('student-management-view');
            if (isBulkEditMode) toggleBulkEditMode(false);
            fetchAndDisplayStudents(currentClass);
        }
    });

    document.getElementById('manage-staff-link').addEventListener('click', (e) => {
        e.preventDefault();
        $('#sidebar ul li').removeClass('active');
        $(e.target).closest('li').addClass('active');
        $('#content-title').text('Manajemen Guru & Staf');
        $('#content-subtitle').text('Kelola semua data guru dan staf.');
        showView('staff-management-view');
        fetchAndDisplayStaff();
    });

    // --- Dashboard Logic ---
    function showDashboardView() {
        $('#sidebar ul li').removeClass('active');
        $('#dashboard-link').closest('li').addClass('active');
        $('#content-title').text('Dasbor Utama');
        $('#content-subtitle').text('Ringkasan statistik dan laporan sekolah.');
        showView('dashboard-view');
        fetchAndDisplayStats();
    }

    async function fetchAndDisplayStats() {
        const statsRef = db.collection('statistik_sekolah').doc('utama');
        try {
            const doc = await statsRef.get();
            let statsData;

            if (doc.exists) {
                statsData = doc.data();
            } else {
                Toastify({ text: "Membuat cache statistik untuk pertama kali...", style: { background: "blue" } }).showToast();
                const siswaSnapshot = await db.collection('siswa').get();
                statsData = { totalAktif: 0, totalLulus: 0, totalPindah: 0, perKelas: {} };
                
                siswaSnapshot.forEach(doc => {
                    const siswa = doc.data();
                    if (siswa.status === 'Aktif') {
                        statsData.totalAktif++;
                        statsData.perKelas[siswa.kelas] = (statsData.perKelas[siswa.kelas] || 0) + 1;
                    } else if (siswa.status === 'Lulus') {
                        statsData.totalLulus++;
                    } else if (siswa.status === 'Pindah') {
                        statsData.totalPindah++;
                    }
                });
                await statsRef.set(statsData);
            }

            $('#total-aktif').text(statsData.totalAktif || 0);
            $('#total-lulus').text(statsData.totalLulus || 0);
            $('#total-pindah').text(statsData.totalPindah || 0);

            renderClassChart(statsData.perKelas || {});

        } catch (error) {
            console.error("Error fetching stats:", error);
            Toastify({ text: `Gagal memuat statistik: ${error.message}`, style: { background: "red" } }).showToast();
        }
    }

    function renderClassChart(perKelasData) {
        const ctx = document.getElementById('classChart').getContext('2d');
        const labels = Object.keys(perKelasData).sort((a,b) => a - b);
        const data = labels.map(label => perKelasData[label]);

        if (classChart) {
            classChart.destroy();
        }

        classChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels.map(l => `Kelas ${l}`),
                datasets: [{
                    label: 'Jumlah Siswa',
                    data: data,
                    backgroundColor: 'rgba(0, 123, 255, 0.5)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 5 }
                    }
                }
            }
        });
    }

    // --- Student Data Management ---
    async function fetchAndDisplayStudents(className) {
        const container = document.getElementById('student-list-container');
        container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div></div>';

        try {
            const classNumber = className.replace('Kelas ', '');
            const snapshot = await db.collection('siswa').where('kelas', '==', classNumber).orderBy('nomorAbsen').get();
            allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderStudentTable(allStudents, isBulkEditMode);
        } catch (error) {
            container.innerHTML = `<div class="alert alert-danger">Gagal memuat data: ${error.message}</div>`;
        }
    }

    function renderStudentTable(students, editMode = false) {
        const container = document.getElementById('student-list-container');
        if (students.length === 0) {
            container.innerHTML = '<div class="alert alert-info text-center">Tidak ada data siswa di kelas ini.</div>';
            return;
        }
        let tableHtml = '<table class="table table-hover table-bordered table-sm"><thead><tr><th>No. Absen</th><th>Nama</th><th>NISN</th><th>Nama Ortu</th><th>No. WA</th><th>Tgl Lahir</th><th>Status</th><th>Aksi</th></tr></thead><tbody>';
        students.forEach(siswa => {
            const isIncomplete = !siswa.nomorAbsen || !siswa.tglLahir || !siswa.namaOrtu || !siswa.nomorWa;
            tableHtml += `<tr class="${isIncomplete && !editMode ? 'table-warning' : ''}" data-nisn="${siswa.nisn}">`;

            if(editMode) {
                tableHtml += `
                    <td><input type="number" class="form-control form-control-sm edit-nomorAbsen" value="${siswa.nomorAbsen || ''}"></td>
                    <td><input type="text" class="form-control form-control-sm edit-nama" value="${siswa.nama || ''}"></td>
                    <td>${siswa.nisn || '-'}</td>
                    <td><input type="text" class="form-control form-control-sm edit-namaOrtu" value="${siswa.namaOrtu || ''}"></td>
                    <td><input type="text" class="form-control form-control-sm edit-nomorWa" value="${siswa.nomorWa || ''}"></td>
                    <td><input type="text" class="form-control form-control-sm edit-tglLahir" value="${siswa.tglLahir || ''}"></td>
                    <td>
                        <select class="form-control form-control-sm edit-status">
                            <option value="Aktif" ${siswa.status === 'Aktif' ? 'selected' : ''}>Aktif</option>
                            <option value="Lulus" ${siswa.status === 'Lulus' ? 'selected' : ''}>Lulus</option>
                            <option value="Pindah" ${siswa.status === 'Pindah' ? 'selected' : ''}>Pindah</option>
                        </select>
                    </td>
                    <td>-</td>
                `;
            } else {
                tableHtml += `
                    <td>${siswa.nomorAbsen || '<span class="text-danger">Kosong</span>'}</td>
                    <td>${siswa.nama || '-'}</td>
                    <td>${siswa.nisn || '-'}</td>
                    <td>${siswa.namaOrtu || '-'}</td>
                    <td>${siswa.nomorWa || '-'}</td>
                    <td>${siswa.tglLahir || '<span class="text-danger">Kosong</span>'}</td>
                    <td><span class="badge badge-${siswa.status === 'Aktif' ? 'success' : 'secondary'}">${siswa.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-btn" data-nisn="${siswa.nisn}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-btn" data-nisn="${siswa.nisn}" data-nama="${siswa.nama}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
            }
            tableHtml += `</tr>`;
        });
        tableHtml += '</tbody></table>';
        container.innerHTML = tableHtml;
    }

    document.getElementById('searchInputSiswa').addEventListener('keyup', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredStudents = allStudents.filter(s => s.nama.toLowerCase().includes(searchTerm));
        renderStudentTable(filteredStudents, isBulkEditMode);
    });

    document.getElementById('add-student-btn').addEventListener('click', () => {
        $('#studentForm')[0].reset();
        $('#modalTitle').text('Tambah Siswa Baru');
        $('#saveStudentBtn').text('Simpan Siswa');
        $('#nisn').prop('disabled', false);
        $('#editNisn').val('');
        $('#kelas').val(currentClass.replace('Kelas ',''));
        $('#studentModal').modal('show');
    });

    document.getElementById('student-list-container').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        if (editBtn) {
            const nisn = editBtn.dataset.nisn;
            const studentData = allStudents.find(s => s.nisn.toString() === nisn.toString());
            if (studentData) {
                $('#studentForm')[0].reset();
                $('#modalTitle').text('Edit Data Siswa');
                $('#saveStudentBtn').text('Simpan Perubahan');
                $('#nisn').prop('disabled', true).val(studentData.nisn);
                $('#editNisn').val(studentData.nisn);
                $('#nama').val(studentData.nama || '');
                $('#kelas').val(studentData.kelas || '');
                $('#nomorAbsen').val(studentData.nomorAbsen || '');
                $('#tglLahir').val(studentData.tglLahir || '');
                $('#namaOrtu').val(studentData.namaOrtu || '');
                $('#nomorWa').val(studentData.nomorWa || '');
                $('#status').val(studentData.status || 'Aktif');
                $('#studentModal').modal('show');
            }
        }
        if (deleteBtn) {
            $('#studentNameToDelete').text(deleteBtn.dataset.nama);
            $('#nisnToDelete').val(deleteBtn.dataset.nisn);
            $('#deleteConfirmModal').modal('show');
        }
    });

    $('#saveStudentBtn').on('click', async () => {
        const nisn = $('#editNisn').val() || $('#nisn').val();
        if (!nisn) { Toastify({ text: "NISN wajib diisi.", style: { background: "red" } }).showToast(); return; }
        const btn = $('#saveStudentBtn');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        
        const newStatus = $('#status').val();
        const data = {
            nisn: nisn,
            nama: $('#nama').val(),
            kelas: $('#kelas').val(),
            nomorAbsen: (newStatus === 'Aktif') ? parseInt($('#nomorAbsen').val()) || null : null,
            tglLahir: $('#tglLahir').val() || null,
            namaOrtu: $('#namaOrtu').val() || null,
            nomorWa: $('#nomorWa').val() || null,
            status: newStatus
        };

        try {
            const originalStudent = allStudents.find(s => s.nisn.toString() === nisn.toString());
            await db.collection('siswa').doc(nisn).set(data, { merge: true });
            Toastify({ text: "Data siswa berhasil disimpan!", style: { background: "green" } }).showToast();
            $('#studentModal').modal('hide');

            if (originalStudent && originalStudent.status !== data.status) {
                await updateSchoolStatsOnStatusChange(originalStudent, data);
            }

            if (originalStudent && originalStudent.status === 'Aktif' && (data.status === 'Pindah' || data.status === 'Lulus')) {
                await resequenceClassAbsen(currentClass);
            }

            await fetchAndDisplayStudents(currentClass);
        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).text($('#modalTitle').text().includes('Tambah') ? 'Simpan Siswa' : 'Simpan Perubahan');
        }
    });
    
    $('#confirmDeleteBtn').on('click', async () => {
        const nisn = $('#nisnToDelete').val();
        const btn = $('#confirmDeleteBtn');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        try {
            const studentToDelete = allStudents.find(s => s.nisn.toString() === nisn.toString());
            await db.collection('siswa').doc(nisn).delete();
            Toastify({ text: "Data siswa berhasil dihapus.", style: { background: "green" } }).showToast();
            $('#deleteConfirmModal').modal('hide');

            if (studentToDelete) {
                await updateSchoolStatsOnDelete(studentToDelete);
            }

            await resequenceClassAbsen(currentClass);
            await fetchAndDisplayStudents(currentClass);
        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).text('Ya, Hapus');
        }
    });

    $('#bulk-add-btn').on('click', () => $('#bulkAddModal').modal('show'));
    $('#processBulkAddBtn').on('click', async () => {
        const btn = $('#processBulkAddBtn');
        const progressDiv = $('#bulk-progress');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Memproses...');
        progressDiv.show().html('<div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 10%"></div></div>');
        const data = $('#bulkData').val().trim();
        const lines = data.split('\n').filter(line => line.trim() !== '');
        if (lines.length === 0) {
            Toastify({ text: "Tidak ada data untuk diproses.", style: { background: "orange" } }).showToast();
            btn.prop('disabled', false).text('Proses & Simpan');
            progressDiv.hide(); return;
        }
        const batch = db.batch();
        let successCount = 0, errorCount = 0;
        lines.forEach((line, index) => {
            const [nisn, nama, kelas, noAbsen, tglLahir, namaOrtu, nomorWa] = line.split(',').map(item => item.trim());
            if (nisn && nama && kelas) {
                const docRef = db.collection('siswa').doc(nisn);
                batch.set(docRef, { nisn, nama, kelas, nomorAbsen: parseInt(noAbsen) || null, tglLahir: tglLahir || null, namaOrtu: namaOrtu || null, nomorWa: nomorWa || null, status: 'Aktif' }, { merge: true });
                successCount++;
            } else { errorCount++; }
            const progress = ((index + 1) / lines.length) * 100;
            progressDiv.find('.progress-bar').css('width', `${progress}%`);
        });
        try {
            await batch.commit();
            Toastify({ text: `${successCount} data berhasil disimpan. ${errorCount} data gagal (format salah).`, duration: 5000, style: { background: "green" } }).showToast();
            $('#bulkAddModal').modal('hide');
            $('#bulkData').val('');
            await updateSchoolStatsOnAdd(successCount);
            await fetchAndDisplayStudents(currentClass);
        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).text('Proses & Simpan');
            progressDiv.hide();
        }
    });
    
    $('#reorder-absent-btn').on('click', () => {
        const reorderList = $('#reorder-list');
        reorderList.html('');
        allStudents.sort((a,b) => (a.nomorAbsen || 999) - (b.nomorAbsen || 999)).forEach(s => {
            reorderList.append(`<li class="list-group-item d-flex justify-content-between align-items-center" data-nisn="${s.nisn}">
                <span>${s.nomorAbsen || 'N/A'}. ${s.nama}</span>
                <span><button class="btn btn-light btn-sm move-up-btn"><i class="fas fa-arrow-up"></i></button><button class="btn btn-light btn-sm move-down-btn"><i class="fas fa-arrow-down"></i></button></span>
            </li>`);
        });
        updateReorderButtonsState();
        $('#reorderModal').modal('show');
    });

    function updateReorderButtonsState() {
        const items = $('#reorder-list li');
        items.find('.move-up-btn, .move-down-btn').prop('disabled', false);
        items.first().find('.move-up-btn').prop('disabled', true);
        items.last().find('.move-down-btn').prop('disabled', true);
    }

    $('#reorder-list').on('click', '.move-up-btn', function() { $(this).closest('li').insertBefore($(this).closest('li').prev()); updateReorderButtonsState(); });
    $('#reorder-list').on('click', '.move-down-btn', function() { $(this).closest('li').insertAfter($(this).closest('li').next()); updateReorderButtonsState(); });

    $('#saveOrderBtn').on('click', async () => {
        const btn = $('#saveOrderBtn');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        const batch = db.batch();
        $('#reorder-list').find('li').each(function(index) {
            const nisn = $(this).data('nisn').toString(); 
            const docRef = db.collection('siswa').doc(nisn);
            batch.update(docRef, { nomorAbsen: index + 1 });
        });
        try {
            await batch.commit();
            Toastify({ text: "Urutan nomor absen berhasil disimpan!", style: { background: "green" } }).showToast();
            $('#reorderModal').modal('hide');
            await fetchAndDisplayStudents(currentClass);
        } catch (error) {
            console.error("Error saving order:", error);
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).text('Simpan Urutan');
        }
    });

    $('#bulk-edit-btn').on('click', () => {
        toggleBulkEditMode(true);
    });
    $('#cancel-bulk-edit-btn').on('click', () => {
        toggleBulkEditMode(false);
    });
    $('#save-bulk-changes-btn').on('click', async () => {
        const btn = $('#save-bulk-changes-btn');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Menyimpan...');
        
        const batch = db.batch();
        let changesCount = 0;
        let needsResequence = false;

        $('#student-list-container tbody tr').each(function() {
            const row = $(this);
            const nisn = row.data('nisn').toString();
            const originalStudent = allStudents.find(s => s.nisn.toString() === nisn);

            const updatedData = {
                nomorAbsen: parseInt(row.find('.edit-nomorAbsen').val()) || null,
                nama: row.find('.edit-nama').val(),
                namaOrtu: row.find('.edit-namaOrtu').val() || null,
                nomorWa: row.find('.edit-nomorWa').val() || null,
                tglLahir: row.find('.edit-tglLahir').val() || null,
                status: row.find('.edit-status').val()
            };

            const hasChanged = (originalStudent.nomorAbsen || null) !== updatedData.nomorAbsen ||
                           (originalStudent.nama || '') !== updatedData.nama ||
                           (originalStudent.namaOrtu || null) !== updatedData.namaOrtu ||
                           (originalStudent.nomorWa || null) !== updatedData.nomorWa ||
                           (originalStudent.tglLahir || null) !== updatedData.tglLahir ||
                           (originalStudent.status || 'Aktif') !== updatedData.status;

            if (hasChanged) {
                if (originalStudent.status === 'Aktif' && (updatedData.status === 'Pindah' || updatedData.status === 'Lulus')) {
                    needsResequence = true;
                    updatedData.nomorAbsen = null;
                }
                const docRef = db.collection('siswa').doc(nisn);
                batch.update(docRef, updatedData);
                changesCount++;
            }
        });

        if (changesCount === 0) {
            Toastify({ text: "Tidak ada perubahan untuk disimpan.", style: { background: "orange" } }).showToast();
            btn.prop('disabled', false).html('<i class="fas fa-save"></i> Simpan Perubahan');
            toggleBulkEditMode(false);
            return;
        }

        try {
            await batch.commit();
            Toastify({ text: `${changesCount} data siswa berhasil diperbarui!`, style: { background: "green" } }).showToast();
            if (needsResequence) {
                await resequenceClassAbsen(currentClass);
            }
            await fetchAndDisplayStats();
        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).html('<i class="fas fa-save"></i> Simpan Perubahan');
            toggleBulkEditMode(false);
            await fetchAndDisplayStudents(currentClass);
        }
    });

    function toggleBulkEditMode(enable) {
        isBulkEditMode = enable;
        $('#default-actions').toggle(!enable);
        $('#edit-mode-actions').toggle(enable);
        renderStudentTable(allStudents, isBulkEditMode);
    }

    $('#promote-class-btn').on('click', () => {
        $('#naikKelasConfirmModal').modal('show');
    });

    $('#confirmNaikKelasBtn').on('click', async () => {
        const btn = $('#confirmNaikKelasBtn');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Memproses...');

        try {
            const snapshot = await db.collection('siswa').where('status', '==', 'Aktif').get();
            if (snapshot.empty) {
                throw new Error("Tidak ada siswa aktif untuk diproses.");
            }

            const batch = db.batch();
            let promotedCount = 0;
            let graduatedCount = 0;

            snapshot.forEach(doc => {
                const siswa = doc.data();
                const currentKelas = parseInt(siswa.kelas);
                const docRef = db.collection('siswa').doc(doc.id);

                if (currentKelas >= 1 && currentKelas <= 5) {
                    batch.update(docRef, { kelas: (currentKelas + 1).toString() });
                    promotedCount++;
                } else if (currentKelas === 6) {
                    batch.update(docRef, { status: 'Lulus' });
                    graduatedCount++;
                }
            });

            await batch.commit();
            Toastify({ text: `${promotedCount} siswa berhasil dinaikkan kelas & ${graduatedCount} siswa diluluskan.`, duration: 5000, style: { background: "green" } }).showToast();
            
            await fetchAndDisplayStats(); // Recalculate stats
            if (currentClass) {
                await fetchAndDisplayStudents(currentClass);
            }

        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).text('Ya, Proses Kenaikan Kelas');
            $('#naikKelasConfirmModal').modal('hide');
        }
    });

    async function resequenceClassAbsen(className) {
        const classNumber = className.replace('Kelas ', '');
        console.log(`Mengurutkan ulang nomor absen untuk kelas ${classNumber}...`);
        const batch = db.batch();
        try {
            const snapshot = await db.collection('siswa').where('kelas', '==', classNumber).where('status', '==', 'Aktif').orderBy('nomorAbsen').get();
            let reorderCount = 0;
            snapshot.docs.forEach((doc, index) => {
                const newAbsenNumber = index + 1;
                const currentAbsenNumber = doc.data().nomorAbsen;
                if (newAbsenNumber !== currentAbsenNumber) {
                    const docRef = db.collection('siswa').doc(doc.id);
                    batch.update(docRef, { nomorAbsen: newAbsenNumber });
                    reorderCount++;
                }
            });
            if (reorderCount > 0) {
                await batch.commit();
                Toastify({ text: `Nomor absen untuk kelas ${classNumber} berhasil diurutkan ulang.`, duration: 3000, style: { background: "blue" } }).showToast();
            }
        } catch (error) {
            console.error("Error resequencing class:", error);
        }
    }

    // --- Staff Management Logic ---
    async function fetchAndDisplayStaff() {
        const container = document.getElementById('staff-list-container');
        container.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div><p class="mt-2">Memuat data staf...</p></div>';
        try {
            const snapshot = await db.collection('staff').orderBy('namaLengkap').get();
            allStaff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderStaffTable(allStaff);
        } catch (error) {
            container.innerHTML = `<div class="alert alert-danger">Gagal memuat data: ${error.message}</div>`;
        }
    }

    function renderStaffTable(staffList) {
        const container = document.getElementById('staff-list-container');
        if (staffList.length === 0) {
            container.innerHTML = '<div class="alert alert-info">Tidak ada data staf ditemukan.</div>';
            return;
        }
        let tableHtml = '<table class="table table-hover table-bordered table-sm"><thead><tr><th>Nama Lengkap</th><th>Username</th><th>Peran</th><th>Kelas Diampu</th><th>Aksi</th></tr></thead><tbody>';
        staffList.forEach(staf => {
            tableHtml += `
                <tr>
                    <td>${staf.namaLengkap || '-'}</td>
                    <td>${staf.username || '-'}</td>
                    <td><span class="badge badge-info">${staf.role || '-'}</span></td>
                    <td>${staf.kelasDiampu || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-staff-btn" data-id="${staf.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-staff-btn" data-id="${staf.id}" data-nama="${staf.namaLengkap}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });
        tableHtml += '</tbody></table>';
        container.innerHTML = tableHtml;
    }

    document.getElementById('searchInputStaff').addEventListener('keyup', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredStaff = allStaff.filter(staf => 
            staf.namaLengkap.toLowerCase().includes(searchTerm) ||
            staf.username.toLowerCase().includes(searchTerm)
        );
        renderStaffTable(filteredStaff);
    });

    document.getElementById('add-staff-btn').addEventListener('click', () => {
        $('#staffForm')[0].reset();
        $('#staffModalTitle').text('Tambah Staf Baru');
        $('#saveStaffBtn').text('Simpan Staf');
        $('#editDocId').val('');
        $('#staffModal').modal('show');
    });

    document.getElementById('staff-list-container').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-staff-btn');
        const deleteBtn = e.target.closest('.delete-staff-btn');
        if (editBtn) {
            const docId = editBtn.dataset.id;
            const staffData = allStaff.find(s => s.id === docId);
            if (staffData) {
                $('#staffForm')[0].reset();
                $('#staffModalTitle').text('Edit Data Staf');
                $('#saveStaffBtn').text('Simpan Perubahan');
                $('#editDocId').val(staffData.id);
                $('#namaLengkap').val(staffData.namaLengkap || '');
                $('#staffUsername').val(staffData.username || '');
                $('#staffPassword').val(staffData.password || '');
                $('#role').val(staffData.role || 'mapel');
                $('#kelasDiampu').val(staffData.kelasDiampu || '');
                $('#staffModal').modal('show');
            }
        }
        if (deleteBtn) {
            $('#staffNameToDelete').text(deleteBtn.dataset.nama);
            $('#docIdToDelete').val(deleteBtn.dataset.id);
            $('#deleteStaffConfirmModal').modal('show');
        }
    });

    $('#saveStaffBtn').on('click', async () => {
        const docId = $('#editDocId').val();
        const btn = $('#saveStaffBtn');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        const data = {
            namaLengkap: $('#namaLengkap').val(),
            username: $('#staffUsername').val(),
            password: $('#staffPassword').val(),
            role: $('#role').val(),
            kelasDiampu: $('#kelasDiampu').val() || null
        };
        try {
            if (docId) {
                await db.collection('staff').doc(docId).update(data);
            } else {
                await db.collection('staff').add(data);
            }
            Toastify({ text: "Data staf berhasil disimpan!", style: { background: "green" } }).showToast();
            $('#staffModal').modal('hide');
            await fetchAndDisplayStaff();
        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).text(docId ? 'Simpan Perubahan' : 'Simpan Staf');
        }
    });
    
    $('#confirmDeleteStaffBtn').on('click', async () => {
        const docId = $('#docIdToDelete').val();
        const btn = $('#confirmDeleteStaffBtn');
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        try {
            await db.collection('staff').doc(docId).delete();
            Toastify({ text: "Data staf berhasil dihapus.", style: { background: "green" } }).showToast();
            $('#deleteStaffConfirmModal').modal('hide');
            await fetchAndDisplayStaff();
        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).text('Ya, Hapus');
        }
    });

    // --- Stats Update Utility Functions ---
    async function updateSchoolStatsOnAdd(count) {
        const statsRef = db.collection('statistik_sekolah').doc('utama');
        await statsRef.update({
            totalAktif: firebase.firestore.FieldValue.increment(count)
        });
    }

    async function updateSchoolStatsOnDelete(student) {
        const statsRef = db.collection('statistik_sekolah').doc('utama');
        const updateData = {};
        if(student.status === 'Aktif') updateData.totalAktif = firebase.firestore.FieldValue.increment(-1);
        if(student.status === 'Lulus') updateData.totalLulus = firebase.firestore.FieldValue.increment(-1);
        if(student.status === 'Pindah') updateData.totalPindah = firebase.firestore.FieldValue.increment(-1);
        await statsRef.update(updateData);
    }

    async function updateSchoolStatsOnStatusChange(oldStudent, newStudent) {
        const statsRef = db.collection('statistik_sekolah').doc('utama');
        const updateData = {};
        
        const statusMap = {
            'Aktif': 'totalAktif',
            'Lulus': 'totalLulus',
            'Pindah': 'totalPindah'
        };

        const oldStatusField = statusMap[oldStudent.status];
        const newStatusField = statusMap[newStudent.status];

        if(oldStatusField) updateData[oldStatusField] = firebase.firestore.FieldValue.increment(-1);
        if(newStatusField) updateData[newStatusField] = firebase.firestore.FieldValue.increment(1);
        
        await statsRef.update(updateData);
    }

    // --- Export CSV Logic ---
    document.getElementById('export-csv-btn').addEventListener('click', async () => {
        Toastify({ text: "Mempersiapkan data untuk diunduh...", style: { background: "blue" } }).showToast();
        try {
            const snapshot = await db.collection('siswa').orderBy('kelas').orderBy('nomorAbsen').get();
            if(snapshot.empty) {
                Toastify({ text: "Tidak ada data siswa untuk diekspor.", style: { background: "orange" } }).showToast();
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["NISN", "Nama", "Kelas", "No. Absen", "Tgl Lahir", "Nama Ortu", "No. WA", "Status"];
            csvContent += headers.join(",") + "\r\n";

            snapshot.forEach(doc => {
                const siswa = doc.data();
                const row = [
                    siswa.nisn || '',
                    `"${siswa.nama || ''}"`, // Enclose in quotes to handle commas in names
                    siswa.kelas || '',
                    siswa.nomorAbsen || '',
                    siswa.tglLahir || '',
                    `"${siswa.namaOrtu || ''}"`,
                    siswa.nomorWa || '',
                    siswa.status || ''
                ];
                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "data-siswa-sekolah.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            Toastify({ text: "Ekspor berhasil!", style: { background: "green" } }).showToast();

        } catch (error) {
            console.error("Error exporting to CSV:", error);
            Toastify({ text: `Gagal mengekspor data: ${error.message}`, style: { background: "red" } }).showToast();
        }
    });

</script>
</body>
</html>
