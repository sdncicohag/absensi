<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Siswa & Orang Tua - SD Negeri Cicohag</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body class="portal-body">
    <div class="container d-flex justify-content-center align-items-center min-vh-100">
        <div id="login-container" class="card shadow-lg border-0 rounded-xl p-4 p-md-5 mx-auto" style="max-width: 500px; width: 100%;"> 
            <div class="card-body">
                <div class="back-link-container text-center mb-4">
                    <a href="index.html" class="text-muted text-decoration-none d-inline-flex align-items-center">
                        <i class="fas fa-arrow-left mr-2"></i> Kembali ke Halaman Utama
                    </a>
                </div>
                <h3 class="card-title-centered text-primary font-weight-bolder mb-4">
                    <i class="fas fa-user-graduate mr-2"></i> Portal Siswa & Orang Tua
                </h3>
                <p class="text-center text-muted mb-4">Silakan login untuk melihat rekap kehadiran.</p>
                <form id="loginFormSiswa">
                    <div class="form-group mb-3">
                        <label for="nisn" class="font-weight-bold text-dark">Nomor Induk Siswa Nasional (NISN):</label>
                        <input type="text" id="nisn" name="nisn" class="form-control form-control-lg rounded-pill px-4" placeholder="Masukkan NISN Anda" required>
                    </div>
                    <div class="form-group mb-4">
                        <label for="tglLahir" class="font-weight-bold text-dark">Tanggal Lahir (Format: DDMMYYYY):</label>
                        <input type="text" id="tglLahir" name="tglLahir" class="form-control form-control-lg rounded-pill px-4" placeholder="Contoh: 05082010" required>
                    </div>
                    <button type="submit" id="loginButton" class="btn btn-primary btn-lg btn-block rounded-pill shadow-md font-weight-bold mt-4">
                        Login <i class="fas fa-sign-in-alt ml-2"></i>
                    </button> 
                    <div id="login-error" class="alert alert-danger mt-3 text-center" style="display:none;"></div>
                </form>
            </div>
        </div>

        <div id="rekap-container" class="card shadow-lg border-0 rounded-xl p-4 p-md-5 mx-auto" style="display:none; max-width: 800px; width: 100%;"> 
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 id="welcome-message-siswa" class="text-primary font-weight-bolder"></h4>
                    <button id="logoutButtonSiswa" class="btn btn-sm btn-outline-danger rounded-pill"><i class="fas fa-sign-out-alt mr-2"></i> Logout</button>
                </div>
                
                <!-- Navigasi Tab Utama -->
                <ul class="nav nav-tabs nav-fill mb-4" id="mainTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="rekap-tab" data-toggle="tab" href="#rekapContent" role="tab" aria-controls="rekapContent" aria-selected="true">Rekap Kehadiran</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="jadwal-tab" data-toggle="tab" href="#jadwalContent" role="tab" aria-controls="jadwalContent" aria-selected="false">Info & Jadwal Kelas</a>
                    </li>
                </ul>

                <!-- Konten Tab -->
                <div class="tab-content" id="mainTabContent">
                    <!-- Tab Rekap Kehadiran -->
                    <div class="tab-pane fade show active" id="rekapContent" role="tabpanel" aria-labelledby="rekap-tab">
                        <h5 class="card-title text-center text-dark font-weight-bold mb-3">Pilih Semester</h5>
                        <div class="d-flex justify-content-center mb-4">
                            <div class="btn-group" role="group">
                                <button class="btn btn-primary rounded-pill px-4 py-2 mx-2 font-weight-bold" onclick="fetchRekapSiswa(1)">Semester 1 (Juli - Des)</button>
                                <button class="btn btn-outline-primary rounded-pill px-4 py-2 mx-2 font-weight-bold" onclick="fetchRekapSiswa(2)">Semester 2 (Jan - Juni)</button>
                            </div>
                        </div>
                        <div id="content-container" class="mt-3"></div>
                    </div>
                    <!-- Tab Info & Jadwal -->
                    <div class="tab-pane fade" id="jadwalContent" role="tabpanel" aria-labelledby="jadwal-tab">
                        <div id="jadwal-container" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
    // --- GANTI DENGAN KONFIGURASI FIREBASE ANDA ---
    const firebaseConfig = {
        apiKey: "AIzaSyD4nAPhGV-USPyElTyHwiDZO0ZvUGRoK5E",
        authDomain: "sistem-absensi-sdn-cicohag.firebaseapp.com",
        projectId: "sistem-absensi-sdn-cicohag",
        storageBucket: "sistem-absensi-sdn-cicohag.appspot.com",
        messagingSenderId: "540116242535",
        appId: "1:540116242535:web:41e3e1e7456ecf1c6584c2"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentSiswa = null;
    const loginContainer = document.getElementById('login-container');
    const rekapContainer = document.getElementById('rekap-container');
    const welcomeMessage = document.getElementById('welcome-message-siswa');
    const contentContainer = document.getElementById('content-container');

    document.getElementById('loginFormSiswa').addEventListener('submit', async function(e) {
        e.preventDefault();
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('login-error');
        loginButton.disabled = true;
        loginButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengecek...';
        loginError.style.display = 'none';

        const nisn = document.getElementById('nisn').value;
        const tglLahir = document.getElementById('tglLahir').value;

        try {
            const snapshot = await db.collection('siswa').where('nisn', '==', nisn).where('tglLahir', '==', tglLahir).where('status', '==', 'Aktif').get();
            if (snapshot.empty) throw new Error("NISN atau Tanggal Lahir salah, atau siswa tidak aktif.");
            
            const siswaData = snapshot.docs[0].data();
            currentSiswa = { nisn: nisn, tglLahir: tglLahir, nama: siswaData.nama, kelas: siswaData.kelas };
            
            loginContainer.style.display = 'none';
            rekapContainer.style.display = 'block';
            
            welcomeMessage.innerHTML = `Selamat Datang, <strong>${currentSiswa.nama}</strong>!`;

            Toastify({ text: `Selamat datang kembali, ${currentSiswa.nama}!`, duration: 3000, gravity: "top", position: "center", style: { background: "#4CAF50" } }).showToast();

            await fetchRekapSiswa(1); 

        } catch (error) {
            loginError.textContent = error.message;
            loginError.style.display = 'block';
        } finally {
            loginButton.disabled = false;
            loginButton.innerHTML = 'Login';
        }
    });
    
    document.getElementById('logoutButtonSiswa').addEventListener('click', () => {
        currentSiswa = null;
        rekapContainer.style.display = 'none';
        loginContainer.style.display = 'block';
        contentContainer.innerHTML = '';
        document.getElementById('jadwal-container').innerHTML = '';
        document.getElementById('loginFormSiswa').reset();
    });

    // --- Event listener untuk tab Jadwal ---
    document.getElementById('jadwal-tab').addEventListener('click', fetchInfoJadwal);

    async function fetchRekapSiswa(semester) {
        contentContainer.innerHTML = '<div class="text-center mt-4"><div class="spinner-border text-primary"></div><p class="text-muted">Memuat rekap semester...</p></div>';
        
        document.querySelectorAll('.btn-group button').forEach((btn, index) => {
            btn.classList.toggle('btn-primary', index + 1 === semester);
            btn.classList.toggle('btn-outline-primary', index + 1 !== semester);
        });

        const currentYear = new Date().getFullYear();
        const cacheDocId = `${currentSiswa.nisn}_${currentYear}_${semester}`;
        const cacheRef = db.collection('cache_rekap_semester').doc(cacheDocId);

        try {
            const docSnap = await cacheRef.get();
            let rekapData;

            if (docSnap.exists) {
                const dataFromCache = docSnap.data();
                rekapData = {
                    nama: dataFromCache.nama,
                    kelas: dataFromCache.kelas,
                    total: {
                        sakit: dataFromCache.totalSakit || 0,
                        izin: dataFromCache.totalIzin || 0,
                        alpha: dataFromCache.totalAlpha || 0
                    },
                    detail: dataFromCache.detailAbsensi || []
                };
            } else {
                rekapData = {
                    nama: currentSiswa.nama,
                    kelas: currentSiswa.kelas,
                    total: { sakit: 0, izin: 0, alpha: 0 },
                    detail: []
                };
            }
            renderRekapSiswa(rekapData, semester);
        } catch (error) {
            contentContainer.innerHTML = `<div class="alert alert-danger mt-4"><i class="fas fa-exclamation-circle mr-2"></i> Gagal memuat rekap semester. ${error.message}</div>`;
            console.error("Error fetching rekap siswa:", error);
        }
    }

    async function fetchInfoJadwal() {
        const jadwalContainer = document.getElementById('jadwal-container');
        if (jadwalContainer.innerHTML.trim() !== '') return; // Jangan fetch ulang jika sudah ada isinya

        jadwalContainer.innerHTML = '<div class="text-center mt-4"><div class="spinner-border text-primary"></div><p class="text-muted">Memuat info & jadwal...</p></div>';

        try {
            const docRef = db.collection('info_kelas').doc(currentSiswa.kelas);
            const docSnap = await docRef.get();
            const data = docSnap.exists ? docSnap.data() : {};
            renderInfoJadwal(data);
        } catch (error) {
            jadwalContainer.innerHTML = `<div class="alert alert-danger">Gagal memuat jadwal: ${error.message}</div>`;
        }
    }

    function renderInfoJadwal(data) {
        const jadwalContainer = document.getElementById('jadwal-container');
        const parseData = (textData) => {
            if (!textData) return '<li>Belum ada data.</li>';
            return textData.split('\n').map(item => `<li class="list-group-item">${item}</li>`).join('');
        };

        jadwalContainer.innerHTML = `
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card h-100"><div class="card-body">
                        <h6 class="card-title font-weight-bold"><i class="fas fa-book-open mr-2"></i>Jadwal Pelajaran</h6>
                        <ul class="list-group list-group-flush">${parseData(data.pelajaran)}</ul>
                    </div></div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100"><div class="card-body">
                        <h6 class="card-title font-weight-bold"><i class="fas fa-broom mr-2"></i>Jadwal Piket</h6>
                        <ul class="list-group list-group-flush">${parseData(data.piket)}</ul>
                    </div></div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card h-100"><div class="card-body">
                        <h6 class="card-title font-weight-bold"><i class="fas fa-tshirt mr-2"></i>Jadwal Seragam</h6>
                        <ul class="list-group list-group-flush">${parseData(data.seragam)}</ul>
                    </div></div>
                </div>
            </div>`;
    }

    function getBadgeClass(status) {
        switch (status) {
            case 'Hadir': case 'Masuk': return 'badge-success'; 
            case 'Pulang': return 'badge-primary'; 
            case 'Sakit': return 'badge-warning'; 
            case 'Izin': return 'badge-info'; 
            case 'Tanpa Keterangan': case 'Alfa': return 'badge-danger'; 
            default: return 'badge-secondary'; 
        }
    }

    function renderRekapSiswa(data, semester) {
        data.detail.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

        let html = `
            <div class="card mt-4 shadow-sm rounded-lg">
                <div class="card-body">
                    <h5 class="card-title text-primary font-weight-bold"><i class="fas fa-chart-bar mr-2"></i> Rekap Kehadiran Semester ${semester}</h5>
                    <p class="text-muted small mb-3">Untuk Ananda ${data.nama} (Kelas ${data.kelas})</p>
                    <div class="summary-metrics d-flex justify-content-around flex-wrap mb-4">
                        <div class="metric-item sick">
                            <span class="metric-value">${data.total.sakit}</span>
                            <span class="metric-label">Hari Sakit</span>
                        </div>
                        <div class="metric-item permission">
                            <span class="metric-value">${data.total.izin}</span>
                            <span class="metric-label">Hari Izin</span>
                        </div>
                        <div class="metric-item absent">
                            <span class="metric-value">${data.total.alpha}</span>
                            <span class="metric-label">Hari Alfa</span>
                        </div>
                    </div>
                    <hr>
                    <h6 class="mt-4 text-dark font-weight-bold"><i class="fas fa-list-alt mr-2"></i> Rincian Ketidakhadiran</h6>`;

        if (data.detail && data.detail.length > 0) {
            html += `<div class="table-responsive"><table class="table table-sm table-striped table-hover mt-3"><thead><tr><th>Tanggal</th><th>Status</th></tr></thead><tbody>`;
            data.detail.forEach(d => {
                const badgeClass = getBadgeClass(d.status);
                const formattedDate = new Date(d.tanggal).toLocaleDateString('id-ID', {
                    day: '2-digit', month: 'long', year: 'numeric'
                });
                html += `<tr><td>${formattedDate}</td><td><span class="badge ${badgeClass} p-2">${d.status}</span></td></tr>`;
            });
            html += `</tbody></table></div>`;
        } else {
            html += `<div class="alert alert-success mt-3 text-center"><i class="fas fa-check-circle mr-2"></i> Tidak ada catatan ketidakhadiran pada semester ini.</div>`;
        }

        html += '</div></div>';
        contentContainer.innerHTML = html;
    }
</script>
</body>
</html>
