<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Guru & Staf</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body class="portal-body">
 
<div class="container mt-4 mb-4" id="login-container">
    <div class="card shadow-lg border-0 rounded-xl p-4 p-md-5 mx-auto" style="max-width: 450px; width: 100%;">
        <div class="card-body">
            <div class="text-center mb-4">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Lambang_Kab_Sukabumi.svg/1200px-Lambang_Kab_Sukabumi.svg.png" alt="Logo Sekolah" class="login-logo mb-2">
                <h4 class="card-title text-primary font-weight-bolder">
                    Login Guru & Staf
                </h4>
                <p class="text-muted">SD Negeri Cicohag</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group mb-3">
                    <label for="username" class="font-weight-bold text-dark small">Username</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-user-shield"></i></span>
                        </div>
                        <input type="text" id="username" name="username" class="form-control form-control-lg" placeholder="Masukkan Username" required>
                    </div>
                </div>
                
                <div class="form-group mb-4">
                    <label for="password" class="font-weight-bold text-dark small">Password</label>
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-lock"></i></span>
                        </div>
                        <input type="password" id="password" name="password" class="form-control form-control-lg" placeholder="Masukkan Password" required>
                        <div class="input-group-append">
                            <span class="input-group-text" id="togglePassword" style="cursor: pointer;">
                                <i class="fas fa-eye" id="toggleIcon"></i>
                            </span>
                        </div>
                    </div>
                </div>
                
                <button type="submit" id="loginButton" class="btn btn-primary btn-lg btn-block font-weight-bold mt-4">
                    Login <i class="fas fa-sign-in-alt ml-2"></i>
                </button>
                <div id="login-error" class="alert alert-danger mt-3 text-center" style="display:none;"></div>
            </form>
            <div class="text-center mt-4">
                <a href="index.html" class="text-muted small">
                    <i class="fas fa-arrow-left mr-1"></i> Kembali ke Halaman Utama
                </a>
            </div>
        </div>
    </div>
</div>
    

<div id="main-container" class="wrapper" style="display:none;">
    <nav id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-school"></i> Absensi App</h3>
        </div>

        <ul class="list-unstyled components">
            <li class="active">
                <a href="#dashboardSubmenu" data-toggle="collapse" aria-expanded="true" class="dropdown-toggle">
                    <i class="fas fa-home"></i> Dasbor
                </a>
                <ul class="collapse list-unstyled show" id="dashboardSubmenu">
                    <li><a href="#" id="sidebar-quick-summary"><i class="fas fa-chart-line"></i> Ringkasan</a></li>
                </ul>
            </li>
            <li>
                <a href="#attendanceSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                    <i class="fas fa-user-check"></i> Absensi
                </a>
                <ul class="collapse list-unstyled" id="attendanceSubmenu">
                    <li><a href="#" id="sidebar-scan-absensi"><i class="fas fa-qrcode"></i> Scan Absensi</a></li>
                    <li id="sidebar-unscanned-link"><a href="#" id="sidebar-unscanned-btn"><i class="fas fa-user-clock"></i> Siswa Tidak Hadir</a></li>
                    <li id="sidebar-daily-correction-link"><a href="#" id="sidebar-daily-correction-btn"><i class="fas fa-sync-alt"></i> Koreksi Absensi</a></li>
                    <li id="sidebar-manual-link"><a href="#" id="sidebar-manual-input-btn"><i class="fas fa-edit"></i> Absensi Manual</a></li>
                </ul>
            </li>
            <li id="menu-walikelas-only" style="display:none;">
                <a href="#walikelasSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                    <i class="fas fa-user-tie"></i> Fitur Wali Kelas
                </a>
                <ul class="collapse list-unstyled" id="walikelasSubmenu">
                    <li><a href="#" id="sidebar-daftar-siswa"><i class="fas fa-address-book"></i> Daftar Siswa</a></li>
                    <li><a href="#" id="sidebar-cek-usia"><i class="fas fa-birthday-cake"></i> Cek Usia Siswa</a></li>
                    <li><a href="#" id="sidebar-info-jadwal"><i class="fas fa-calendar-alt"></i> Info & Jadwal Kelas</a></li>
                    <li><a href="#" id="sidebar-nilai-semester"><i class="fas fa-keyboard"></i> Input Nilai Rapor</a></li>
                    <li><a href="#" id="sidebar-tabungan-kelas"><i class="fas fa-piggy-bank"></i> Tabungan Kelas</a></li>
                </ul>
            </li>
            <li>
                <a href="#rekapitulasiSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">
                    <i class="fas fa-user-check"></i> Rekapitulasi
                </a>
                <ul class="collapse list-unstyled" id="rekapitulasiSubmenu">
                    <li><a href="#" id="sidebar-rekap-harian"><i class="fas fa-calendar-day"></i> Rekap Harian</a></li>
                    <li><a href="#" id="sidebar-rekap-semester"><i class="fas fa-chart-bar"></i> Rekap Per Semester</a></li>
                    <li id="sidebar-catatan-harian-link"><a href="#" id="sidebar-catatan-harian"><i class="fas fa-book"></i> Catatan Absen Harian</a></li>
                    <li id="menu-rekap-tabungan" style="display:none;"><a href="#" id="sidebar-rekap-tabungan"><i class="fas fa-chart-pie"></i> Rekap Tabungan</a></li>
                    <li><a href="#" id="sidebar-keuangan"><i class="fas fa-wallet"></i> Keuangan Sekolah</a></li>
                    
                </ul>
            </li>
        </ul>
    </nav>

    <div id="content">
        <button type="button" id="sidebarCollapse" class="btn btn-info toggle-button-fixed d-block d-md-none">
            <i class="fas fa-align-left"></i>
        </button>
        <nav class="navbar navbar-expand navbar-light bg-light custom-navbar-top">
            <div class="container-fluid">
                <button type="button" id="sidebarCollapseDesktop" class="btn btn-info d-none d-md-block">
                    <i class="fas fa-align-left"></i>
                    <span class="d-none d-md-inline-block">Toggle Sidebar</span>
                </button>
                
                <div class="mx-2 text-truncate" style="min-width: 0;">
                    <span id="welcome-message" class="navbar-text">Selamat Datang, <strong>Guru</strong>!</span>
                </div>

                <button id="logoutButtonGuru" class="btn btn-light ml-auto" title="Logout">
                    <i class="fas fa-sign-out-alt text-danger fa-lg"></i>
                </button>
            </div>
        </nav>
        <div class="container-fluid portal-content-area">
                <div id="dashboard-content-area">
                    <div id="daily-summary-display"></div> 
                </div>
                <div id="main-content-area"></div>   
        </div>
    </div>
    <div id="sidebar-overlay"></div> 
</div>

<div class="modal fade" id="scan-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scanner Absensi</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="stopScanner()">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body"><div id="reader"></div></div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0"><h5 class="modal-title w-100 text-center font-weight-bold">Konfirmasi Absensi</h5></div>
            <div class="modal-body text-center">
                <h4 id="studentName">Nama Siswa</h4>
                <p class="text-muted" id="studentClass">Kelas</p>
                <div id="statusAlert" class="alert mt-3" role="alert">Status: <strong id="attendanceStatus"></strong></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="confirmButton">✅ Lanjutkan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="dailyCorrectionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title w-100 text-center font-weight-bold">Koreksi Status Siswa</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <p>Mengoreksi status untuk:</p>
                <h4 id="dailyCorrectionStudentName" class="font-weight-bold"></h4>
                <p class="text-muted" id="dailyCorrectionStudentClass"></p>
                <hr>
                <div class="form-group">
                    <label for="dailyCorrectionStatusSelect">Status Saat Ini: <strong id="dailyCorrectionCurrentStatusDisplay"></strong></label>
                    <label for="dailyCorrectionStatusSelect">Ubah Status Menjadi:</label>
                    <select id="dailyCorrectionStatusSelect" class="form-control">
                        <option value="Sakit">Sakit</option>
                        <option value="Izin">Izin</option>
                        <option value="Tanpa Keterangan">Tanpa Keterangan</option>
                    </select>
                </div>
                <input type="hidden" id="dailyCorrectionNisn">
                <input type="hidden" id="dailyCorrectionOriginalStatus">
                <input type="hidden" id="dailyCorrectionLogId">
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" id="saveDailyCorrectionBtn">Simpan Koreksi</button>
            </div>
        </div>
    </div>
</div>

    <div class="modal fade" id="editSiswaInfoModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Edit Info Siswa</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body"><form id="editSiswaInfoForm">
            <input type="hidden" id="editSiswaNisn">
            <div class="row">
                <div class="col-md-6 form-group"><label>Nama Siswa</label><input type="text" id="editSiswaNama" class="form-control" required></div>
                <div class="col-md-6 form-group"><label>Nomor Absen</label><input type="number" id="editSiswaNomorAbsen" class="form-control"></div>
                <div class="col-md-6 form-group"><label>Nama Orang Tua</label><input type="text" id="editSiswaNamaOrtu" class="form-control"></div>
                <div class="col-md-6 form-group"><label>Nomor WhatsApp</label><input type="text" id="editSiswaNomorWa" class="form-control"></div>
                <div class="col-md-6 form-group"><label>Tanggal Lahir</label><input type="text" id="editSiswatglLahir" class="form-control"></div>
            </div>
        </form></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" id="saveSiswaInfoBtn" class="btn btn-primary">Simpan</button></div>
    </div></div></div>
    <div class="modal fade" id="editJadwalModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable"> <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Info & Jadwal Kelas</h5>
                        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                    </div>
                    <div class="modal-body">
                        <p class="text-muted small">Ketuk pada nama hari untuk membuka atau menutup form isian.</p>
                        <div class="accordion" id="jadwalAccordion">
                            </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                        <button type="button" id="saveJadwalBtn" class="btn btn-primary">Simpan Jadwal</button>
                    </div>
                </div>
            </div>
        </div>
    <div class="modal fade" id="reorderModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Urutkan Nomor Absen</h5><button type="button" class="close" data-dismiss="modal"><span>&times;</span></button></div>
        <div class="modal-body">
            <p class="text-muted">Gunakan tombol panah untuk mengubah urutan.</p>
            <ul class="list-group" id="reorder-list"></ul>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button><button type="button" id="saveOrderBtn" class="btn btn-primary">Simpan Urutan</button></div>
    </div></div></div>
    <div class="modal fade" id="konfigurasiMapelModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Atur Mata Pelajaran Aktif</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">Non-aktifkan mata pelajaran yang tidak diajarkan di kelas ini pada semester yang dipilih. Pengaturan ini akan berlaku untuk semua siswa.</p>
                    <div id="mapel-list-container"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="button" id="saveMapelConfigBtn" class="btn btn-primary">Simpan Pengaturan</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="inputNilaiModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inputNilaiModalTitle">Input Nilai Siswa</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                    <div class="modal-body">
                        <form id="form-input-nilai">
                            <div id="form-nilai-container"></div>
                            </form>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="button" id="saveNilaiSiswaBtn" class="btn btn-primary">Simpan Nilai</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="transaksiModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="transaksiModalTitle">Catat Transaksi Baru</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <form id="formTransaksi">
                        <input type="hidden" id="transaksiId">
                        <div class="form-group">
                            <label>Jenis Transaksi</label>
                            <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                                <label class="btn btn-outline-success active w-100">
                                    <input type="radio" name="tipe" value="Pemasukan" checked> Pemasukan
                                </label>
                                <label class="btn btn-outline-danger w-100">
                                    <input type="radio" name="tipe" value="Pengeluaran"> Pengeluaran
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="rekeningSelect">Rekening</label>
                            <select class="form-control" id="rekeningSelect" required></select>
                        </div>
                        <div class="form-group">
                            <label for="jumlahUang">Jumlah (Rp)</label>
                            <input type="number" class="form-control" id="jumlahUang" placeholder="Contoh: 50000" required>
                        </div>
                        <div class="form-group">
                            <label for="tanggalTransaksi">Tanggal</label>
                            <input type="date" class="form-control" id="tanggalTransaksi" required>
                        </div>
                        <div class="form-group">
                            <label for="keteranganTransaksi">Keterangan</label>
                            <textarea class="form-control" id="keteranganTransaksi" rows="3" placeholder="Contoh: Pembelian spidol & ATK" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="button" id="saveTransaksiBtn" class="btn btn-primary">Simpan Transaksi</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="rekeningModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buat Rekening Baru</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <form id="formRekening">
                        <div class="form-group">
                            <label for="namaRekening">Nama Rekening</label>
                            <input type="text" class="form-control" id="namaRekening" placeholder="Contoh: Kas Komite Sekolah" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="button" id="saveRekeningBtn" class="btn btn-primary">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Konfirmasi Hapus</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <p>Apakah Anda yakin ingin menghapus transaksi ini?</p>
                    <p class="text-muted" id="detailTransaksiHapus"></p>
                    <strong>Tindakan ini tidak dapat dibatalkan.</strong>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Ya, Hapus</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="tabunganModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tabunganModalTitle"></h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <form id="formTabungan">
                        <input type="hidden" id="tabunganTipe">
                        <input type="hidden" id="tabunganTxId"> <div class="form-group">
                        <div class="form-group">
                            <label for="siswaSelect">Pilih Siswa</label>
                            <div class="input-group">
                                <select class="form-control" id="siswaSelect" required></select>
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="refreshSiswaListBtn" title="Refresh Daftar Siswa">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="jumlahTabungan">Jumlah (Rp)</label>
                            <input type="number" class="form-control" id="jumlahTabungan" placeholder="Contoh: 10000" required>
                            <div class="mt-2">
                                <small class="text-muted">Pilih Cepat:</small>
                                <button type="button" class="btn btn-sm btn-outline-secondary ml-1" onclick="setJumlahTabungan(2000)">2.000</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ml-1" onclick="setJumlahTabungan(5000)">5.000</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary ml-1" onclick="setJumlahTabungan(10000)">10.000</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tanggalTabungan">Tanggal</label>
                            <input type="date" class="form-control" id="tanggalTabungan" required>
                        </div>
                        <div class="form-group">
                            <label for="keteranganTabungan">Keterangan (Opsional)</label>
                            <input type="text" class="form-control" id="keteranganTabungan" placeholder="Contoh: Setoran rutin">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
                    <button type="button" id="saveTabunganBtn" class="btn btn-primary">Simpan</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
// --- GANTI DENGAN KONFIGURASI FIREBASE ANDA ---
const firebaseConfig = {
    apiKey: "AIzaSyD4nAPhGV-USPyElTyHwiDZO0ZvUGRoK5E",
    authDomain: "sistem-absensi-sdn-cicohag.firebaseapp.com",
    projectId: "sistem-absensi-sdn-cicohag",
    storageBucket: "sistem-absensi-sdn-cicohag.appspot.com",
    messagingSenderId: "540116242535",
    appId: "1:540116242535:web:41e3e1e7456ecf1c6584c2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;
let fullRekapData = {};
const html5QrCode = new Html5Qrcode("reader");
// [FITUR NILAI] Variabel global untuk menyimpan state
let nilaiState = {
    kelas: null,
    semester: null,
    tahunAjaran: null,
    daftarSiswa: [],
    konfigurasiMapel: [],
    siswaSedangDiedit: null
};

// [FITUR NILAI] Daftar mata pelajaran master
const daftarMapelMaster = [
    "Pendidikan Agama", "Pendidikan Pancasila", "Bahasa Indonesia", "Matematika",
    "IPAS", "PJOK", "Seni Budaya", "Bahasa Inggris", "Bahasa Sunda"
];

const loginContainer = document.getElementById('login-container');
const mainContainer = document.getElementById('main-container'); // Pastikan ID ini benar
const welcomeMessage = document.getElementById('welcome-message');

// Elemen konten utama
const dashboardContentArea = document.getElementById('dashboard-content-area');
const dailySummaryDisplay = document.getElementById('daily-summary-display'); // REFERENSI BARU untuk daily summary
const mainContentArea = document.getElementById('main-content-area');

// --- FUNGSI BARU UNTUK MENYEMBUNYIKAN SEMUA AREA KONTEN UTAMA ---
function hideAllMainContentAreas() {
    dashboardContentArea.style.display = 'none';
    mainContentArea.style.display = 'none';
    // nilai-selection-view dan nilai-input-view akan otomatis tersembunyi
    // karena mereka berada di dalam mainContentArea yang disembunyikan.
}
// --- AKHIR FUNGSI hideAllMainContentAreas ---

    // Referensi ke elemen-elemen sidebar
    const sidebarUnscannedLink = document.getElementById('sidebar-unscanned-link');
    const sidebarManualLink = document.getElementById('sidebar-manual-link');
    const sidebarOverlay = document.getElementById('sidebar-overlay'); // REFERENSI BARU
    const sidebarDailyCorrectionLink = document.getElementById('sidebar-daily-correction-link');
    const menuWalikelasOnly = document.getElementById('menu-walikelas-only');
    const sidebarCatatanHarianLink = document.getElementById('sidebar-catatan-harian-link'); // <-- TAMBAHKAN BARIS INI
 

    // Referensi tombol di sidebar
    // --- Event Listeners ---
    document.getElementById('sidebar-quick-summary').addEventListener('click', (e) => { e.preventDefault(); showQuickSummary(); });
    document.getElementById('sidebar-rekap-semester').addEventListener('click', (e) => { e.preventDefault(); showRekapSemesterSelection(); });
    document.getElementById('sidebar-scan-absensi').addEventListener('click', (e) => { e.preventDefault(); $('#scan-modal').modal('show'); });
    document.getElementById('sidebar-unscanned-btn').addEventListener('click', (e) => { e.preventDefault(); showUnscannedForm(); });
    document.getElementById('sidebar-manual-input-btn').addEventListener('click', (e) => { e.preventDefault(); showManualAttendanceForm(); });
    document.getElementById('sidebar-daily-correction-btn').addEventListener('click', (e) => { e.preventDefault(); showDailyCorrectionForm(); });
    document.getElementById('logoutButtonGuru').addEventListener('click', (e) => { e.preventDefault(); logout(); });
    document.getElementById('sidebar-rekap-harian').addEventListener('click', (e) => { e.preventDefault(); showDailyRecapView(); });
    document.getElementById('sidebar-cek-usia').addEventListener('click', (e) => { e.preventDefault(); showCekUsiaView(); });
    document.getElementById('sidebar-daftar-siswa').addEventListener('click', (e) => { e.preventDefault(); showDaftarSiswaView(); });
    document.getElementById('sidebar-info-jadwal').addEventListener('click', (e) => { e.preventDefault(); showInfoJadwalView(); });
    document.getElementById('sidebar-catatan-harian').addEventListener('click', (e) => { e.preventDefault(); showCatatanHarianView(); });
    document.getElementById('sidebar-nilai-semester').addEventListener('click', (e) => { e.preventDefault(); showNilaiSelectionView(); });
    document.getElementById('sidebar-keuangan').addEventListener('click', (e) => { e.preventDefault(); showKeuanganDashboard(); });
    document.getElementById('sidebar-tabungan-kelas').addEventListener('click', (e) => { e.preventDefault(); showTabunganKelas(); });
    document.getElementById('sidebar-rekap-tabungan').addEventListener('click', (e) => { e.preventDefault(); showRekapSemuaTabungan(); });
    

// --- FUNGSI UNTUK TOGGLE PASSWORD VISIBILITY ---
const togglePassword = document.getElementById('togglePassword');
const passwordInput = document.getElementById('password');
const toggleIcon = document.getElementById('toggleIcon');

togglePassword.addEventListener('click', function () {
    // Cek tipe input saat ini
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    
    // Ganti ikon mata
    if (type === 'password') {
        // Jika tipe adalah password, ikonnya adalah mata terbuka
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
    } else {
        // Jika tipe adalah text, ikonnya adalah mata dicoret
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
    }
});

// --- Logika Login ---
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const loginButton = document.getElementById('loginButton');
    const loginError = document.getElementById('login-error');
    loginButton.disabled = true;
    loginButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Mengecek...';
    loginError.style.display = 'none';

    const username = document.getElementById('username').value.trim().toLowerCase();
    const password = document.getElementById('password').value;

    try {
        const snapshot = await db.collection('staff').where('username', '==', username).where('password', '==', password).get();
        if (snapshot.empty) throw new Error("Username atau Password salah.");

        const userData = snapshot.docs[0].data();
        currentUser = {
            name: userData.namaLengkap, role: userData.role,
            canEdit: userData.role === 'walikelas' || userData.role === 'admin',
            kelasDiampu: userData.kelasDiampu || null,
            jabatan: userData.jabatan || null
        };
        if (currentUser.jabatan === 'Bendahara' || currentUser.role === 'admin') {
            document.getElementById('menu-rekap-tabungan').style.display = 'block';
        }
        loginContainer.style.display = 'none';
        mainContainer.style.display = 'flex'; // Menggunakan flex untuk sidebar layout
        await showQuickSummary(); // Tampilkan ringkasan cepat secara default
        console.log('Main container display set to:', mainContainer.style.display); // LOG INI PENTING

        welcomeMessage.innerHTML = `<strong>${currentUser.name}</strong>`;

            // Atur visibilitas menu
            const isWaliKelas = currentUser.role === 'walikelas';
            sidebarUnscannedLink.style.display = isWaliKelas ? 'block' : 'none';
            sidebarManualLink.style.display = isWaliKelas ? 'block' : 'none';
            sidebarDailyCorrectionLink.style.display = isWaliKelas ? 'block' : 'none';
            menuWalikelasOnly.style.display = isWaliKelas ? 'block' : 'none';
            sidebarCatatanHarianLink.style.display = isWaliKelas ? 'block' : 'none';
                
    } catch (error) {
        loginError.textContent = error.message;
        loginError.style.display = 'block';
    } finally {
        loginButton.disabled = false;
        loginButton.innerHTML = 'Login';
    }
});

// --- Logika Logout ---
function logout() {
    currentUser = null;
    mainContainer.style.display = 'none';
    loginContainer.style.display = 'block';
    // Pastikan semua area konten disembunyikan saat logout
    dashboardContentArea.innerHTML = ''; 
    mainContentArea.innerHTML = '';
    document.getElementById('loginForm').reset();
    window.location.reload(); 
}

// --- Logika Sidebar Toggle ---
$(document).ready(function () {
    // Event listener untuk tombol MOBILE (fixed)
    $('#sidebarCollapse').on('click', function () {
        // console.log('Tombol MOBILE sidebarCollapse diklik!'); // Debugging line
        $('#sidebar').toggleClass('active');
        $('#content').toggleClass('active');
        // Hanya toggle kelas 'active' pada tombol mobile itu sendiri
        $(this).toggleClass('active'); 
        // Untuk navbar, kelas 'active' hanya perlu diatur oleh tombol desktop agar tidak ada duplikasi toggle
        // atau kita buat ini terpisah agar mobile tetap mengontrol navbar juga.
        // Atau lebih baik, keduanya mengontrol navbar. Mari kita buat keduanya mengontrol navbar.
        $('.custom-navbar-top').toggleClass('active'); // Pastikan ini juga di-toggle oleh tombol mobile
    });

    // Event listener untuk tombol DESKTOP (di dalam navbar)
    $('#sidebarCollapseDesktop').on('click', function () {
        // console.log('Tombol DESKTOP sidebarCollapseDesktop diklik!'); // Debugging line
        $('#sidebar').toggleClass('active');
        $('#content').toggleClass('active');
        $('.custom-navbar-top').toggleClass('active'); // Ini yang penting untuk navbar
        $(this).toggleClass('active'); // Toggle kelas 'active' pada tombol desktop itu sendiri jika diperlukan styling
        
        // Debugging: Cek status kelas 'active' setelah toggle
        // console.log('Status #sidebar active:', $('#sidebar').hasClass('active'));
        // console.log('Status #content active:', $('#content').hasClass('active'));
        // console.log('Status .custom-navbar-top active:', $('.custom-navbar-top').hasClass('active'));
    });
});
// =================================================================
// >>> TEMPEL KODE EVENT LISTENER UNTUK OVERLAY DI SINI <<<
// =================================================================

// Event listener untuk menutup sidebar saat klik di luar (khusus mobile) - DIREVISI DENGAN DEBUGGING
if (sidebarOverlay) { // Pastikan elemen overlay ada
    // console.log('Sidebar Overlay element ditemukan dan listener terpasang.'); // Baris ini dihapus/dikomentari
    sidebarOverlay.addEventListener('click', (event) => {
        // console.log('Overlay diklik!'); // Baris ini dihapus/dikomentari
        // console.log('Current window.innerWidth:', window.innerWidth); // Baris ini dihapus/dikomentari
        // console.log('Sidebar has active class:', $('#sidebar').hasClass('active')); // Baris ini dihapus/dikomentari

        // Periksa apakah sidebar aktif (terbuka) dan lebar layar adalah mobile (<= 768px)
        if ($('#sidebar').hasClass('active') && window.innerWidth <= 768) {
            // console.log('Menutup sidebar melalui klik overlay.'); // Baris ini dihapus/dikomentari
            $('#sidebar').removeClass('active');
            $('#content').removeClass('active');
            $('#sidebarCollapse').removeClass('active');
        } else {
            // console.log('Overlay diklik tetapi sidebar tidak aktif atau bukan ukuran mobile.'); // Baris ini dihapus/dikomentari
        }
        event.stopPropagation();
    });
} else {
    // console.error('ERROR: Elemen Sidebar Overlay (#sidebar-overlay) TIDAK DITEMUKAN di DOM!'); // Baris ini dihapus/dikomentari
}

// =================================================================
// >>> AKHIR DARI KODE EVENT LISTENER OVERLAY <<<
// =================================================================

// --- Logika Scanner ---
$('#scan-modal').on('shown.bs.modal', function () {
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (errorMessage) => {});
});

$('#confirmModal').on('hidden.bs.modal', function () {
    resumeScanner();
});

$('#scan-modal').on('hidden.bs.modal', function () {
    stopScanner();
});

function stopScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        html5QrCode.stop().catch(err => console.log("Gagal menghentikan scanner.", err));
    }
}

async function onScanSuccess(decodedText, decodedResult) {
    if ($('#confirmModal').is(':visible')) return;
    html5QrCode.pause();
    const nisn = decodedText;

    try {
        // 1. Ambil data siswa (ini tidak berubah)
        const siswaSnapshot = await db.collection('siswa').where('nisn', '==', nisn).get();
        if (siswaSnapshot.empty) {
            throw new Error("Siswa tidak terdaftar.");
        }
        const siswaData = siswaSnapshot.docs[0].data();

        // --- LOGIKA BARU UNTUK CEK STATUS ---
        const today = new Date();
        const tglString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
        const docId = `${nisn}_${tglString}`;
        
        const absensiRef = db.collection('absensi_harian').doc(docId);
        const doc = await absensiRef.get();

        let statusFinal;

        if (doc.exists) {
            // Jika dokumen ada, cek apakah sudah pulang atau belum
            const data = doc.data();
            if (data.jamPulang) {
                // Jika jamPulang sudah terisi, berarti sudah absen pulang
                alert(`Siswa atas nama ${siswaData.nama} sudah tercatat absen pulang hari ini.`);
                resumeScanner();
                return;
            }
            // Jika dokumen ada tapi jamPulang kosong, berarti ini scan PULANG
            statusFinal = "Pulang";
        } else {
            // Jika dokumen belum ada, berarti ini scan MASUK
            statusFinal = "Masuk";
        }
        // --- AKHIR LOGIKA BARU ---

        // Tampilkan modal konfirmasi (ini tidak berubah)
        document.getElementById('studentName').textContent = siswaData.nama;
        document.getElementById('studentClass').textContent = `Kelas ${siswaData.kelas}`;
        document.getElementById('attendanceStatus').textContent = statusFinal;
        document.getElementById('statusAlert').className = `alert ${statusFinal === 'Masuk' ? 'alert-success' : 'alert-info'}`;
        $('#confirmModal').modal('show');

    } catch (error) {
        alert(`Error: ${error.message}`);
        resumeScanner();
    }
}

function resumeScanner() {
    try {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.resume();
        }
    } catch (err) {
        console.error("Gagal melanjutkan scanner:", err);
    }
}

// Ganti logika di dalam event listener 'confirmButton'

document.getElementById('confirmButton').addEventListener('click', async () => {
    const confirmButton = document.getElementById('confirmButton');
    const studentName = document.getElementById('studentName').textContent;

    confirmButton.disabled = true;
    confirmButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';

    // Segera sembunyikan modal dan berikan feedback loading
    $('#confirmModal').modal('hide'); 
    Toastify({ 
        text: "Absensi sedang diproses. Mohon tunggu...", 
        duration: 3000, // Durasi bisa diatur sesuai perkiraan waktu proses atau -1 untuk manual hide
        gravity: "top", 
        position: "center", 
        style: { background: "#2196F3" } // Warna biru untuk indikasi proses
    }).showToast();

    try {
        const siswaSnapshot = await db.collection('siswa').where('nama', '==', studentName).get();
        if (siswaSnapshot.empty) throw new Error("Data siswa tidak ditemukan.");
        const siswaData = siswaSnapshot.docs[0].data();
        const { nisn, kelas } = siswaData;
        const statusAbsen = document.getElementById('attendanceStatus').textContent;

        const today = new Date();
        const tglString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
        
        const absensiSiswaRef = db.collection('absensi_harian').doc(`${nisn}_${tglString}`);
        const rekapKelasRef = db.collection('rekap_harian_per_kelas').doc(`${tglString}_${kelas}`);

        const batch = db.batch();

        if (statusAbsen === "Masuk") {
            batch.set(absensiSiswaRef, {
                nisn, nama: siswaData.nama, kelas, tanggal: tglString,
                jamMasuk: firebase.firestore.FieldValue.serverTimestamp(),
                jamPulang: null, status: 'Hadir'
            }, { merge: true });

            const rekapDoc = await rekapKelasRef.get();
            if (!rekapDoc.exists) {
                const siswaKelasSnapshot = await db.collection('siswa').where('kelas', '==', kelas).where('status', '==', 'Aktif').get();
                const totalSiswaDiKelas = siswaKelasSnapshot.size;

                batch.set(rekapKelasRef, {
                    totalSiswa: totalSiswaDiKelas,
                    hadir: 1,
                    belumAbsen: totalSiswaDiKelas - 1,
                    pulang: 0, sakit: 0, izin: 0, alpha: 0
                });
            } else {
                batch.update(rekapKelasRef, {
                    hadir: firebase.firestore.FieldValue.increment(1),
                    belumAbsen: firebase.firestore.FieldValue.increment(-1)
                });
            }
        } else if (statusAbsen === "Pulang") {
            batch.update(absensiSiswaRef, {
                jamPulang: firebase.firestore.FieldValue.serverTimestamp()
            });
            batch.update(rekapKelasRef, {
                pulang: firebase.firestore.FieldValue.increment(1)
            });
        }
        
        // --- PERUBAHAN PENTING DI SINI ---
        // 1. Commit batch write ke Firestore. Ini harus selesai dulu.
        await batch.commit(); 
        
        // 2. Panggil kirimDataAbsensiKeSheet TANPA 'await'
        // Ini akan membuatnya berjalan di latar belakang dan TIDAK memblokir UI
        kirimDataAbsensiKeSheet(nisn, statusAbsen).catch(error => {
            console.error("Error mengirim notifikasi ke Apps Script (non-blocking):", error);
            // Anda bisa menambahkan Toastify error terpisah di sini jika perlu untuk kasus kegagalan pengiriman ke Apps Script
        });
        // --- AKHIR PERUBAHAN PENTING ---

        // Langsung berikan feedback sukses dan lanjutkan scanner
        Toastify({ text: `Absensi berhasil!`, duration: 3000, gravity: "top", position: "center", style: { background: "#4CAF50" } }).showToast();
        await updateQuickDashboard(); 
        resumeScanner(); 

    } catch (error) {
        Toastify({
            text: "Gagal menyimpan absensi: " + error.message, // Pesan error lebih spesifik
            duration: 3000,
            gravity: "top",
            position: "center",
            style: { background: "#dc3545" }
        }).showToast();
        resumeScanner(); 
    } finally {
        // Karena modal sudah disembunyikan dan Toastify sudah muncul, tidak perlu lagi mengubah status tombol di sini.
        confirmButton.disabled = false;
        confirmButton.innerHTML = '✅ Lanjutkan';
    }
});

// --- FITUR BARU: CATATAN ABSEN HARIAN UNTUK BUKU MANUAL (VERSI FINAL EFISIEN) ---
async function showCatatanHarianView() {
    hideAllMainContentAreas(); // Sembunyikan semua yang lain
    mainContentArea.style.display = 'block'; // Tampilkan mainContentArea

    const today = new Date();
    const todayString = today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0') + '-' + today.getDate().toString().padStart(2, '0');

    mainContentArea.innerHTML = `
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-book mr-2"></i> Catatan Siswa Tidak Hadir</h5>
                <p class="card-text text-muted">Pilih tanggal untuk melihat daftar siswa yang tidak hadir. Fitur ini memudahkan pengisian buku absensi manual.</p>
                <div class="form-group">
                    <label for="catatan-harian-date">Pilih Tanggal:</label>
                    <input type="date" id="catatan-harian-date" class="form-control" value="${todayString}">
                </div>
                <div id="catatan-harian-result" class="mt-4"></div>
            </div>
        </div>
    `;

    const dateInput = document.getElementById('catatan-harian-date');
    const resultContainer = document.getElementById('catatan-harian-result');

    const fetchDataForDate = async (selectedDate) => {
        if (!currentUser || !currentUser.kelasDiampu) return;
        
        resultContainer.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Memuat data...</div>';

        const docId = `${selectedDate}_${currentUser.kelasDiampu}`;
        const docRef = db.collection('rekap_ketidakhadiran_harian').doc(docId);

        try {
            const docSnap = await docRef.get(); // Hanya 1 read!
            if (docSnap.exists && docSnap.data().siswa && docSnap.data().siswa.length > 0) {
                const siswaList = docSnap.data().siswa;
                // Urutkan berdasarkan nomor absen
                siswaList.sort((a, b) => (a.nomorAbsen || 999) - (b.nomorAbsen || 999));

                let listHtml = '<ul class="list-group">';
                siswaList.forEach(siswa => {
                    listHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><strong>${siswa.nomorAbsen}.</strong> ${siswa.nama}</span>
                            <span class="badge badge-${getBadgeClass(siswa.status)} p-2">${siswa.status}</span>
                        </li>
                    `;
                });
                listHtml += '</ul>';
                resultContainer.innerHTML = listHtml;
            } else {
                resultContainer.innerHTML = '<div class="alert alert-success text-center">Tidak ada siswa yang tercatat tidak hadir pada tanggal ini.</div>';
            }
        } catch (error) {
            console.error("Error fetching daily absence notes:", error);
            resultContainer.innerHTML = `<div class="alert alert-danger">Gagal memuat data: ${error.message}</div>`;
        }
    };

    dateInput.addEventListener('change', (e) => fetchDataForDate(e.target.value));
    fetchDataForDate(todayString);
}

// =================================================================
// --- FUNGSI TAMPILAN KONTEN UTAMA ---
// =================================================================
function showQuickSummary() {
    console.log('Entering showQuickSummary()...');
    hideAllMainContentAreas(); // Panggil fungsi sembunyikan yang baru
    dashboardContentArea.style.display = 'block'; // Tampilkan dashboard saja
    
    // Opsional: Pastikan dailySummaryDisplay itu sendiri juga 'block'
    // dailySummaryDisplay.style.display = 'block'; // Biasanya tidak perlu jika parentnya block
    
    renderDailySummary();
    console.log('Leaving showQuickSummary(). renderDailySummary() was called.');
}

    // --- FITUR BARU: DAFTAR SISWA ---
    async function showDaftarSiswaView() {
        hideAllMainContentAreas();
        mainContentArea.style.display = 'block';
        
        // Tampilkan kerangka halaman dengan tombol refresh
        mainContentArea.innerHTML = `
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                        <h5 class="card-title mb-0">Daftar Siswa & Kontak Ortu - Kelas ${currentUser.kelasDiampu}</h5>
                        <div class="d-flex mt-2 mt-md-0">
                            <button class="btn btn-info btn-sm mr-2" id="refresh-siswa-cache-btn"><i class="fas fa-sync-alt"></i> Perbarui Data</button>
                            <button class="btn btn-secondary btn-sm" id="reorder-siswa-btn"><i class="fas fa-sort-numeric-down"></i> Urutkan</button>
                        </div>
                    </div>
                    <div id="siswa-table-wrapper" class="table-responsive">
                        <div class="text-center mt-4"><div class="spinner-border"></div><p>Memuat daftar siswa...</p></div>
                    </div>
                </div>
            </div>`;

        const refreshButton = document.getElementById('refresh-siswa-cache-btn');
        
        // Fungsi pembantu untuk memuat dan merender data
        const loadAndRender = async (list) => {
            currentClassStudents = list;
            renderDaftarSiswa(list);
            // Event listener untuk tombol 'Urutkan' baru bisa ditambahkan setelah data ada
            document.getElementById('reorder-siswa-btn').addEventListener('click', function() {
                // ... (logika untuk reorder bisa ditambahkan di sini jika diperlukan)
            });
        };

        // Tambahkan event listener ke tombol refresh
        refreshButton.addEventListener('click', async () => {
            const refreshedList = await refreshDaftarSiswaCache(currentUser.kelasDiampu, refreshButton);
            if (refreshedList) {
                loadAndRender(refreshedList);
            }
        });

        try {
            const cacheRef = db.collection('cache_daftar_siswa').doc(currentUser.kelasDiampu);
            const cacheDoc = await cacheRef.get();

            if (cacheDoc.exists) {
                // Jika cache ada, langsung tampilkan
                loadAndRender(cacheDoc.data().daftarSiswa);
            } else {
                // Jika cache belum ada, buat cache secara otomatis
                Toastify({ text: "Cache belum ada, membuat cache baru secara otomatis...", duration: 3000, style: { background: "blue" } }).showToast();
                const newList = await refreshDaftarSiswaCache(currentUser.kelasDiampu, refreshButton);
                if (newList) {
                    loadAndRender(newList);
                } else {
                    document.getElementById('siswa-table-wrapper').innerHTML = `<div class="alert alert-warning">Gagal membuat cache. Silakan coba lagi.</div>`;
                }
            }
        } catch (error) {
            document.getElementById('siswa-table-wrapper').innerHTML = `<div class="alert alert-danger">Gagal memuat daftar siswa: ${error.message}</div>`;
        }
    }

    function renderDaftarSiswa(students, editMode = false) {
        const container = document.getElementById('siswa-table-wrapper');
        let tableHtml = `<table class="table table-hover table-sm">
                            <thead><tr><th>No</th><th>Nama</th><th>NISN</th><th>Nama Ortu</th><th>No. WA</th><th>Tanggal Lahir</th><th>Status</th><th>Aksi</th></tr></thead>
                            <tbody>`;
        
        if (students.length === 0) {
            tableHtml += '<tr><td colspan="7" class="text-center">Tidak ada siswa aktif di kelas ini.</td></tr>';
        } else {
            students.forEach(siswa => {
                const isIncomplete = !siswa.namaOrtu || !siswa.nomorWa || !siswa.tglLahir;
                const rowClass = isIncomplete ? 'table-warning' : '';

                tableHtml += `<tr data-nisn="${siswa.nisn}" class="${rowClass}">`;
                if(editMode) {
                    tableHtml += `
                        <td><input type="number" class="form-control form-control-sm edit-nomorAbsen" value="${siswa.nomorAbsen || ''}"></td>
                        <td><input type="text" class="form-control form-control-sm edit-nama" value="${siswa.nama || ''}"></td>
                        <td>${siswa.nisn}</td>
                        <td><input type="text" class="form-control form-control-sm edit-namaOrtu" value="${siswa.namaOrtu || ''}"></td>
                        <td><input type="text" class="form-control form-control-sm edit-nomorWa" value="${siswa.nomorWa || ''}"></td>
                        <td><input type="text" class="form-control form-control-sm edit-tglLahir" value="${siswa.tglLahir || ''}"></td>
                        <td><span class="badge badge-${siswa.status === 'Aktif' ? 'success' : 'secondary'}">${siswa.status}</span></td>
                        <td>-</td>`;
                } else {
                    tableHtml += `
                        <td>${siswa.nomorAbsen || '-'}</td>
                        <td>${siswa.nama}</td>
                        <td>${siswa.nisn}</td>
                        <td>${siswa.namaOrtu || '-'}</td>
                        <td>${siswa.nomorWa || '-'}</td>
                        <td>${siswa.tglLahir || '-'}</td>
                        <td><span class="badge badge-${siswa.status === 'Aktif' ? 'success' : 'secondary'}">${siswa.status}</span></td>
                        <td><button class="btn btn-sm btn-warning edit-siswa-info-btn" data-nisn="${siswa.nisn}"><i class="fas fa-edit"></i></button></td>`;
                }
                tableHtml += `</tr>`;
            });
        }
        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
    }


// GANTI FUNGSI showInfoJadwalView() DENGAN INI
async function showInfoJadwalView() {
    hideAllMainContentAreas();
    mainContentArea.style.display = 'block';
    mainContentArea.innerHTML = '<div class="text-center mt-4"><div class="spinner-border"></div><p>Memuat info & jadwal...</p></div>';

    try {
        const docRef = db.collection('info_kelas').doc(currentUser.kelasDiampu);
        const docSnap = await docRef.get();
        const data = docSnap.exists ? docSnap.data() : {};
        const hari = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];

        // Membuat tabel untuk menampilkan data
        let tableHtml = `
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Info & Jadwal - Kelas ${currentUser.kelasDiampu}</h5>
                    <button class="btn btn-primary" id="edit-jadwal-btn"><i class="fas fa-edit mr-2"></i></button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="thead-light text-center">
                                <tr>
                                    <th>Hari</th>
                                    <th>Jadwal Pelajaran</th>
                                    <th>Jadwal Piket</th>
                                    <th>Seragam</th>
                                </tr>
                            </thead>
                            <tbody>
        `;

        hari.forEach(day => {
            // Gunakan optional chaining (?.) untuk mencegah error jika data belum ada
            const pelajaran = data.pelajaran?.[day] || '-';
            const piket = data.piket?.[day] || '-';
            const seragam = data.seragam?.[day] || '-';
            tableHtml += `
                <tr>
                    <td class="font-weight-bold">${day}</td>
                    <td>${pelajaran}</td>
                    <td>${piket}</td>
                    <td>${seragam}</td>
                </tr>
            `;
        });

        tableHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        mainContentArea.innerHTML = tableHtml;
        
        // Simpan data mentah untuk digunakan saat tombol edit diklik
        $('#edit-jadwal-btn').data('raw-data', data);

    } catch (error) {
         mainContentArea.innerHTML = `<div class="alert alert-danger">Gagal memuat jadwal: ${error.message}</div>`;
    }
}


    // GANTI FUNGSI UNTUK EVENT LISTENER TOMBOL EDIT JADWAL DENGAN INI
    $(document).on('click', '#edit-jadwal-btn', function() {
        const data = $(this).data('raw-data') || {};
        const hari = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const accordionContainer = $('#jadwalAccordion');
        
        // Kosongkan kontainer sebelum mengisi ulang
        accordionContainer.html('');

        // Loop untuk setiap hari dan buat satu bagian akordeon
        hari.forEach((day, index) => {
            const dayId = day.toLowerCase();
            // Ambil data yang ada untuk hari ini
            const pelajaranValue = data.pelajaran?.[day] || '';
            const piketValue = data.piket?.[day] || '';
            const seragamValue = data.seragam?.[day] || '';

            // Tentukan apakah bagian ini harus terbuka secara default (misalnya hari Senin)
            const isShown = index === 0 ? 'show' : '';

            const accordionItemHtml = `
                <div class="card mb-2">
                    <div class="card-header" id="heading-${dayId}">
                        <h2 class="mb-0">
                            <button class="btn btn-link btn-block text-left d-flex justify-content-between align-items-center" type="button" data-toggle="collapse" data-target="#collapse-${dayId}">
                                <strong>${day}</strong>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </h2>
                    </div>
                    <div id="collapse-${dayId}" class="collapse ${isShown}" data-parent="#jadwalAccordion">
                        <div class="card-body">
                            <div class="form-group">
                                <label for="jadwal-pelajaran-${dayId}" class="font-weight-bold small">Jadwal Pelajaran</label>
                                <input type="text" class="form-control" id="jadwal-pelajaran-${dayId}" value="${pelajaranValue}" placeholder="cth: IPAS, Matematika">
                            </div>
                            <div class="form-group">
                                <label for="jadwal-piket-${dayId}" class="font-weight-bold small">Jadwal Piket</label>
                                <input type="text" class="form-control" id="jadwal-piket-${dayId}" value="${piketValue}" placeholder="cth: Budi, Ani, Aisyah">
                            </div>
                            <div class="form-group">
                                <label for="jadwal-seragam-${dayId}" class="font-weight-bold small">Seragam</label>
                                <input type="text" class="form-control" id="jadwal-seragam-${dayId}" value="${seragamValue}" placeholder="cth: Merah Putih">
                            </div>
                        </div>
                    </div>
                </div>
            `;
            accordionContainer.append(accordionItemHtml);
        });

        // Tampilkan modal setelah akordeon selesai dibuat
        $('#editJadwalModal').modal('show');
    });


    // GANTI FUNGSI UNTUK EVENT LISTENER TOMBOL SIMPAN JADWAL DENGAN INI
    $('#saveJadwalBtn').on('click', async function() {
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Menyimpan...');
        
        const hari = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const pelajaranData = {};
        const piketData = {};
        const seragamData = {};

        // Kumpulkan data dari setiap input di modal
        hari.forEach(day => {
            const dayId = day.toLowerCase();
            pelajaranData[day] = $(`#jadwal-pelajaran-${dayId}`).val().trim();
            piketData[day] = $(`#jadwal-piket-${dayId}`).val().trim();
            seragamData[day] = $(`#jadwal-seragam-${dayId}`).val().trim();
        });

        const dataToUpdate = {
            pelajaran: pelajaranData,
            piket: piketData,
            seragam: seragamData
        };

        try {
            await db.collection('info_kelas').doc(currentUser.kelasDiampu).set(dataToUpdate, { merge: true });
            Toastify({ text: "Jadwal berhasil disimpan!", style: { background: "green" } }).showToast();
            $('#editJadwalModal').modal('hide');
            showInfoJadwalView(); // Muat ulang tampilan untuk menampilkan data baru
        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).text('Simpan Jadwal');
        }
    });

    
    // --- Modal & Save Logic for New Features ---
    $(document).on('click', '.edit-siswa-info-btn', function() {
        const nisn = $(this).data('nisn').toString();
        const siswa = currentClassStudents.find(s => s.nisn.toString() === nisn);
        if (siswa) {
            $('#editSiswaNisn').val(siswa.nisn);
            $('#editSiswaNama').val(siswa.nama);
            $('#editSiswaNomorAbsen').val(siswa.nomorAbsen);
            $('#editSiswaNamaOrtu').val(siswa.namaOrtu);
            $('#editSiswaNomorWa').val(siswa.nomorWa);
            $('#editSiswatglLahir').val(siswa.tglLahir);
            
            const statusSelect = $('#editSiswaStatus');
            statusSelect.html('<option value="Aktif">Aktif</option><option value="Pindah">Pindah</option>');
            if (currentUser.kelasDiampu === '6') {
                statusSelect.append('<option value="Lulus">Lulus</option>');
            }
            statusSelect.val(siswa.status);
            
            $('#editSiswaInfoModal').modal('show');
        }
    });

    $('#saveSiswaInfoBtn').on('click', async function() {
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        
        const nisn = $('#editSiswaNisn').val();
        const originalStudent = currentClassStudents.find(s => s.nisn.toString() === nisn.toString());
        const newStatus = originalStudent.status; // Paksa gunakan status asli

        const dataToUpdate = {
            nama: $('#editSiswaNama').val(),
            nomorAbsen: (newStatus === 'Aktif') ? parseInt($('#editSiswaNomorAbsen').val()) || null : null,
            namaOrtu: $('#editSiswaNamaOrtu').val(),
            nomorWa: $('#editSiswaNomorWa').val(),
            tglLahir: $('#editSiswatglLahir').val(),
            status: newStatus
        };

        try {
            await db.collection('siswa').doc(nisn).update(dataToUpdate);
            Toastify({ text: "Info siswa berhasil diperbarui!", style: { background: "green" } }).showToast();
            $('#editSiswaInfoModal').modal('hide');

            if (originalStudent && originalStudent.status === 'Aktif' && (newStatus === 'Pindah' || newStatus === 'Lulus')) {
                await resequenceClassAbsen(currentUser.kelasDiampu);
            }

        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).text('Simpan');
            // --- TAMBAHAN: Refresh cache dan muat ulang tampilan setelah menyimpan ---
            const refreshedList = await refreshDaftarSiswaCache(currentUser.kelasDiampu);
            if (refreshedList) {
                currentClassStudents = refreshedList;
                renderDaftarSiswa(refreshedList);
            }
        }
    });
    

    $(document).on('click', '#edit-jadwal-btn', function() {
        const data = $(this).data('raw-data') || {};
        $('#editJadwalPelajaran').val(data.pelajaran || '');
        $('#editJadwalPiket').val(data.piket || '');
        $('#editJadwalSeragam').val(data.seragam || '');
        $('#editJadwalModal').modal('show');
    });

    $('#saveJadwalBtn').on('click', async function() {
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

        const dataToUpdate = {
            pelajaran: $('#editJadwalPelajaran').val().trim(),
            piket: $('#editJadwalPiket').val().trim(),
            seragam: $('#editJadwalSeragam').val().trim()
        };

        try {
            await db.collection('info_kelas').doc(currentUser.kelasDiampu).set(dataToUpdate, { merge: true });
            Toastify({ text: "Jadwal berhasil disimpan!", style: { background: "green" } }).showToast();
            $('#editJadwalModal').modal('hide');
            showInfoJadwalView(); // Refresh view
        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).text('Simpan Jadwal');
        }
    });

    // --- New Logic for Daftar Siswa Page ---
    $(document).on('click', '#bulk-edit-siswa-btn', () => toggleBulkEditMode(true));
    $(document).on('click', '#cancel-bulk-edit-siswa-btn', () => toggleBulkEditMode(false));
    
    function toggleBulkEditMode(enable) {
        isBulkEditMode = enable;
        $('#default-actions-siswa').toggle(!enable);
        $('#edit-mode-actions-siswa').toggle(enable);
        renderDaftarSiswa(currentClassStudents, isBulkEditMode);
    }

    $(document).on('click', '#save-bulk-changes-siswa-btn', async function() {
        const btn = $(this);
        btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');
        
        const batch = db.batch();
        let changesCount = 0;
        let needsResequence = false;

        $('#main-content-area tbody tr').each(function() {
            const row = $(this);
            const nisn = row.data('nisn').toString();
            const originalStudent = currentClassStudents.find(s => s.nisn.toString() === nisn);

            const updatedData = {
                nomorAbsen: parseInt(row.find('.edit-nomorAbsen').val()) || null,
                nama: row.find('.edit-nama').val(),
                namaOrtu: row.find('.edit-namaOrtu').val() || null,
                nomorWa: row.find('.edit-nomorWa').val() || null,
                status: originalStudent.status
            };

            const hasChanged = (originalStudent.nomorAbsen || null) !== updatedData.nomorAbsen ||
                           (originalStudent.nama || '') !== updatedData.nama ||
                           (originalStudent.namaOrtu || null) !== updatedData.namaOrtu ||
                           (originalStudent.nomorWa || null) !== updatedData.nomorWa ||
                           (originalStudent.status || 'Aktif') !== updatedData.status;

            if (hasChanged) {
                if (originalStudent.status === 'Aktif' && (updatedData.status === 'Pindah' || updatedData.status === 'Lulus')) {
                    needsResequence = true;
                    updatedData.nomorAbsen = null;
                }
                const docRef = db.collection('siswa').doc(nisn);
                batch.update(docRef, updatedData);
                changesCount++;
            }
        });

        if (changesCount === 0) {
            Toastify({ text: "Tidak ada perubahan untuk disimpan.", style: { background: "orange" } }).showToast();
            btn.prop('disabled', false).html('<i class="fas fa-save"></i> Simpan');
            toggleBulkEditMode(false);
            return;
        }

        try {
            await batch.commit();
            Toastify({ text: `${changesCount} data siswa berhasil diperbarui!`, style: { background: "green" } }).showToast();
            if (needsResequence) {
                await resequenceClassAbsen(currentUser.kelasDiampu);
            }
        } catch (error) {
            Toastify({ text: `Error: ${error.message}`, style: { background: "red" } }).showToast();
        } finally {
            btn.prop('disabled', false).html('<i class="fas fa-save"></i> Simpan');
            toggleBulkEditMode(false);
            await showDaftarSiswaView();
        }
    });
    

    $(document).on('click', '#reorder-siswa-btn', function() {
        const reorderList = $('#reorder-list');
        reorderList.html('');
        currentClassStudents.sort((a,b) => (a.nomorAbsen || 999) - (b.nomorAbsen || 999)).forEach(s => {
            reorderList.append(`<li class="list-group-item d-flex justify-content-between align-items-center" data-nisn="${s.nisn}">
                <span>${s.nomorAbsen || 'N/A'}. ${s.nama}</span>
                <span><button class="btn btn-light btn-sm move-up-btn"><i class="fas fa-arrow-up"></i></button><button class="btn btn-light btn-sm move-down-btn"><i class="fas fa-arrow-down"></i></button></span>
            </li>`);
        });
        updateReorderButtonsState();
        $('#reorderModal').modal('show');
    });

    async function resequenceClassAbsen(className) {
        const classNumber = className.replace('Kelas ', '');
        console.log(`Mengurutkan ulang nomor absen untuk kelas ${classNumber}...`);
        const batch = db.batch();
        try {
            const snapshot = await db.collection('siswa').where('kelas', '==', classNumber).where('status', '==', 'Aktif').orderBy('nomorAbsen').get();
            let reorderCount = 0;
            snapshot.docs.forEach((doc, index) => {
                const newAbsenNumber = index + 1;
                const currentAbsenNumber = doc.data().nomorAbsen;
                if (newAbsenNumber !== currentAbsenNumber) {
                    const docRef = db.collection('siswa').doc(doc.id);
                    batch.update(docRef, { nomorAbsen: newAbsenNumber });
                    reorderCount++;
                }
            });
            if (reorderCount > 0) {
                await batch.commit();
                Toastify({ text: `Nomor absen untuk kelas ${classNumber} berhasil diurutkan ulang.`, duration: 3000, style: { background: "blue" } }).showToast();
            }
        } catch (error) {
            console.error("Error resequencing class:", error);
        }
    }



function showRekapSemesterSelection() {
    hideAllMainContentAreas();
    mainContentArea.style.display = 'block';

    mainContentArea.innerHTML = `
        <div id="semester-selection-card" class="card card-body mt-4">
            <h5 class="card-title text-center mb-3">Pilih Semester untuk Melihat Rekap</h5>
            <ul class="nav nav-pills justify-content-center mb-3" id="semesterPills" role="tablist">
                <li class="nav-item"><a class="nav-link active" id="semester1-tab" data-toggle="pill" href="#semester1Content" role="tab">Semester 1 (Juli - Des)</a></li>
                <li class="nav-item"><a class="nav-link" id="semester2-tab" data-toggle="pill" href="#semester2Content" role="tab">Semester 2 (Jan - Juni)</a></li>
            </ul>
            <div class="tab-content" id="semesterTabContent">
                <div class="tab-pane fade show active" id="semester1Content" role="tabpanel">
                    <div id="rekap-semester-view-container-1" class="mt-3"></div>
                </div>
                <div class="tab-pane fade" id="semester2Content" role="tabpanel">
                    <div id="rekap-semester-view-container-2" class="mt-3"></div>
                </div>
            </div>
        </div>`;
    
    $('#semester1-tab').on('shown.bs.tab', () => fetchRekap(1));
    $('#semester2-tab').on('shown.bs.tab', () => fetchRekap(2));
    
    // Secara default, muat rekap untuk semester 1
    fetchRekap(1);
}

// *** FUNGSI BARU UNTUK MENAMPILKAN REKAP HARIAN (REVISI UI/UX + PEMILIH TAHUN) ***
async function showDailyRecapView() {
    hideAllMainContentAreas(); // Panggil fungsi sembunyikan yang baru
    mainContentArea.style.display = 'block'; // Tampilkan mainContentArea

    // State untuk menyimpan pilihan saat ini
    let selectedClass = currentUser.role === 'walikelas' ? currentUser.kelasDiampu : null;
    let currentDate = new Date();
    let selectorYear = currentDate.getFullYear(); // Tahun yang ditampilkan di panel pemilih

    let classSelectorHtml = '';
    // Jika admin, siapkan UI untuk memilih kelas
    if (currentUser.role === 'admin' || currentUser.role === 'mapel') {
        mainContentArea.innerHTML = '<div class="text-center mt-4"><div class="spinner-border"></div><p>Memuat daftar kelas...</p></div>';
        try {
            const snapshot = await db.collection('siswa').where('status', '==', 'Aktif').get();
            const classes = new Set();
            snapshot.forEach(doc => classes.add(doc.data().kelas));
            const sortedClasses = Array.from(classes).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            
            classSelectorHtml = `
                <h6 class="text-muted text-center mb-2">Pilih Kelas</h6>
                <div id="daily-recap-class-selector" class="text-center mb-4">
                    ${sortedClasses.map(c => `<button class="btn btn-outline-primary m-1 class-btn" data-kelas="${c}">${c}</button>`).join('')}
                </div>
                <hr>
            `;
        } catch (error) {
            mainContentArea.innerHTML = `<div class="alert alert-danger">Gagal memuat daftar kelas: ${error.message}</div>`;
            return;
        }
    }

    // Render kerangka utama UI
    mainContentArea.innerHTML = `
        <div class="card">
            <div class="card-body">
                <h5 class="card-title text-center"><i class="fas fa-calendar-day"></i> Rekap Absensi Harian</h5>
                ${classSelectorHtml}
                
                <div class="month-selector-container" style="position: relative;">
                    <div class="d-flex justify-content-center align-items-center my-3">
                        <button id="prev-month-btn" class="btn btn-light btn-lg"><i class="fas fa-chevron-left"></i></button>
                        <h4 id="current-month-display" class="mx-4 mb-0 font-weight-bold" style="width: 220px; text-align: center; cursor: pointer; user-select: none;" title="Klik untuk memilih bulan dan tahun"></h4>
                        <button id="next-month-btn" class="btn btn-light btn-lg"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    
                    <div id="month-year-selector" class="card shadow-lg" style="display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); z-index: 1000; width: 280px;">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <button id="selector-prev-year" class="btn btn-sm btn-outline-secondary">&lt;</button>
                                <span id="selector-current-year" class="font-weight-bold"></span>
                                <button id="selector-next-year" class="btn btn-sm btn-outline-secondary">&gt;</button>
                            </div>
                            <div id="selector-month-grid" class="row no-gutters">
                                </div>
                        </div>
                    </div>
                </div>

                <div id="daily-recap-table-container" class="mt-3"></div>
            </div>
        </div>
    `;

    const monthDisplay = document.getElementById('current-month-display');
    const tableContainer = document.getElementById('daily-recap-table-container');
    const monthYearSelector = document.getElementById('month-year-selector');
    const selectorYearDisplay = document.getElementById('selector-current-year');
    const monthGrid = document.getElementById('selector-month-grid');

    const monthNames = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];

    // Fungsi untuk membuat grid bulan di panel
    const generateMonthGrid = () => {
        selectorYearDisplay.textContent = selectorYear;
        monthGrid.innerHTML = monthNames.map((name, index) => {
            const isSelected = (index === currentDate.getMonth() && selectorYear === currentDate.getFullYear());
            const btnClass = isSelected ? 'btn-primary' : 'btn-light';
            return `<div class="col-3 p-1"><button class="btn btn-sm btn-block ${btnClass}" data-month="${index}">${name}</button></div>`;
        }).join('');
    };

    // Fungsi untuk update tampilan utama dan render tabel
    const updateDisplayAndRender = () => {
        monthDisplay.textContent = currentDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
        if (selectedClass) {
            renderDailyRecapTable(selectedClass, currentDate.getFullYear(), currentDate.getMonth() + 1);
        } else {
            tableContainer.innerHTML = '<p class="text-muted text-center">Silakan pilih kelas untuk melihat rekap.</p>';
        }
    };

    // --- Event Listeners ---

    // Navigasi bulan cepat
    document.getElementById('prev-month-btn').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateDisplayAndRender();
    });
    document.getElementById('next-month-btn').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateDisplayAndRender();
    });

    // Buka/tutup panel pemilih
    monthDisplay.addEventListener('click', (e) => {
        e.stopPropagation();
        const isHidden = monthYearSelector.style.display === 'none';
        if (isHidden) {
            selectorYear = currentDate.getFullYear();
            generateMonthGrid();
            monthYearSelector.style.display = 'block';
        } else {
            monthYearSelector.style.display = 'none';
        }
    });

    // Navigasi tahun di dalam panel
    document.getElementById('selector-prev-year').addEventListener('click', () => {
        selectorYear--;
        generateMonthGrid();
    });
    document.getElementById('selector-next-year').addEventListener('click', () => {
        selectorYear++;
        generateMonthGrid();
    });

    // Memilih bulan di dalam panel
    monthGrid.addEventListener('click', (e) => {
        if (e.target.matches('[data-month]')) {
            const selectedMonth = parseInt(e.target.dataset.month);
            currentDate.setFullYear(selectorYear, selectedMonth, 1);
            monthYearSelector.style.display = 'none';
            updateDisplayAndRender();
        }
    });

    // Menutup panel jika klik di luar
    window.addEventListener('click', (e) => {
        if (!monthYearSelector.contains(e.target) && e.target !== monthDisplay) {
            monthYearSelector.style.display = 'none';
        }
    });
    
    // Memilih kelas
    const classSelector = document.getElementById('daily-recap-class-selector');
    if (classSelector) {
        classSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('class-btn')) {
                document.querySelectorAll('.class-btn').forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                });
                e.target.classList.remove('btn-outline-primary');
                e.target.classList.add('btn-primary');
                selectedClass = e.target.dataset.kelas;
                updateDisplayAndRender();
            }
        });
    }

    // Panggilan inisialisasi
    updateDisplayAndRender();
}


// *** FUNGSI BARU UNTUK MERENDER TABEL REKAP HARIAN ***
async function renderDailyRecapTable(className, year, month) {
    const container = document.getElementById('daily-recap-table-container');
    container.innerHTML = '<div class="text-center mt-4"><div class="spinner-border"></div><p>Memuat rekap harian...</p></div>';

    try {
        const docId = `${className}-${year}-${month}`;
        const docRef = db.collection('agregat_bulanan_kelas').doc(docId);
        const docSnap = await docRef.get();

        const data = docSnap.exists ? docSnap.data().rekap : {};

        const daysInMonth = new Date(year, month, 0).getDate();
        const monthName = new Date(year, month - 1).toLocaleString('id-ID', { month: 'long' });

        let tableHtml = `
            <h6 class="text-center font-weight-bold">Rekap Kelas ${className} - ${monthName} ${year}</h6>
            <div class="table-responsive">
                <table class="table table-bordered table-sm text-center">
                    <thead class="thead-light">
                        <tr>
                            <th style="min-width: 80px;">Status</th>
            `;

        for (let day = 1; day <= daysInMonth; day++) {
            tableHtml += `<th>${day}</th>`;
        }
        tableHtml += `<th>Jumlah</th></tr></thead><tbody>`;

        // --- PERBAIKAN TYPO DI SINI ---
        const statuses = ['Sakit', 'Izin', 'Alfa'];
        const statusKeys = { 'Sakit': 'sakit', 'Izin': 'izin', 'Alfa': 'alpha' };
        // --- AKHIR PERBAIKAN ---
        
        statuses.forEach(status => {
            let totalStatus = 0;
            tableHtml += `<tr><th>${status}</th>`;
            for (let day = 1; day <= daysInMonth; day++) {
                const dayData = data[`tgl_${day}`] || {};
                const count = dayData[statusKeys[status]] || 0;
                tableHtml += `<td>${count > 0 ? count : '-'}</td>`;
                totalStatus += count;
            }
            tableHtml += `<td class="font-weight-bold">${totalStatus}</td></tr>`;
        });

        tableHtml += '</tbody></table></div>';
        container.innerHTML = tableHtml;

    } catch (error) {
        console.error("Error rendering daily recap table:", error);
        container.innerHTML = `<div class="alert alert-danger">Gagal memuat rekap: ${error.message}</div>`;
    }
}

// --- FITUR BARU: CEK USIA SISWA ---

function calculateAge(birthDateString, targetDate) {
    // Parsing tanggal lahir dari format DDMMYYYY
    const day = parseInt(birthDateString.substring(0, 2), 10);
    const month = parseInt(birthDateString.substring(2, 4), 10) - 1; // Bulan di JS dari 0-11
    const year = parseInt(birthDateString.substring(4, 8), 10);
    const birthDate = new Date(year, month, day);

    let years = targetDate.getFullYear() - birthDate.getFullYear();
    let months = targetDate.getMonth() - birthDate.getMonth();
    
    // Koreksi jika bulan target lebih kecil dari bulan lahir, atau jika bulan sama tapi tanggal lebih kecil
    if (months < 0 || (months === 0 && targetDate.getDate() < birthDate.getDate())) {
        years--;
        // Menghitung sisa bulan dengan benar
        months = (months + 12) % 12;
    }

    // Koreksi tambahan jika tanggal di bulan yang sama belum terlewati
     if (targetDate.getDate() < birthDate.getDate() && months === 0) {
        // Jika di bulan yang sama tapi tanggal belum lewat, umur bulan harusnya 11
        months = 11;
    } else if (targetDate.getDate() < birthDate.getDate()) {
        // Jika tanggal belum lewat di bulan berbeda, kurangi 1 bulan
        months--;
    }


    return { years, months };
}


async function renderCekUsiaTable(className, year, month) {
    const container = document.getElementById('daily-recap-table-container');
    container.innerHTML = '<div class="text-center mt-4"><div class="spinner-border"></div><p>Mencari data usia siswa...</p></div>';

    // --- LOGIKA BARU DENGAN CACHING ---
    const cacheDocId = `${className}-${year}-${month}`;
    const cacheRef = db.collection('cache_usia_siswa').doc(cacheDocId);

    try {
        const cacheDoc = await cacheRef.get();

        let studentsWithAge = [];

        if (cacheDoc.exists) {
            // JALUR 1: Data ditemukan di cache (1 read)
            console.log("Data usia ditemukan di cache.");
            studentsWithAge = cacheDoc.data().dataSiswa;

        } else {
            // JALUR 2: Data tidak ada di cache, hitung manual
            console.log("Cache tidak ditemukan, menghitung usia secara manual.");
            const siswaSnapshot = await db.collection('siswa')
                .where('kelas', '==', className)
                .where('status', '==', 'Aktif')
                .get();

            if (siswaSnapshot.empty) {
                container.innerHTML = '<div class="alert alert-info">Tidak ada siswa aktif di kelas ini.</div>';
                return;
            }
            
            const targetDate = new Date(year, month, 0);
            
            siswaSnapshot.forEach(doc => {
                const siswa = doc.data();
                if (siswa.tglLahir && siswa.tglLahir.length === 8) {
                    const age = calculateAge(siswa.tglLahir, targetDate);
                    studentsWithAge.push({
                        nama: siswa.nama,
                        nomorAbsen: siswa.nomorAbsen,
                        ageString: `${age.years} Tahun ${age.months} Bulan`
                    });
                }
            });

            // Simpan hasil perhitungan ke cache untuk penggunaan selanjutnya
            await cacheRef.set({
                kelas: className,
                tahun: year,
                bulan: month,
                dibuatPada: firebase.firestore.FieldValue.serverTimestamp(),
                dataSiswa: studentsWithAge
            });
            console.log("Cache usia berhasil dibuat untuk:", cacheDocId);
        }
        
        // Urutkan berdasarkan nomor absen (baik dari cache maupun dari perhitungan baru)
        studentsWithAge.sort((a, b) => a.nomorAbsen - b.nomorAbsen);

        if (studentsWithAge.length === 0) {
             container.innerHTML = '<div class="alert alert-warning">Tidak ada siswa dengan data tanggal lahir yang valid di kelas ini.</div>';
             return;
        }

        let listHtml = '<ul class="list-group list-group-flush">';
        studentsWithAge.forEach(siswa => {
            listHtml += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${siswa.nomorAbsen}. ${siswa.nama}</span>
                    <span class="badge badge-primary badge-pill p-2">${siswa.ageString}</span>
                </li>
            `;
        });
        listHtml += '</ul>';

        container.innerHTML = listHtml;

    } catch (error) {
        console.error("Error rendering student age list:", error);
        container.innerHTML = `<div class="alert alert-danger">Gagal memuat data siswa: ${error.message}</div>`;
    }
}


async function showCekUsiaView() {
    // Fungsi ini SANGAT MIRIP dengan showDailyRecapView, hanya memanggil render function yang berbeda
    hideAllMainContentAreas(); // Panggil fungsi sembunyikan yang baru
    mainContentArea.style.display = 'block'; // Tampilkan mainContentArea

    let selectedClass = currentUser.role === 'walikelas' ? currentUser.kelasDiampu : null;
    let currentDate = new Date();
    let selectorYear = currentDate.getFullYear();

    let classSelectorHtml = '';
    if (currentUser.role === 'admin' || currentUser.role === 'mapel') {
        mainContentArea.innerHTML = '<div class="text-center mt-4"><div class="spinner-border"></div><p>Memuat daftar kelas...</p></div>';
        try {
            const snapshot = await db.collection('siswa').where('status', '==', 'Aktif').get();
            const classes = new Set();
            snapshot.forEach(doc => classes.add(doc.data().kelas));
            const sortedClasses = Array.from(classes).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));
            
            classSelectorHtml = `
                <h6 class="text-muted text-center mb-2">Pilih Kelas</h6>
                <div id="daily-recap-class-selector" class="text-center mb-4">
                    ${sortedClasses.map(c => `<button class="btn btn-outline-primary m-1 class-btn" data-kelas="${c}">${c}</button>`).join('')}
                </div>
                <hr>
            `;
        } catch (error) {
            mainContentArea.innerHTML = `<div class="alert alert-danger">Gagal memuat daftar kelas: ${error.message}</div>`;
            return;
        }
    }

    mainContentArea.innerHTML = `
        <div class="card">
            <div class="card-body">
                <h5 class="card-title text-center"><i class="fas fa-birthday-cake"></i> Cek Usia Siswa</h5>
                <p class="text-center text-muted small">Menghitung usia siswa pada akhir bulan yang dipilih.</p>
                ${classSelectorHtml}
                
                <div class="month-selector-container" style="position: relative;">
                    <div class="d-flex justify-content-center align-items-center my-3">
                        <button id="prev-month-btn" class="btn btn-light btn-lg"><i class="fas fa-chevron-left"></i></button>
                        <h4 id="current-month-display" class="mx-4 mb-0 font-weight-bold" style="width: 220px; text-align: center; cursor: pointer; user-select: none;" title="Klik untuk memilih bulan dan tahun"></h4>
                        <button id="next-month-btn" class="btn btn-light btn-lg"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    
                    <div id="month-year-selector" class="card shadow-lg" style="display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); z-index: 1000; width: 280px;">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <button id="selector-prev-year" class="btn btn-sm btn-outline-secondary">&lt;</button>
                                <span id="selector-current-year" class="font-weight-bold"></span>
                                <button id="selector-next-year" class="btn btn-sm btn-outline-secondary">&gt;</button>
                            </div>
                            <div id="selector-month-grid" class="row no-gutters"></div>
                        </div>
                    </div>
                </div>

                <div id="daily-recap-table-container" class="mt-3"></div>
            </div>
        </div>
    `;

    const monthDisplay = document.getElementById('current-month-display');
    const tableContainer = document.getElementById('daily-recap-table-container');
    const monthYearSelector = document.getElementById('month-year-selector');
    const selectorYearDisplay = document.getElementById('selector-current-year');
    const monthGrid = document.getElementById('selector-month-grid');

    const monthNames = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];

    const generateMonthGrid = () => {
        selectorYearDisplay.textContent = selectorYear;
        monthGrid.innerHTML = monthNames.map((name, index) => {
            const isSelected = (index === currentDate.getMonth() && selectorYear === currentDate.getFullYear());
            const btnClass = isSelected ? 'btn-primary' : 'btn-light';
            return `<div class="col-3 p-1"><button class="btn btn-sm btn-block ${btnClass}" data-month="${index}">${name}</button></div>`;
        }).join('');
    };

    const updateDisplayAndRender = () => {
        monthDisplay.textContent = currentDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
        if (selectedClass) {
            // Panggil fungsi render yang berbeda
            renderCekUsiaTable(selectedClass, currentDate.getFullYear(), currentDate.getMonth() + 1);
        } else {
            tableContainer.innerHTML = '<p class="text-muted text-center">Silakan pilih kelas untuk melihat data usia.</p>';
        }
    };

    // --- Event Listeners (Sama seperti sebelumnya) ---

    document.getElementById('prev-month-btn').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        updateDisplayAndRender();
    });
    document.getElementById('next-month-btn').addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        updateDisplayAndRender();
    });

    monthDisplay.addEventListener('click', (e) => {
        e.stopPropagation();
        const isHidden = monthYearSelector.style.display === 'none';
        if (isHidden) {
            selectorYear = currentDate.getFullYear();
            generateMonthGrid();
            monthYearSelector.style.display = 'block';
        } else {
            monthYearSelector.style.display = 'none';
        }
    });

    document.getElementById('selector-prev-year').addEventListener('click', () => { selectorYear--; generateMonthGrid(); });
    document.getElementById('selector-next-year').addEventListener('click', () => { selectorYear++; generateMonthGrid(); });

    monthGrid.addEventListener('click', (e) => {
        if (e.target.matches('[data-month]')) {
            currentDate.setFullYear(selectorYear, parseInt(e.target.dataset.month), 1);
            monthYearSelector.style.display = 'none';
            updateDisplayAndRender();
        }
    });

    window.addEventListener('click', (e) => {
        if (!monthYearSelector.contains(e.target) && e.target !== monthDisplay) {
            monthYearSelector.style.display = 'none';
        }
    });
    
    const classSelector = document.getElementById('daily-recap-class-selector');
    if (classSelector) {
        classSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('class-btn')) {
                document.querySelectorAll('.class-btn').forEach(btn => {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                });
                e.target.classList.remove('btn-outline-primary');
                e.target.classList.add('btn-primary');
                selectedClass = e.target.dataset.kelas;
                updateDisplayAndRender();
            }
        });
    }

    updateDisplayAndRender();
}


async function showUnscannedForm() {
    hideAllMainContentAreas(); // Panggil fungsi sembunyikan yang baru
    mainContentArea.style.display = 'block'; // Tampilkan mainContentArea
    mainContentArea.innerHTML = '<div class="text-center mt-4"><div class="spinner-border"></div><p>Mencari siswa belum absen...</p></div>';

    try {
        const today = new Date();
        const tglString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

        // 1. Ambil semua siswa aktif di kelas (1 Read)
        const classSnapshot = await db.collection('siswa')
            .where('kelas', '==', currentUser.kelasDiampu)
            .where('status', '==', 'Aktif')
            .get();

        const allSiswaMap = new Map(classSnapshot.docs.map(doc => [doc.data().nisn, doc.data()]));

        // 2. Ambil semua log absensi (hadir, sakit, izin, alfa) untuk hari ini dalam satu query (Multiple Reads, but efficient)
        const startOfDay = new Date(today.setHours(0, 0, 0, 0));
        const endOfDay = new Date(today.setHours(23, 59, 59, 999));

        const [absensiHarianSnapshot, logLainnyaSnapshot] = await Promise.all([
            db.collection('absensi_harian').where('kelas', '==', currentUser.kelasDiampu).where('tanggal', '==', tglString).get(),
            db.collection('log_absensi').where('kelas', '==', currentUser.kelasDiampu).where('timestamp', '>=', startOfDay).where('timestamp', '<=', endOfDay).get()
        ]);

        const scannedNisnSet = new Set();
        absensiHarianSnapshot.forEach(doc => scannedNisnSet.add(doc.data().nisn));
        logLainnyaSnapshot.forEach(doc => scannedNisnSet.add(doc.data().nisn));

        const unscannedSiswa = [];
        allSiswaMap.forEach((siswa, nisn) => {
            if (!scannedNisnSet.has(nisn)) {
                unscannedSiswa.push(siswa);
            }
        });

        if (unscannedSiswa.length === 0) {
            mainContentArea.innerHTML = '<div class="alert alert-success">Semua siswa di kelas Anda sudah tercatat kehadirannya hari ini.</div>';
            return;
        }

        let formHtml = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Input Absensi Siswa Tidak Hadir</h5>
                    <form id="unscannedForm">
                        <div class="table-responsive">
                            <table class="table table-sm">`;

        unscannedSiswa.sort((a, b) => (a.nomorAbsen || 999) - (b.nomorAbsen || 999)).forEach(siswa => {
            formHtml += `
                <tr>
                    <td>${siswa.nomorAbsen}. ${siswa.nama}</td>
                    <td>
                        <select class="form-control form-control-sm" data-nisn="${siswa.nisn}">
                            <option value="">-- Pilih Status --</option>
                            <option value="Sakit">Sakit</option>
                            <option value="Izin">Izin</option>
                            <option value="Tanpa Keterangan">Tanpa Keterangan</option>
                        </select>
                    </td>
                </tr>
            `;
        });

        formHtml += `
                            </table>
                        </div>
                        <button type="submit" class="btn btn-success mt-3"><i class="fas fa-save"></i> Simpan Semua</button>
                    </form>
                </div>
            </div>
        `;

        mainContentArea.innerHTML = formHtml;
        document.getElementById('unscannedForm').addEventListener('submit', saveUnscanned);

    } catch (error) {
        mainContentArea.innerHTML = `<div class="alert alert-danger">Gagal memuat daftar siswa: ${error.message}</div>`;
    }
}

async function showManualAttendanceForm() {
    hideAllMainContentAreas(); // Panggil fungsi sembunyikan yang baru
    mainContentArea.style.display = 'block'; // Tampilkan mainContentArea
    mainContentArea.innerHTML = `
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Input Absensi Manual (Lampau)</h5>
                <div class="form-group">
                    <label for="manual-date">Pilih Tanggal:</label>
                    <input type="date" id="manual-date" class="form-control" max="${new Date().toISOString().split("T")[0]}">
                </div>
                <div id="manual-student-list-container">
                    <p class="text-muted">Silakan pilih tanggal untuk menampilkan daftar siswa.</p>
                </div>
            </div>
        </div>`;

    const dateInput = document.getElementById('manual-date');
    dateInput.addEventListener('change', async function() {
        const selectedDateString = this.value;
        if (!selectedDateString) return;

        const studentListContainer = document.getElementById('manual-student-list-container');
        studentListContainer.innerHTML = '<div class="text-center mt-3"><div class="spinner-border"></div><p>Mencari siswa...</p></div>';

        try {
            // 1. Ambil semua siswa aktif di kelas (1 Read)
            const classSnapshot = await db.collection('siswa')
                .where('kelas', '==', currentUser.kelasDiampu)
                .where('status', '==', 'Aktif')
                .get();
            const allStudentsMap = new Map();
            classSnapshot.forEach(doc => allStudentsMap.set(doc.data().nisn, doc.data()));

            // 2. Ambil semua log absensi untuk tanggal yang dipilih secara bersamaan
            const selectedDate = new Date(selectedDateString);
            const startOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
            const endOfDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate(), 23, 59, 59);

            const [logSnapshot, harianSnapshot] = await Promise.all([
                db.collection('log_absensi').where('kelas', '==', currentUser.kelasDiampu).where('timestamp', '>=', startOfDay).where('timestamp', '<=', endOfDay).get(),
                db.collection('absensi_harian').where('kelas', '==', currentUser.kelasDiampu).where('tanggal', '==', selectedDateString).get()
            ]);

            const nisnWithLogs = new Set();
            logSnapshot.forEach(doc => nisnWithLogs.add(doc.data().nisn));
            harianSnapshot.forEach(doc => nisnWithLogs.add(doc.data().nisn));

            const studentsWithoutLogs = [];
            for (const [nisn, studentData] of allStudentsMap.entries()) {
                if (!nisnWithLogs.has(nisn)) {
                    studentsWithoutLogs.push(studentData);
                }
            }

            studentsWithoutLogs.sort((a, b) => (a.nomorAbsen || 999) - (b.nomorAbsen || 999));

            if (studentsWithoutLogs.length === 0) {
                studentListContainer.innerHTML = '<div class="alert alert-success">Semua siswa sudah memiliki catatan absensi pada tanggal tersebut.</div>';
                return;
            }

            let formHtml = `<form id="manualAttendanceForm"><div class="table-responsive"><table class="table table-sm">`;
            studentsWithoutLogs.forEach(siswa => {
                formHtml += `<tr>
                    <td>${siswa.nomorAbsen}. ${siswa.nama}</td>
                    <td>
                        <select class="form-control form-control-sm" data-nisn="${siswa.nisn}" data-nama="${siswa.nama}" data-kelas="${siswa.kelas}" data-noabsen="${siswa.nomorAbsen}">
                            <option value="Hadir" selected>Hadir</option>
                            <option value="Sakit">Sakit</option>
                            <option value="Izin">Izin</option>
                            <option value="Tanpa Keterangan">Tanpa Keterangan</option>
                        </select>
                    </td>
                </tr>`;
            });
            formHtml += '</table></div><button type="submit" class="btn btn-success mt-3"><i class="fas fa-save"></i> Simpan Absensi</button></form>';
            studentListContainer.innerHTML = formHtml;
            document.getElementById('manualAttendanceForm').addEventListener('submit', saveManualAttendance);

        } catch (error) {
            studentListContainer.innerHTML = `<div class="alert alert-danger">Gagal memuat daftar siswa: ${error.message}</div>`;
        }
    });
}

// =================================================================
// --- FUNGSI QUICK DASHBOARD (DENGAN PULANG) ---
// =================================================================
async function updateQuickDashboard() {
    // Ini akan dipanggil setelah login atau saat klik "Ringkasan Hari Ini"
    await renderDailySummary(); // Panggil fungsi untuk merender ringkasan harian
}
// =================================================================
// --- AKHIR FUNGSI REVISI TOTAL UNTUK QUICK DASHBOARD ---
// =================================================================

// =================================================================
// --- RENDER DAILY SUMMARY ---
// =================================================================

async function renderDailySummary() {
    dailySummaryDisplay.style.display = 'block';
    dailySummaryDisplay.innerHTML = '<div class="text-center"><span class="spinner-border spinner-border-sm"></span> Memuat ringkasan...</div>';

    const today = new Date();
    const tglString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

    try {
        let html = '';
        
        if (currentUser.role === 'walikelas') {
            // Logika untuk walikelas tidak berubah karena sudah efisien
            const mainTitle = `Ringkasan Absensi: Kelas ${currentUser.kelasDiampu}`;
            const rekapRef = db.collection('rekap_harian_per_kelas').doc(`${tglString}_${currentUser.kelasDiampu}`);
            const rekapDoc = await rekapRef.get();

            let data;

            if (rekapDoc.exists) {
                data = rekapDoc.data();
            } else {
                console.log(`Cache rekap harian untuk ${currentUser.kelasDiampu} tidak ditemukan, membuat...`);
                const siswaKelasSnapshot = await db.collection('siswa').where('kelas', '==', currentUser.kelasDiampu).where('status', '==', 'Aktif').get();
                const totalSiswa = siswaKelasSnapshot.size;

                data = {
                    totalSiswa: totalSiswa,
                    hadir: 0, pulang: 0, sakit: 0, izin: 0, alpha: 0,
                    belumAbsen: totalSiswa
                };
                await rekapRef.set(data);
                console.log("Cache rekap harian berhasil dibuat.");
            }
            
            html = `
                <div class="quick-summary-card global-summary-card">
                    <h5 class="summary-title"><i class="fas fa-calendar-day"></i> ${mainTitle}</h5>
                    <p class="summary-date">${today.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                    <div class="summary-metrics">
                        <div class="metric-item present"><span class="metric-value">${data.hadir}</span><span class="metric-label">Hadir</span></div>
                        <div class="metric-item return"><span class="metric-value">${data.pulang}</span><span class="metric-label">Pulang</span></div>
                        <div class="metric-item sick"><span class="metric-value">${data.sakit}</span><span class="metric-label">Sakit</span></div>
                        <div class="metric-item permission"><span class="metric-value">${data.izin}</span><span class="metric-label">Izin</span></div>
                        <div class="metric-item absent"><span class="metric-value">${data.alpha}</span><span class="metric-label">Alfa</span></div>
                        <div class="metric-item pending"><span class="metric-value">${data.belumAbsen}</span><span class="metric-label">Belum Absen</span></div>
                    </div>
                    <p class="text-muted small mt-3 text-center">Total ${data.totalSiswa} siswa terdaftar di kelas ini.</p>
                </div>
            `;

        } else { 
            // --- INI ADALAH BAGIAN YANG DIOPTIMALKAN UNTUK ADMIN ---
            const mainTitle = 'Ringkasan Absensi Seluruh Sekolah';

            // 1. Langsung ambil SEMUA rekap harian yang ada untuk hari ini (Sangat efisien, hanya beberapa reads)
            const rekapQuery = db.collection('rekap_harian_per_kelas').where(firebase.firestore.FieldPath.documentId(), '>=', tglString).where(firebase.firestore.FieldPath.documentId(), '<', tglString + 'z');
            const rekapSnapshot = await rekapQuery.get();

            // 2. Agregasi data dari dokumen yang ada
            let totalData = { totalSiswa: 0, hadir: 0, pulang: 0, sakit: 0, izin: 0, alpha: 0, belumAbsen: 0 };
            const classSummaries = {};

            if (!rekapSnapshot.empty) {
                rekapSnapshot.forEach(doc => {
                    const data = doc.data();
                    const kelas = doc.id.split('_')[1];
                    classSummaries[kelas] = data;

                    // Jumlahkan setiap field, TERMASUK totalSiswa
                    Object.keys(totalData).forEach(key => {
                        totalData[key] += (data[key] || 0);
                    });
                });
            }

            // 3. Render HTML dengan data yang sudah diagregasi
            html = `
                <div class="quick-summary-card global-summary-card">
                    <h5 class="summary-title"><i class="fas fa-calendar-day"></i> ${mainTitle}</h5>
                    <p class="summary-date">${today.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                    <div class="summary-metrics">
                         <div class="metric-item present"><span class="metric-value">${totalData.hadir}</span><span class="metric-label">Hadir</span></div>
                        <div class="metric-item return"><span class="metric-value">${totalData.pulang}</span><span class="metric-label">Pulang</span></div>
                        <div class="metric-item sick"><span class="metric-value">${totalData.sakit}</span><span class="metric-label">Sakit</span></div>
                        <div class="metric-item permission"><span class="metric-value">${totalData.izin}</span><span class="metric-label">Izin</span></div>
                        <div class="metric-item absent"><span class="metric-value">${totalData.alpha}</span><span class="metric-label">Alfa</span></div>
                        <div class="metric-item pending"><span class="metric-value">${totalData.belumAbsen}</span><span class="metric-label">Belum Absen</span></div>
                    </div>
                    <p class="text-muted small mt-3 text-center">Total ${totalData.totalSiswa} siswa dari seluruh kelas.</p>
                </div>
            `;

            html += `
                <div class="quick-summary-card class-details-card mt-4">
                    <h5 class="summary-title mb-3"><i class="fas fa-chalkboard-teacher"></i> Detail Absensi Per Kelas</h5>
                    <div class="accordion" id="classAccordion">
            `;
            const sortedKelas = Object.keys(classSummaries).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
            
            if (sortedKelas.length === 0) {
                 html += '<p class="text-muted text-center p-3">Belum ada data absensi yang masuk untuk hari ini.</p>';
            } else {
                sortedKelas.forEach((kelas) => {
                    const classData = classSummaries[kelas];
                    const classId = kelas.replace(/\s+/g, '-').toLowerCase();
                    html += `
                        <div class="card class-accordion-item">
                            <div class="card-header" id="heading${classId}">
                                <h2 class="mb-0">
                                    <button class="btn btn-block text-left d-flex justify-content-between align-items-center" type="button" data-toggle="collapse" data-target="#collapse${classId}" aria-expanded="false">
                                        Kelas ${kelas}
                                        <span class="badge badge-primary">${classData.hadir || 0}/${classData.totalSiswa || 0} Hadir</span>
                                        <i class="fas fa-chevron-down accordion-icon"></i>
                                    </button>
                                </h2>
                            </div>
                            <div id="collapse${classId}" class="collapse" data-parent="#classAccordion">
                                <div class="card-body">
                                    <div class="summary-metrics compact-metrics">
                                        <div class="metric-item present"><span class="metric-value">${classData.hadir || 0}</span><span class="metric-label">Hadir</span></div>
                                        <div class="metric-item return"><span class="metric-value">${classData.pulang || 0}</span><span class="metric-label">Pulang</span></div>
                                        <div class="metric-item sick"><span class="metric-value">${classData.sakit || 0}</span><span class="metric-label">Sakit</span></div>
                                        <div class="metric-item permission"><span class="metric-value">${classData.izin || 0}</span><span class="metric-label">Izin</span></div>
                                        <div class="metric-item absent"><span class="metric-value">${classData.alpha || 0}</span><span class="metric-label">Alfa</span></div>
                                        <div class="metric-item pending"><span class="metric-value">${classData.belumAbsen || 0}</span><span class="metric-label">Belum Absen</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
        }

        dailySummaryDisplay.innerHTML = html;

    } catch (error) {
        console.error("Error rendering daily summary:", error);
        dailySummaryDisplay.innerHTML = `<div class="alert alert-danger text-center">Gagal memuat ringkasan: ${error.message}</div>`;
    }
}


// =================================================================
// --- AKHIR FUNGSI RENDER DAILY SUMMARY ---
// =================================================================

// =================================================================
// --- FUNGSI LENGKAP UNTUK REKAP, UNSCANNED, EDIT (SEBELUMNYA DI CONTENT-CONTAINER) ---
// Sekarang akan dirender di 'rekap-content' atau 'mainContentArea'
// =================================================================

// GANTI FUNGSI fetchRekap() DENGAN VERSI FINAL INI
async function fetchRekap(semester) {
    const viewContainer = document.getElementById(`rekap-semester-view-container-${semester}`);
    if (!viewContainer) return;
    
    viewContainer.innerHTML = '<div class="text-center mt-4"><div class="spinner-border"></div><p>Memuat rekap...</p></div>';
    
    try {
        const currentYear = new Date().getFullYear();
        
        // Langkah 1 & 2: Pengambilan data siswa dan penanganan cache (tidak ada perubahan)
        let siswaQuery = db.collection('siswa').where('status', '==', 'Aktif');
        if (currentUser.role === 'walikelas') {
            siswaQuery = siswaQuery.where('kelas', '==', currentUser.kelasDiampu);
        }
        const siswaSnapshot = await siswaQuery.get();

        if (siswaSnapshot.empty) {
            viewContainer.innerHTML = '<div class="alert alert-info mt-3">Tidak ada siswa aktif untuk ditampilkan.</div>';
            return;
        }

        const allRelevantSiswa = siswaSnapshot.docs.map(doc => doc.data());
        const expectedCacheIds = allRelevantSiswa.map(s => `${s.nisn}_${currentYear}_${semester}`);
        
        if (expectedCacheIds.length > 0) {
            const cacheBatch = db.batch();
            let cacheNeedsUpdate = false;
            const existingCacheDocs = [];
            const promises = [];
            for (let i = 0; i < expectedCacheIds.length; i += 10) {
                const chunk = expectedCacheIds.slice(i, i + 10);
                promises.push(
                    db.collection('cache_rekap_semester')
                      .where(firebase.firestore.FieldPath.documentId(), 'in', chunk)
                      .get()
                );
            }
            const snapshotResults = await Promise.all(promises);
            snapshotResults.forEach(snapshot => snapshot.docs.forEach(doc => existingCacheDocs.push(doc)));
            const existingCacheIds = new Set(existingCacheDocs.map(doc => doc.id));
            allRelevantSiswa.forEach(siswa => {
                const cacheId = `${siswa.nisn}_${currentYear}_${semester}`;
                if (!existingCacheIds.has(cacheId)) {
                    const cacheRef = db.collection('cache_rekap_semester').doc(cacheId);
                    cacheBatch.set(cacheRef, {
                        nisn: siswa.nisn, nama: siswa.nama, kelas: siswa.kelas,
                        nomorAbsen: siswa.nomorAbsen || 0, tahun: currentYear, semester: semester,
                        totalSakit: 0, totalIzin: 0, totalAlpha: 0, detailAbsensi: []
                    });
                    cacheNeedsUpdate = true;
                }
            });
            if (cacheNeedsUpdate) await cacheBatch.commit();
        }

        // Langkah 3: Ambil ulang data dari cache (tidak ada perubahan)
        let rekapQuery = db.collection('cache_rekap_semester')
            .where('tahun', '==', currentYear)
            .where('semester', '==', semester);
        if (currentUser.role === 'walikelas') {
            rekapQuery = rekapQuery.where('kelas', '==', currentUser.kelasDiampu);
        }
        const rekapSnapshot = await rekapQuery.get();
        const rekapSiswaByClass = {};
        rekapSnapshot.forEach(doc => {
            const rekapData = doc.data();
            if (!rekapSiswaByClass[rekapData.kelas]) rekapSiswaByClass[rekapData.kelas] = [];
            rekapSiswaByClass[rekapData.kelas].push({
                nisn: rekapData.nisn, nama: rekapData.nama, nomorAbsen: rekapData.nomorAbsen,
                kelas: rekapData.kelas,
                total: { sakit: rekapData.totalSakit || 0, izin: rekapData.totalIzin || 0, alpha: rekapData.totalAlpha || 0 },
                detailUntukEdit: rekapData.detailAbsensi || []
            });
        });

        fullRekapData = { ...fullRekapData, ...rekapSiswaByClass };
        
        // Langkah 4: Render UI yang sudah direvisi (tanpa card tambahan)
        const kelasKeys = Object.keys(rekapSiswaByClass).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
        let classSelectorHtml = '';

        if (currentUser.role !== 'walikelas' && kelasKeys.length > 0) {
            classSelectorHtml = `
                <h6 class="text-muted text-center mb-2">Pilih Kelas</h6>
                <div id="rekap-class-selector-${semester}" class="text-center mb-4">
                    ${kelasKeys.map(k => `<button class="btn btn-outline-primary m-1 class-btn" data-kelas="${k}" data-semester="${semester}">${k}</button>`).join('')}
                </div>
                <hr>
            `;
        }
        
        // *** PERUBAHAN UTAMA DI SINI: <div class="card"> telah dihapus ***
        viewContainer.innerHTML = `
            ${classSelectorHtml}
            <div id="rekap-semester-table-container-${semester}" class="mt-3">
                ${currentUser.role === 'walikelas' ? '' : '<p class="text-muted text-center">Silakan pilih kelas untuk melihat rekap.</p>'}
            </div>
        `;
        
        if (currentUser.role === 'walikelas') {
            const tableContainer = document.getElementById(`rekap-semester-table-container-${semester}`);
            const siswaData = rekapSiswaByClass[currentUser.kelasDiampu] || [];
            // Fungsi renderTable() sudah membuat card-nya sendiri, jadi tidak perlu pembungkus tambahan
            tableContainer.innerHTML = renderTable(siswaData, `Rekap Kelas ${currentUser.kelasDiampu} - Semester ${semester}`);
        }
        
        addRekapSemesterClassSelectorListeners(semester);

    } catch (error) {
        console.error("Error fetching semester recap:", error);
        viewContainer.innerHTML = `<div class="alert alert-danger mt-3">Gagal memuat rekap: ${error.message}</div>`;
    }
}

// TAMBAHKAN FUNGSI BARU INI
function addRekapSemesterClassSelectorListeners(semester) {
    const selectorContainer = document.getElementById(`rekap-class-selector-${semester}`);
    if (!selectorContainer) return; // Keluar jika pemilih tidak ada (misal untuk walikelas)

    selectorContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('class-btn')) {
            const selectedKelas = e.target.dataset.kelas;
            const sem = e.target.dataset.semester;

            // Perbarui UI tombol aktif
            selectorContainer.querySelectorAll('.class-btn').forEach(btn => {
                btn.classList.remove('btn-primary', 'font-weight-bold');
                btn.classList.add('btn-outline-primary');
            });
            e.target.classList.remove('btn-outline-primary');
            e.target.classList.add('btn-primary', 'font-weight-bold');
            
            // Render tabel untuk kelas yang dipilih
            const tableContainer = document.getElementById(`rekap-semester-table-container-${sem}`);
            const siswaData = fullRekapData[selectedKelas] || [];
            tableContainer.innerHTML = renderTable(siswaData, `Rekap Kelas ${selectedKelas} - Semester ${sem}`);
        }
    });
}



function renderTable(dataSiswa, title) {
    if (!dataSiswa || dataSiswa.length === 0) return '<div class="alert alert-info">Tidak ada data siswa aktif di kelas ini.</div>';
    let tableHtml = `<div class="card"><div class="card-body"><h5 class="card-title">${title}</h5><p class="card-text small text-muted">Klik nama siswa untuk melihat rincian & melakukan koreksi.</p><div class="table-responsive"><table class="table table-hover table-sm"><thead><tr><th>No</th><th>Nama Siswa</th><th>Sakit</th><th>Izin</th><th>Alfa</th></tr></thead><tbody>`;
    dataSiswa.sort((a,b) => a.nomorAbsen - b.nomorAbsen).forEach(s => {
        tableHtml += `<tr onclick="toggleDetails('${s.nisn}')" style="cursor: pointer;"><td>${s.nomorAbsen}</td><td><span class="student-name">${s.nama}</span></td><td>${s.total.sakit}</td><td>${s.total.izin}</td><td>${s.total.alpha}</td></tr><tr id="detail-${s.nisn}" class="details-row" style="display: none;"><td colspan="5"><div class="details-content"></div></td></tr>`;
    });
    tableHtml += '</tbody></table></div></div></div>';
    return tableHtml;
}

function toggleDetails(nisn) {
    const targetRow = document.getElementById(`detail-${nisn}`);
    const wasOpen = targetRow.style.display !== 'none';
    document.querySelectorAll('.details-row').forEach(row => row.style.display = 'none');
    if (!wasOpen) {
        targetRow.style.display = 'table-row';
        const detailCell = targetRow.querySelector('.details-content');
        if (detailCell.innerHTML.trim() === '') detailCell.innerHTML = renderDetailContent(findSiswaByNisn(nisn));
    }
}

function findSiswaByNisn(nisn) {
    for (const kelas in fullRekapData) if (Array.isArray(fullRekapData[kelas])) {
        const siswa = fullRekapData[kelas].find(s => s.nisn === nisn); if (siswa) return siswa;
    } return null;
}

function renderDetailContent(siswa) {
    if (!siswa.detailUntukEdit || siswa.detailUntukEdit.length === 0) return '<div class="alert alert-light">Tidak ada catatan ketidakhadiran untuk dikoreksi.</div>';
    
    // --- PERBAIKAN DI SINI: Mengganti semua 'd.docId' menjadi 'd.logId' ---
    let html = '<table class="table table-bordered table-sm"><thead><tr><th>Tanggal</th><th>Status</th>';
    if(currentUser.canEdit) html += '<th>Aksi</th>';
    html += '</tr></thead><tbody>';
    
    siswa.detailUntukEdit.sort((a,b) => new Date(b.tanggal) - new Date(a.tanggal)).forEach(d => {
        // ID baris menggunakan d.logId
        html += `<tr id="row-${d.logId}"><td>${d.tanggal}</td><td class="status-cell">${d.status}</td>`;
        if(currentUser.canEdit) {
            // Tombol Edit memanggil toggleEditMode dengan d.logId
            html += `<td class="action-cell"><button onclick="event.stopPropagation(); toggleEditMode('${d.logId}', '${d.status}')" class="btn btn-warning btn-sm" title="Edit"><i class="fas fa-edit"></i></button></td>`;
        }
        html += `</tr>`;
    });
    
    html += '</tbody></table>'; 
    return html;
}

function toggleEditMode(logId, currentStatus) { // Argumen diubah namanya menjadi logId untuk kejelasan
    const row = document.getElementById(`row-${logId}`);
    row.dataset.originalStatus = currentStatus;
    row.querySelector('.status-cell').innerHTML = `<select id="select-${logId}" class="form-control form-control-sm"><option value="Sakit">Sakit</option><option value="Izin">Izin</option><option value="Tanpa Keterangan">Tanpa Keterangan</option></select>`;
    row.querySelector(`#select-${logId}`).value = currentStatus;
    // Panggilan ke saveEdit dan cancelEdit sekarang pasti menggunakan logId yang benar
    row.querySelector('.action-cell').innerHTML = `<button onclick="event.stopPropagation(); saveEdit('${logId}')" class="btn btn-success btn-sm" title="Simpan"><i class="fas fa-save"></i></button> <button onclick="event.stopPropagation(); cancelEdit('${logId}')" class="btn btn-secondary btn-sm" title="Batal"><i class="fas fa-times"></i></button>`;
}

function cancelEdit(logId) { // Argumen diubah namanya menjadi logId untuk kejelasan
    const row = document.getElementById(`row-${logId}`);
    const originalStatus = row.dataset.originalStatus;
    row.querySelector('.status-cell').textContent = originalStatus;
    row.querySelector('.action-cell').innerHTML = `<button onclick="event.stopPropagation(); toggleEditMode('${logId}', '${originalStatus}')" class="btn btn-warning btn-sm" title="Edit"><i class="fas fa-edit"></i></button>`;
}

// Fungsi untuk membuka modal koreksi status harian (Dipanggil dari tombol "Edit" di showDailyCorrectionForm)
function openCorrectionModalForDailyStatus(docId, nisn, nama, kelas, currentStatus) {
    document.getElementById('dailyCorrectionStudentName').textContent = nama;
    document.getElementById('dailyCorrectionStudentClass').textContent = `Kelas ${kelas}`;
    document.getElementById('dailyCorrectionCurrentStatusDisplay').textContent = currentStatus; // Menampilkan status saat ini
    document.getElementById('dailyCorrectionNisn').value = nisn;
    document.getElementById('dailyCorrectionOriginalStatus').value = currentStatus; // Simpan status asli
    document.getElementById('dailyCorrectionLogId').value = docId; // Ini adalah ID dokumen log_absensi yang akan diupdate
    
    // Atur nilai dropdown ke status saat ini
    const statusSelect = document.getElementById('dailyCorrectionStatusSelect');
    statusSelect.value = currentStatus;

    $('#dailyCorrectionModal').modal('show');
}

// GANTI KESELURUHAN FUNGSI INI

async function saveEdit(docId) {
    const actionCell = document.getElementById(`row-${docId}`).querySelector('.action-cell');
    actionCell.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
    
    const newStatus = document.getElementById(`select-${docId}`).value;
    const logRef = db.collection('log_absensi').doc(docId);

    try {
        const logDoc = await logRef.get();
        if (!logDoc.exists) throw new Error("Dokumen log tidak ditemukan!");
        
        const logData = logDoc.data();
        const oldStatus = logData.status;

        if (oldStatus === newStatus) {
            cancelEdit(docId);
            return;
        }

        const timestamp = logData.timestamp.toDate();
        const tglString = `${timestamp.getFullYear()}-${(timestamp.getMonth() + 1).toString().padStart(2, '0')}-${timestamp.getDate().toString().padStart(2, '0')}`;
        const year = timestamp.getFullYear();
        const month = timestamp.getMonth() + 1;
        const day = timestamp.getDate();
        
        const batch = db.batch();

        // 1. Update log absensi
        batch.update(logRef, { status: newStatus });

        // 2. Update rekap harian (untuk ringkasan/dashboard)
        const rekapHarianRef = db.collection('rekap_harian_per_kelas').doc(`${tglString}_${logData.kelas}`);
        const oldFieldHarian = oldStatus === 'Tanpa Keterangan' ? 'alpha' : oldStatus.toLowerCase();
        const newFieldHarian = newStatus === 'Tanpa Keterangan' ? 'alpha' : newStatus.toLowerCase();

        // --- PERBAIKAN UTAMA ADA DI SINI ---
        // Sebelum update, pastikan dokumen rekap harian ada dengan "set merge".
        // Ini akan membuat dokumen kosong jika tidak ada, tanpa menimpa data jika sudah ada.
        batch.set(rekapHarianRef, {}, { merge: true });
        // --- AKHIR PERBAIKAN ---
        
        batch.update(rekapHarianRef, {
            [oldFieldHarian]: firebase.firestore.FieldValue.increment(-1),
            [newFieldHarian]: firebase.firestore.FieldValue.increment(1)
        });

        // 3. Update rekap bulanan (detail per siswa)
        const rekapBulananRef = db.collection('rekap_bulanan').doc(`${logData.nisn}_${year}-${month}`);
        batch.update(rekapBulananRef, { absensi: firebase.firestore.FieldValue.arrayRemove({ tanggal: tglString, status: oldStatus, logId: docId }) });
        batch.update(rekapBulananRef, { absensi: firebase.firestore.FieldValue.arrayUnion({ tanggal: tglString, status: newStatus, logId: docId }) });

        // 4. Update agregat bulanan (sumber data untuk tabel "Rekap Harian")
        const agregatBulananRef = db.collection('agregat_bulanan_kelas').doc(`${logData.kelas}-${year}-${month}`);
        batch.set(agregatBulananRef, { kelas: logData.kelas, tahun: year, bulan: month }, { merge: true });
        batch.update(agregatBulananRef, {
            [`rekap.tgl_${day}.${oldFieldHarian}`]: firebase.firestore.FieldValue.increment(-1),
            [`rekap.tgl_${day}.${newFieldHarian}`]: firebase.firestore.FieldValue.increment(1)
        });
        
        // 5. Update Rekap Ketidakhadiran Harian (sumber data untuk "Catatan Absen Harian")
        const dailyRecapRef = db.collection('rekap_ketidakhadiran_harian').doc(`${tglString}_${logData.kelas}`);
        const oldDailyRecapData = {
            nisn: logData.nisn,
            nama: logData.nama,
            nomorAbsen: logData.nomorAbsen || 0,
            status: oldStatus
        };
        const newDailyRecapData = {
            nisn: logData.nisn,
            nama: logData.nama,
            nomorAbsen: logData.nomorAbsen || 0,
            status: newStatus
        };
        batch.update(dailyRecapRef, { siswa: firebase.firestore.FieldValue.arrayRemove(oldDailyRecapData) });
        batch.update(dailyRecapRef, { siswa: firebase.firestore.FieldValue.arrayUnion(newDailyRecapData) });

        // 6. Update cache semester
        await updateSemesterCache(batch, {
            nisn: logData.nisn,
            nama: logData.nama,
            kelas: logData.kelas,
            nomorAbsen: logData.nomorAbsen || 0,
            newStatus: newStatus,
            dateObject: timestamp,
            logId: docId,
            isCorrection: true,
            oldStatus: oldStatus
        });

        await batch.commit();
        
        Toastify({ text: 'Perubahan berhasil disimpan!', duration: 2000, style: { background: "#4CAF50" } }).showToast();
        
        const activeTab = document.querySelector('#semesterPills .nav-link.active');
        if (activeTab) {
            await fetchRekap(activeTab.id === 'semester1-tab' ? 1 : 2);
        }

    } catch (error) {
        Toastify({ text: 'Gagal menyimpan perubahan: ' + error.message, duration: 3000, style: { background: "#dc3545" } }).showToast();
        console.error("Error saving edit from semester recap:", error);
        cancelEdit(docId);
    }
}

// GANTI FUNGSI INI
async function saveUnscanned(e) {
    e.preventDefault();
    const button = this.querySelector('button');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';
    
    const selections = this.querySelectorAll('select');
    const absensiData = Array.from(selections).map(select => ({ nisn: select.dataset.nisn, status: select.value })).filter(item => item.status !== "");
    
    if (absensiData.length === 0) {
        Toastify({ text: 'Tidak ada status yang dipilih untuk disimpan.', duration: 3000, gravity: "top", position: "center", style: { background: "#ffc107" } }).showToast();
        button.disabled = false; button.innerHTML = '<i class="fas fa-save"></i> Simpan Semua';
        return;
    }

    try {
        const today = new Date();
        const tglString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
        const year = today.getFullYear(), month = today.getMonth() + 1, day = today.getDate();
        const rekapKelasRef = db.collection('rekap_harian_per_kelas').doc(`${tglString}_${currentUser.kelasDiampu}`);
        
        const batch = db.batch();
        const siswaSnapshot = await db.collection('siswa').where('kelas', '==', currentUser.kelasDiampu).where('status', '==', 'Aktif').get();
        const siswaMap = new Map(siswaSnapshot.docs.map(doc => [doc.data().nisn, doc.data()]));
        
        const rekapDoc = await rekapKelasRef.get();
        if (!rekapDoc.exists) {
            batch.set(rekapKelasRef, { totalSiswa: siswaSnapshot.size, hadir: 0, pulang: 0, sakit: 0, izin: 0, alpha: 0, belumAbsen: siswaSnapshot.size });
        }

        for (const absen of absensiData) {
            const siswaInfo = siswaMap.get(absen.nisn);
            if (siswaInfo) {
                const logRef = db.collection('log_absensi').doc();
                const fieldToIncrement = absen.status === 'Tanpa Keterangan' ? 'alpha' : absen.status.toLowerCase();
                
                batch.set(logRef, { 
                    nisn: siswaInfo.nisn, 
                    nama: siswaInfo.nama, 
                    kelas: siswaInfo.kelas, 
                    nomorAbsen: siswaInfo.nomorAbsen || null,
                    status: absen.status, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                });
                
                batch.update(rekapKelasRef, { [fieldToIncrement]: firebase.firestore.FieldValue.increment(1), belumAbsen: firebase.firestore.FieldValue.increment(-1) });
                
                const rekapBulananRef = db.collection('rekap_bulanan').doc(`${siswaInfo.nisn}_${year}-${month}`);
                const detailAbsen = { tanggal: tglString, status: absen.status, logId: logRef.id };
                batch.set(rekapBulananRef, { nisn: siswaInfo.nisn, nama: siswaInfo.nama, kelas: siswaInfo.kelas, tahun: year, bulan: month }, { merge: true });
                batch.update(rekapBulananRef, { absensi: firebase.firestore.FieldValue.arrayUnion(detailAbsen) });

                // --- PERBAIKAN TYPO DI SINI ---
                const statusFieldAgregat = absen.status === 'Tanpa Keterangan' ? 'alpha' : absen.status.toLowerCase();
                const agregatDocId = `${siswaInfo.kelas}-${year}-${month}`;
                const agregatRef = db.collection('agregat_bulanan_kelas').doc(agregatDocId);
                batch.set(agregatRef, { kelas: siswaInfo.kelas, tahun: year, bulan: month }, { merge: true });
                batch.update(agregatRef, { [`rekap.tgl_${day}.${statusFieldAgregat}`]: firebase.firestore.FieldValue.increment(1) });
                // --- AKHIR PERBAIKAN ---

                await updateSemesterCache(batch, {
                    nisn: siswaInfo.nisn,
                    nama: siswaInfo.nama,
                    kelas: siswaInfo.kelas,
                    nomorAbsen: siswaInfo.nomorAbsen,
                    newStatus: absen.status,
                    dateObject: today,
                    logId: logRef.id
                });

                await updateDailyAbsenceRecap(batch, {
                    nisn: siswaInfo.nisn,
                    nama: siswaInfo.nama,
                    nomorAbsen: siswaInfo.nomorAbsen,
                    kelas: siswaInfo.kelas,
                    status: absen.status,
                    tanggal: tglString
                });
                
                await kirimDataAbsensiKeSheet(siswaInfo.nisn, absen.status);
            }
        }
        
        await batch.commit();
        Toastify({ text: 'Data berhasil disimpan!', duration: 3000, gravity: "top", position: "center", style: { background: "#4CAF50" } }).showToast();
        showQuickSummary();

    } catch (error) {
        Toastify({ text: `Gagal menyimpan: ${error.message}`, duration: 3000, gravity: "top", position: "center", style: { background: "#dc3545" } }).showToast();
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-save"></i> Simpan Semua';
    }
}

// --- FUNGSI UNTUK MENGIRIM DATA KE GOOGLE APPS SCRIPT (WEB APP) ---
// Mengadopsi metode FormData seperti yang berhasil di form kontak Anda
async function kirimDataAbsensiKeSheet(nisn, statusAbsensi) {
    const urlAppsScript = "https://script.google.com/macros/s/AKfycbxcAr6Zq7u2ENykUbUhqCn4d92UNoG1OFj8IS1rbKpoW8Gpxal--y3tgyGmbdoMMKZFmw/exec"; // GANTI DENGAN URL WEB APP ANDA DARI BAGIAN `doPost`
    
    // Buat objek FormData baru
    const formData = new FormData();
    formData.append('nisn', nisn);
    formData.append('statusAbsensi', statusAbsensi);
    // Jika Anda ingin mengirim data lain dari siswa, tambahkan di sini juga
    // formData.append('namaSiswa', namaSiswa); 
    // formData.append('kelasSiswa', kelasSiswa); 
    // formData.append('waktuAbsen', waktuAbsen); // Waktu absen bisa diambil di Apps Script
    // Karena Apps Script akan melakukan VLOOKUP, cukup NISN dan StatusAbsensi

    try {
        const response = await fetch(urlAppsScript, {
            method: 'POST',
            body: formData // Menggunakan FormData
            // Hapus 'headers' jika menggunakan FormData, karena browser otomatis mengaturnya
            // headers: {
            //     'Content-Type': 'application/json' 
            // }
        });
        const result = await response.text(); 
        console.log('Respons dari Apps Script (kirimDataAbsensiKeSheet):', result);
        // Toastify bisa ditambahkan di sini jika perlu konfirmasi ke user
        // Toastify({ text: "Notifikasi WA diproses.", duration: 2000, style: { background: "#2196F3" } }).showToast();
    } catch (error) {
        console.error('Error saat mengirim data ke Apps Script:', error);
        // Toastify({ text: "Gagal memicu notifikasi WA.", duration: 3000, style: { background: "#ff5722" } }).showToast();
    }
}

async function saveManualAttendance(e) {
    e.preventDefault();
    const button = this.querySelector('button');
    const selectedDateString = document.getElementById('manual-date').value;

    if (!selectedDateString) {
        alert('Silakan pilih tanggal terlebih dahulu!');
        return;
    }
    
    const today = new Date();
    const todayString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
    if(selectedDateString === todayString) {
        alert("Input manual hanya untuk tanggal yang sudah berlalu. Untuk hari ini, gunakan menu 'Siswa Tidak Hadir'.");
        return;
    }

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';

    try {
        const selectedDate = new Date(selectedDateString);
        selectedDate.setHours(8, 0, 0, 0);
        const firebaseTimestamp = firebase.firestore.Timestamp.fromDate(selectedDate);
        const year = selectedDate.getFullYear(), month = selectedDate.getMonth() + 1, day = selectedDate.getDate();

        const selections = this.querySelectorAll('select');
        const absensiData = Array.from(selections)
            .map(select => ({
                nisn: select.dataset.nisn, nama: select.dataset.nama,
                kelas: select.dataset.kelas, nomorAbsen: select.dataset.noabsen,
                status: select.value
            }))
            .filter(item => item.status !== 'Hadir');
        
        if (absensiData.length === 0) {
            alert("Tidak ada data absensi (Sakit/Izin/Alfa) untuk disimpan.");
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-save"></i> Simpan Absensi';
            return;
        }

        const batch = db.batch();
        
        for (const absen of absensiData) {
            const logRef = db.collection('log_absensi').doc();
            batch.set(logRef, {
                nisn: absen.nisn, nama: absen.nama, kelas: absen.kelas,
                nomorAbsen: parseInt(absen.nomorAbsen) || null,
                status: absen.status,
                timestamp: firebaseTimestamp, dicatatOleh: currentUser.name
            });

            const rekapBulananRef = db.collection('rekap_bulanan').doc(`${absen.nisn}_${year}-${month}`);
            const detailAbsen = { tanggal: selectedDateString, status: absen.status, logId: logRef.id };
            batch.set(rekapBulananRef, { nisn: absen.nisn, nama: absen.nama, kelas: absen.kelas, tahun: year, bulan: month }, { merge: true });
            batch.update(rekapBulananRef, { absensi: firebase.firestore.FieldValue.arrayUnion(detailAbsen) });

            // --- PERBAIKAN TYPO DI SINI ---
            const statusFieldAgregat = absen.status === 'Tanpa Keterangan' ? 'alpha' : absen.status.toLowerCase();
            const agregatDocId = `${absen.kelas}-${year}-${month}`;
            const agregatRef = db.collection('agregat_bulanan_kelas').doc(agregatDocId);
            batch.set(agregatRef, { kelas: absen.kelas, tahun: year, bulan: month }, { merge: true });
            batch.update(agregatRef, { [`rekap.tgl_${day}.${statusFieldAgregat}`]: firebase.firestore.FieldValue.increment(1) });
            // --- AKHIR PERBAIKAN ---

            await updateSemesterCache(batch, {
                nisn: absen.nisn,
                nama: absen.nama,
                kelas: absen.kelas,
                nomorAbsen: parseInt(absen.nomorAbsen),
                newStatus: absen.status,
                dateObject: selectedDate,
                logId: logRef.id
            });

            await updateDailyAbsenceRecap(batch, {
                nisn: absen.nisn,
                nama: absen.nama,
                nomorAbsen: parseInt(absen.nomorAbsen),
                kelas: absen.kelas,
                status: absen.status,
                tanggal: selectedDateString
            });
        }

        await batch.commit();
        Toastify({ text: `Berhasil menyimpan absensi lampau.`, duration: 3000, gravity: "top", position: "center", style: { background: "#4CAF50" } }).showToast();
        showQuickSummary();

    } catch (error) {
        alert(`Gagal menyimpan: ${error.message}`);
    } finally {
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-save"></i> Simpan Absensi';
    }
}

// --- NEW FEATURE: KOREKSI KETIDAKHADIRAN HARI INI ---
async function showDailyCorrectionForm() {
    // Sembunyikan area konten lain dan tampilkan area utama
    hideAllMainContentAreas(); // Panggil fungsi sembunyikan yang baru
    mainContentArea.style.display = 'block'; // Tampilkan mainContentArea
    mainContentArea.innerHTML = '<div class="text-center mt-4"><div class="spinner-border"></div><p>Memuat daftar siswa untuk koreksi...</p></div>';

    try {
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
        const tglString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;

        // Query log_absensi untuk siswa di kelas ini dengan status S/I/A hari ini
        const logsSnapshot = await db.collection('log_absensi')
            .where('kelas', '==', currentUser.kelasDiampu)
            .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
            .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endOfDay))
            .where('status', 'in', ['Sakit', 'Izin', 'Tanpa Keterangan'])
            // --- PERBAIKAN DI SINI ---
            .orderBy('timestamp') // Urutkan berdasarkan timestamp terlebih dahulu
            .orderBy('nama')      // Kemudian, urutkan berdasarkan nama (opsional, jika ingin urutan kedua)
            // --- AKHIR PERBAIKAN ---
            .get();

        const studentsToCorrect = [];
        logsSnapshot.forEach(doc => {
            const data = doc.data();
            studentsToCorrect.push({
                docId: doc.id, // Penting untuk update nanti
                nisn: data.nisn,
                nama: data.nama,
                kelas: data.kelas,
                status: data.status,
                timestamp: data.timestamp // Biarkan timestamp asli dari log
            });
        });

        if (studentsToCorrect.length === 0) {
            mainContentArea.innerHTML = '<div class="alert alert-info mt-4">Tidak ada siswa dengan status Sakit, Izin, atau Tanpa Keterangan yang tercatat hari ini.</div>';
            return;
        }

        let tableHtml = `
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Daftar Siswa untuk Koreksi Ketidakhadiran (${today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })})</h5>
                    <p class="card-text text-muted">Hanya menampilkan siswa dengan status Sakit, Izin, atau Tanpa Keterangan.</p>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Nama Siswa</th>
                                    <th>Status Saat Ini</th>
                                    <th>Waktu Dicatat</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${studentsToCorrect.map(siswa => `
                                    <tr id="correction-row-${siswa.docId}">
                                        <td>${siswa.nama}</td>
                                        <td><span class="badge badge-${getBadgeClass(siswa.status)}" id="status-badge-${siswa.docId}">${siswa.status}</span></td>
                                        <td>${siswa.timestamp ? siswa.timestamp.toDate().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}) : '-'}</td>
                                        <td>
                                            <button class="btn btn-sm btn-warning" onclick="openCorrectionModalForDailyStatus('${siswa.docId}', '${siswa.nisn}', '${siswa.nama}', '${siswa.kelas}', '${siswa.status}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        mainContentArea.innerHTML = tableHtml;

    } catch (error) {
        console.error("Error loading daily correction form:", error);
        mainContentArea.innerHTML = `<div class="alert alert-danger mt-4">Gagal memuat data koreksi: ${error.message}</div>`;
    }
}
// --- END NEW FEATURE: KOREKSI KETIDAKHADIRAN HARI INI ---

// Event listener untuk tombol simpan di modal koreksi harian
document.getElementById('saveDailyCorrectionBtn').addEventListener('click', async () => {
    const saveButton = document.getElementById('saveDailyCorrectionBtn');
    saveButton.disabled = true;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';

    const nisn = document.getElementById('dailyCorrectionNisn').value;
    const originalStatus = document.getElementById('dailyCorrectionOriginalStatus').value;
    const newStatus = document.getElementById('dailyCorrectionStatusSelect').value;
    const logId = document.getElementById('dailyCorrectionLogId').value;

    if (originalStatus === newStatus) {
        Toastify({ text: 'Tidak ada perubahan status.', duration: 2000, gravity: "top", position: "center", style: { background: "#ffc107" } }).showToast();
        $('#dailyCorrectionModal').modal('hide');
        saveButton.disabled = false;
        saveButton.innerHTML = 'Simpan Koreksi';
        return;
    }

    try {
        const siswaDoc = await db.collection('siswa').doc(nisn).get();
        if (!siswaDoc.exists) {
            throw new Error(`Data siswa dengan NISN ${nisn} tidak ditemukan.`);
        }
        const siswaData = siswaDoc.data();
        const nomorAbsenSiswa = siswaData.nomorAbsen || 0;
        const namaSiswa = siswaData.nama;
        const kelasSiswa = siswaData.kelas;

        const today = new Date();
        const tglString = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
        const year = today.getFullYear(), month = today.getMonth() + 1, day = today.getDate();

        const rekapHarianRef = db.collection('rekap_harian_per_kelas').doc(`${tglString}_${kelasSiswa}`);
        const rekapBulananRef = db.collection('rekap_bulanan').doc(`${nisn}_${year}-${month}`);
        const logAbsensiRef = db.collection('log_absensi').doc(logId);
        const agregatRef = db.collection('agregat_bulanan_kelas').doc(`${kelasSiswa}-${year}-${month}`);

        const batch = db.batch();

        batch.update(logAbsensiRef, { status: newStatus, timestamp: firebase.firestore.FieldValue.serverTimestamp(), dicatatOleh: currentUser.name });

        const oldField = originalStatus === 'Tanpa Keterangan' ? 'alpha' : originalStatus.toLowerCase();
        const newField = newStatus === 'Tanpa Keterangan' ? 'alpha' : newStatus.toLowerCase();
        batch.update(rekapHarianRef, { [oldField]: firebase.firestore.FieldValue.increment(-1), [newField]: firebase.firestore.FieldValue.increment(1) });

        batch.update(rekapBulananRef, {
            absensi: firebase.firestore.FieldValue.arrayRemove({ tanggal: tglString, status: originalStatus, logId: logId })
        });
        batch.update(rekapBulananRef, {
            absensi: firebase.firestore.FieldValue.arrayUnion({ tanggal: tglString, status: newStatus, logId: logId })
        });

        const oldStatusFieldAgregat = originalStatus === 'Tanpa Keterangan' ? 'alpha' : originalStatus.toLowerCase();
        const newStatusFieldAgregat = newStatus === 'Tanpa Keterangan' ? 'alpha' : newStatus.toLowerCase();
        batch.update(agregatRef, {
            [`rekap.tgl_${day}.${oldStatusFieldAgregat}`]: firebase.firestore.FieldValue.increment(-1),
            [`rekap.tgl_${day}.${newStatusFieldAgregat}`]: firebase.firestore.FieldValue.increment(1)
        });

        // --- PERBAIKAN DI SINI ---
        // Objek data untuk dikirim ke fungsi-fungsi helper.
        const updateDataForSemester = {
            nisn: nisn,
            nama: namaSiswa,
            kelas: kelasSiswa,
            nomorAbsen: nomorAbsenSiswa,
            newStatus: newStatus, // `updateSemesterCache` memang butuh `newStatus`
            dateObject: today,
            logId: logId,
            isCorrection: true,
            oldStatus: originalStatus
        };

        const updateDataForDailyRecap = {
            nisn: nisn,
            nama: namaSiswa,
            kelas: kelasSiswa,
            nomorAbsen: nomorAbsenSiswa,
            status: newStatus, // `updateDailyAbsenceRecap` butuh `status`
            tanggal: tglString,
            isCorrection: true,
            oldStatus: originalStatus
        };
        // --- AKHIR PERBAIKAN ---

        // Panggil fungsi untuk update cache semester
        await updateSemesterCache(batch, updateDataForSemester);

        // Panggil fungsi untuk update rekap catatan harian
        await updateDailyAbsenceRecap(batch, updateDataForDailyRecap);

        await batch.commit();

        Toastify({ text: `Koreksi absensi ${namaSiswa} berhasil disimpan!`, duration: 3000, gravity: "top", position: "center", style: { background: "#4CAF50" } }).showToast();
        $('#dailyCorrectionModal').modal('hide');
        await showDailyCorrectionForm();

    } catch (error) {
        Toastify({ text: "Gagal menyimpan koreksi: " + error.message, duration: 3000, gravity: "top", position: "center", style: { background: "#dc3545" } }).showToast();
        console.error("Error saving daily correction:", error);
    } finally {
        saveButton.disabled = false;
        saveButton.innerHTML = 'Simpan Koreksi';
    }
});

// Fungsi helper untuk badge status (letakkan di bagian umum skrip Anda)
function getBadgeClass(status) {
    switch (status) {
        case 'Hadir':
        case 'Masuk':
        case 'Pulang':
            return 'success'; // Hijau
        case 'Sakit':
            return 'warning'; // Kuning
        case 'Izin':
            return 'info'; // Biru terang
        case 'Tanpa Keterangan':
        case 'Alfa':
            return 'danger'; // Merah
        case 'Belum Absen': // Jika Anda ingin badge untuk "Belum Absen"
            return 'secondary'; // Abu-abu
        default:
            return 'primary'; // Biru gelap (default)
    }
}

// --- FUNGSI HELPER BARU UNTUK UPDATE REKAP KETIDAKHADIRAN ---
async function updateDailyAbsenceRecap(batch, data) {
    const { nisn, nama, nomorAbsen, kelas, status, tanggal, isCorrection = false, oldStatus = null } = data;

    // Status yang ingin dicatat di rekap_ketidakhadiran_harian adalah Sakit, Izin, dan Tanpa Keterangan
    const statusToRecord = ['Sakit', 'Izin', 'Tanpa Keterangan'];

    const docId = `${tanggal}_${kelas}`;
    const recapRef = db.collection('rekap_ketidakhadiran_harian').doc(docId);

    const studentData = {
        nisn: nisn,
        nama: nama,
        nomorAbsen: nomorAbsen || 0,
        // Pastikan status yang disimpan di sini adalah "Tanpa Keterangan" jika itu yang dipilih
        status: status 
    };

    // 1. Jika ini adalah koreksi dan status lama juga merupakan status yang dicatat
    if (isCorrection && oldStatus && statusToRecord.includes(oldStatus)) {
        const oldStudentData = {
            nisn: nisn,
            nama: nama,
            nomorAbsen: nomorAbsen || 0,
            status: oldStatus // Gunakan oldStatus di sini
        };
        // Hapus data siswa dengan status lama dari array
        batch.update(recapRef, { siswa: firebase.firestore.FieldValue.arrayRemove(oldStudentData) });
    }
    
    // 2. Tambahkan atau perbarui data baru jika statusnya adalah salah satu yang ingin dicatat
    if (statusToRecord.includes(status)) {
        // Pastikan dokumen ada, atau buat jika belum ada
        batch.set(recapRef, { tanggal: tanggal, kelas: kelas }, { merge: true });
        // Tambahkan data siswa dengan status baru ke array
        batch.update(recapRef, { siswa: firebase.firestore.FieldValue.arrayUnion(studentData) });
    }
    // Jika statusnya bukan Sakit/Izin/Tanpa Keterangan (misal Hadir/Masuk/Pulang)
    // dan ini bukan koreksi dari status ketidakhadiran, maka tidak perlu melakukan apa-apa.
    // Jika ini adalah koreksi dari Sakit/Izin/Tanpa Keterangan menjadi Hadir/Masuk/Pulang,
    // maka langkah arrayRemove sudah menghapusnya, dan langkah arrayUnion tidak akan menambahkannya lagi.
}

/**
 * Fungsi pusat untuk memperbarui koleksi cache_rekap_semester.
 * @param {object} batch - Objek batch Firestore yang sedang berjalan.
 * @param {object} data - Objek yang berisi data absensi.
 * @param {string} data.nisn - NISN siswa.
 * @param {string} data.nama - Nama siswa.
 * @param {string} data.kelas - Kelas siswa.
 * @param {number} data.nomorAbsen - Nomor absen siswa.
 * @param {string} data.newStatus - Status absensi baru ('Sakit', 'Izin', 'Tanpa Keterangan').
 * @param {Date} data.dateObject - Objek Date dari tanggal absensi.
 * @param {string} data.logId - ID dokumen dari koleksi log_absensi.
 * @param {boolean} [data.isCorrection=false] - Tandai true jika ini adalah koreksi status.
 * @param {string} [data.oldStatus] - Status absensi lama (wajib jika isCorrection true).
 * @param {firebase.firestore.WriteBatch} batch - Objek batch Firestore yang sedang berjalan.
 * @param {object} data - Objek data absensi.
 */
async function updateSemesterCache(batch, data) {
    const { nisn, nama, kelas, nomorAbsen, newStatus, dateObject, logId, isCorrection = false, oldStatus } = data;

    const year = dateObject.getFullYear();
    const month = dateObject.getMonth() + 1;
    const semester = (month >= 7 && month <= 12) ? 1 : 2;
    const tglString = `${year}-${String(month).padStart(2, '0')}-${String(dateObject.getDate()).padStart(2, '0')}`;

    const cacheRef = db.collection('cache_rekap_semester').doc(`${nisn}_${year}_${semester}`);
    const fieldMap = { 'Sakit': 'totalSakit', 'Izin': 'totalIzin', 'Tanpa Keterangan': 'totalAlpha' };

    const relevantStatuses = Object.keys(fieldMap);

    // 1. Pastikan dokumen dasar ada dengan info siswa yang benar
    batch.set(cacheRef, { nisn, nama, kelas, nomorAbsen, tahun: year, semester }, { merge: true });

    // 2. Jika ini koreksi, tangani status lama (kurangi counter & hapus detail)
    if (isCorrection && oldStatus && relevantStatuses.includes(oldStatus)) {
        const oldField = fieldMap[oldStatus];
        const oldDetailObject = { tanggal: tglString, status: oldStatus, logId: logId };
        
        batch.update(cacheRef, {
            [oldField]: firebase.firestore.FieldValue.increment(-1),
            detailAbsensi: firebase.firestore.FieldValue.arrayRemove(oldDetailObject)
        });
    }

    // 3. Tangani status baru (tambah counter & tambah detail)
    if (relevantStatuses.includes(newStatus)) {
        const newField = fieldMap[newStatus];
        const newDetailObject = { tanggal: tglString, status: newStatus, logId: logId };
        
        batch.update(cacheRef, {
            [newField]: firebase.firestore.FieldValue.increment(1),
            detailAbsensi: firebase.firestore.FieldValue.arrayUnion(newDetailObject)
        });
    }
}
    // =================================================================
    // --- [FITUR NILAI] FUNGSI-FUNGSI BARU ---
    // =================================================================
    function showNilaiSelectionView() {
        hideAllMainContentAreas();
        const mainContent = document.getElementById('main-content-area');
        mainContent.style.display = 'block';

        // --- LOGIKA BARU DIMULAI DI SINI ---
        const kelasSaatIni = parseInt(currentUser.kelasDiampu);

        // Membuat opsi dropdown kelas lampau secara dinamis
        let opsiKelasLampau = '';
        for (let i = 1; i < kelasSaatIni; i++) {
            opsiKelasLampau += `<option value="${i}">Kelas ${i}</option>`;
        }

        // Mendapatkan data semester berjalan untuk ditampilkan di kartu atas
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        const semester = (currentMonth >= 7 && currentMonth <= 12) ? 1 : 2;
        const tahunAjaran = (semester === 1) ? `${currentYear}/${currentYear + 1}` : `${currentYear - 1}/${currentYear}`;
        const semesterText = (semester === 1) ? `Ganjil ${tahunAjaran}` : `Genap ${tahunAjaran}`;

        mainContent.innerHTML = `
            <div id="nilai-selection-view">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title font-weight-bold text-primary"><i class="fas fa-edit mr-2"></i>Semester Berjalan</h5>
                        <p class="card-text text-muted">Klik untuk mulai mengisi nilai rapor untuk siswa kelas ${currentUser.kelasDiampu} Anda saat ini.</p>
                        <button id="btn-input-nilai-sekarang" class="btn btn-primary">
                            Input Nilai Semester ${semesterText}
                        </button>
                    </div>
                </div>
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title font-weight-bold"><i class="fas fa-history mr-2"></i>Isi Riwayat Nilai Siswa Saat Ini</h5>
                        <p class="card-text text-muted">Fitur ini untuk mengisi nilai siswa <strong>kelas ${currentUser.kelasDiampu} Anda</strong> saat mereka berada di tingkat kelas sebelumnya.</p>
                        <div class="form-row align-items-end">
                            <div class="col-md-4 mb-2">
                                <label for="select-kelas-lampau">Pilih Tingkat Kelas Lampau</label>
                                <select id="select-kelas-lampau" class="form-control">
                                    ${opsiKelasLampau}
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="select-semester-lampau">Pilih Semester</label>
                                <select id="select-semester-lampau" class="form-control">
                                    <option value="1">Ganjil</option>
                                    <option value="2">Genap</option>
                                </select>
                            </div>
                            <div class="col-md-2 mb-2">
                                <button id="btn-input-riwayat-nilai" class="btn btn-secondary btn-block">Lanjutkan</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        addNilaiSelectionListeners(); // Panggil fungsi untuk menambahkan event listener
    }

    // [FITUR NILAI] Menambahkan event listener ke halaman pemilihan nilai
    function addNilaiSelectionListeners() {
        // Tombol untuk semester sekarang
        const btnSekarang = document.getElementById('btn-input-nilai-sekarang');
        if (btnSekarang) {
            btnSekarang.addEventListener('click', () => {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1;
                const semester = (currentMonth >= 7 && currentMonth <= 12) ? 1 : 2;
                const tahunAjaran = (semester === 2) ? currentYear - 1 : currentYear;
                
                // Panggil fungsi untuk menampilkan halaman input nilai (akan kita buat di langkah berikutnya)
                showNilaiInputView(currentUser.kelasDiampu, semester, tahunAjaran);
            });
        }

        // Tombol untuk data lampau
        const btnRiwayat = document.getElementById('btn-input-riwayat-nilai');
        if (btnRiwayat) {
            btnRiwayat.addEventListener('click', async () => {
                const kelasLampau = parseInt(document.getElementById('select-kelas-lampau').value);
                const semester = parseInt(document.getElementById('select-semester-lampau').value);
                
                // --- AWAL LOGIKA BARU ---
                // 1. Dapatkan tahun ajaran awal saat ini
                const now = new Date();
                const tahunKalenderSaatIni = now.getFullYear();
                const bulanSaatIni = now.getMonth() + 1; // getMonth() dari 0-11
                const tahunAjaranAwalSaatIni = (bulanSaatIni >= 7) ? tahunKalenderSaatIni : tahunKalenderSaatIni - 1;
                
                // 2. Hitung selisih tahun
                const kelasSaatIni = parseInt(currentUser.kelasDiampu);
                const selisihTahun = kelasSaatIni - kelasLampau;
                
                // 3. Tentukan tahun ajaran lampau secara otomatis
                const tahunAjaran = tahunAjaranAwalSaatIni - selisihTahun;
                // --- AKHIR LOGIKA BARU ---

                // Ambil daftar siswa yang diajar saat ini
                const siswaSaatIniSnapshot = await db.collection('siswa')
                    .where('kelas', '==', currentUser.kelasDiampu)
                    .where('status', '==', 'Aktif')
                    .orderBy('nomorAbsen')
                    .get();
                const daftarSiswaUntukDiisi = siswaSaatIniSnapshot.docs.map(doc => doc.data());

                // Panggil fungsi input view dengan tahun ajaran yang sudah dihitung otomatis
                showNilaiInputView(kelasLampau.toString(), semester, tahunAjaran, daftarSiswaUntukDiisi);
            });
        }
    }

    function showNilaiInputView(kelas, semester, tahunAjaran, daftarSiswa = null) {
        hideAllMainContentAreas(); // Sembunyikan semua konten lain
        const mainContent = document.getElementById('main-content-area');
        mainContent.style.display = 'block'; // Tampilkan area konten utama

        const semesterText = semester === 1 ? 'Ganjil' : 'Genap';
        const tahunAjaranText = `${tahunAjaran}/${tahunAjaran + 1}`;

        // Langsung isi innerHTML dari 'main-content-area'
        mainContent.innerHTML = `
            <div id="nilai-input-view">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center flex-wrap mb-3 border-bottom pb-3">
                            <div>
                                <h5 class="card-title font-weight-bold text-primary mb-1">Input Nilai Rapor: Kelas ${kelas}</h5>
                                <p class="text-muted mb-0">Semester ${semesterText} - Tahun Ajaran ${tahunAjaranText}</p>
                            </div>
                            <div class="d-flex align-items-center mt-2 mt-md-0">
                                <div class="text-right mr-3">
                                    <span id="nilai-progress-text" class="font-weight-bold">Memuat progres...</span>
                                    <button id="btn-sync-jumlah-siswa" class="btn btn-sm btn-link p-0" title="Sinkronisasi Ulang Jumlah Siswa"><i class="fas fa-sync"></i></button>
                                </div>
                                <button id="btn-atur-mapel" class="btn btn-secondary mr-2" title="Atur Mata Pelajaran"><i class="fas fa-cog"></i></button>
                                <button id="btn-hitung-rata-rata" class="btn btn-success" disabled>
                                    <i class="fas fa-calculator mr-2"></i>Hitung Rata-rata
                                </button>
                            </div>
                        </div>

                        <div id="nilai-student-list-container" class="table-responsive">
                            <div class="text-center p-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Memuat daftar siswa...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        loadNilaiInputData(kelas, semester, tahunAjaran, daftarSiswa);
    }

async function loadNilaiInputData(kelas, semester, tahunAjaran, daftarSiswa = null) {
    const progressText = document.getElementById('nilai-progress-text');
    const studentListContainer = document.getElementById('nilai-student-list-container');
    const hitungBtn = document.getElementById('btn-hitung-rata-rata');

    nilaiState.kelas = kelas;
    nilaiState.semester = semester;
    nilaiState.tahunAjaran = tahunAjaran;

    try {
        const configDocId = `kelas_${kelas}_semester_${semester}_${tahunAjaran}`;
        const configRef = db.collection('konfigurasi_mapel').doc(configDocId);
        const configDoc = await configRef.get();
        
        nilaiState.konfigurasiMapel = configDoc.exists ? configDoc.data().mapelAktif : daftarMapelMaster;
        const jumlahMapelAktif = nilaiState.konfigurasiMapel.length;

        if (!daftarSiswa) {
            const siswaSnapshot = await db.collection('siswa').where('kelas', '==', kelas).where('status', '==', 'Aktif').orderBy('nomorAbsen').get();
            if (siswaSnapshot.empty) {
                studentListContainer.innerHTML = `<div class="alert alert-info text-center">Tidak ada siswa aktif di kelas ini.</div>`;
                progressText.textContent = "Tidak ada siswa";
                hitungBtn.disabled = true;
                return;
            }
            nilaiState.daftarSiswa = siswaSnapshot.docs.map(doc => doc.data());
        } else {
            nilaiState.daftarSiswa = daftarSiswa;
        }
        
        const totalSiswa = nilaiState.daftarSiswa.length;
        let jumlahLengkap = 0; // Counter baru untuk siswa yang nilainya sudah lengkap

        // Ambil semua data nilai yang sudah ada untuk kelas ini
        const nilaiSnapshot = await db.collectionGroup('nilai_rapor')
            .where('kelas', '==', kelas)
            .where('semester', '==', semester)
            .where('tahunAjaran', '==', tahunAjaran)
            .get();
            
        const nilaiMap = new Map(nilaiSnapshot.docs.map(doc => [doc.data().nisn, doc.data()]));
        
        let tableHtml = `
            <table class="table table-hover table-bordered table-sm">
                <thead><tr><th>No. Absen</th><th>Nama Siswa</th><th>Status</th><th class="text-center">Aksi</th></tr></thead>
                <tbody>
        `;

        nilaiState.daftarSiswa.forEach(siswa => {
            const dataNilai = nilaiMap.get(siswa.nisn);
            let statusText = '❌ Belum Diisi';
            let isFilled = false;

        if (dataNilai) {
            isFilled = true; // Ada data, berarti tombolnya 'Edit'
            const jumlahNilaiDiisi = Object.keys(dataNilai.daftarNilai || {}).length;

            // LOGIKA BARU DIMULAI DI SINI
            if (jumlahNilaiDiisi >= jumlahMapelAktif) {
                // 1. Semua nilai mata pelajaran sudah diisi.
                jumlahLengkap++; // Tetap hitung lengkap untuk tombol "Hitung Rata-rata"

                // 2. Sekarang, periksa link rapornya.
                if (!dataNilai.linkPDF || dataNilai.linkPDF.trim() === '') {
                    // Jika nilai lengkap TAPI link rapor kosong
                    statusText = '🔗 Link Rapor Belum Diisi';
                } else {
                    // Jika nilai lengkap DAN link rapor ada
                    statusText = '✅ Lengkap';
                }
            } else {
                // Jika nilai mata pelajaran belum lengkap
                statusText = '⚠️ Nilai Belum Lengkap';
            }
        }
            
            tableHtml += `
                <tr>
                    <td>${siswa.nomorAbsen || '-'}</td>
                    <td>${siswa.nama}</td>
                    <td>${statusText}</td>
                    <td class="text-center">
                        <button class="btn btn-sm ${isFilled ? 'btn-outline-warning' : 'btn-warning'} nilai-input-btn" data-nisn="${siswa.nisn}">
                            ${isFilled ? 'Edit Nilai' : 'Input Nilai'}
                        </button>
                    </td>
                </tr>
            `;
        });

        tableHtml += `</tbody></table>`;
        studentListContainer.innerHTML = tableHtml;

        // Perbarui tampilan progres dan tombol berdasarkan counter baru
        progressText.textContent = `${jumlahLengkap} dari ${totalSiswa} siswa telah lengkap.`;
        hitungBtn.disabled = (jumlahLengkap !== totalSiswa);

        // Perbarui juga dokumen status di Firestore agar progres tersimpan
        const statusDocId = `kelas_${kelas}_semester_${semester}_${tahunAjaran}`;
        const statusRef = db.collection('status_input_nilai').doc(statusDocId);
        await statusRef.set({
            totalSiswa: totalSiswa,
            sudahDiisi: jumlahLengkap // 'sudahDiisi' sekarang berarti 'jumlahLengkap'
        }, { merge: true });

        addNilaiInputListeners();

    } catch (error) {
        console.error("Error loading nilai input data:", error);
        studentListContainer.innerHTML = `<div class="alert alert-danger">Gagal memuat data siswa: ${error.message}</div>`;
        progressText.textContent = "Gagal memuat";
    }
}
    
// =================================================================
// --- [FITUR NILAI] FUNGSI-FUNGSI UTAMA (LANJUTAN) ---
// =================================================================

// Fungsi yang dipanggil dari showNilaiInputView untuk mengaktifkan semua tombol
function addNilaiInputListeners() {
    const aturMapelBtn = document.getElementById('btn-atur-mapel');
    const studentListContainer = document.getElementById('nilai-student-list-container');
    const saveMapelBtn = document.getElementById('saveMapelConfigBtn');
    const saveNilaiBtn = document.getElementById('saveNilaiSiswaBtn');
    const syncBtn = document.getElementById('btn-sync-jumlah-siswa'); // <-- Tambahan
    const hitungBtn = document.getElementById('btn-hitung-rata-rata'); // <-- Tambahan

    if (aturMapelBtn) {
        aturMapelBtn.addEventListener('click', openKonfigurasiMapelModal);
    }
    if (studentListContainer) {
        studentListContainer.addEventListener('click', (e) => {
            const targetButton = e.target.closest('.nilai-input-btn');
            if (targetButton) {
                const nisn = targetButton.dataset.nisn;
                const siswa = nilaiState.daftarSiswa.find(s => s.nisn === nisn);
                if (siswa) {
                    nilaiState.siswaSedangDiedit = siswa;
                    openInputNilaiModal();
                }
            }
        });
    }
    if (saveMapelBtn) {
        saveMapelBtn.addEventListener('click', saveMapelConfiguration);
    }
    if (saveNilaiBtn) {
        saveNilaiBtn.addEventListener('click', saveNilaiSiswa);
    }
    // Listener untuk tombol sinkronisasi (BARU)
    if (syncBtn) {
        syncBtn.addEventListener('click', syncJumlahSiswa);
    }
    // Listener untuk tombol hitung rata-rata (BARU)
    if (hitungBtn) {
        hitungBtn.addEventListener('click', hitungDanSimpanRataRataKelas);
    }
}

// Fungsi untuk membuka modal konfigurasi mapel
async function openKonfigurasiMapelModal() {
    const mapelListContainer = document.getElementById('mapel-list-container');
    mapelListContainer.innerHTML = '<div class="spinner-border spinner-border-sm"></div>';
    $('#konfigurasiMapelModal').modal('show');

    // Cek apakah sudah ada konfigurasi tersimpan
    const configDocId = `kelas_${nilaiState.kelas}_semester_${nilaiState.semester}_${nilaiState.tahunAjaran}`;
    const configRef = db.collection('konfigurasi_mapel').doc(configDocId);
    const configDoc = await configRef.get();
    
    let mapelAktif = daftarMapelMaster; // Default: semua mapel aktif
    if (configDoc.exists) {
        mapelAktif = configDoc.data().mapelAktif;
    }
    nilaiState.konfigurasiMapel = mapelAktif; // Simpan konfigurasi saat ini

    let html = '<div class="row">';
    daftarMapelMaster.forEach(mapel => {
        const isChecked = mapelAktif.includes(mapel);
        html += `
            <div class="col-md-6 col-lg-4">
                <div class="custom-control custom-switch my-2">
                    <input type="checkbox" class="custom-control-input" id="switch-${mapel.replace(/\s+/g, '')}" value="${mapel}" ${isChecked ? 'checked' : ''}>
                    <label class="custom-control-label" for="switch-${mapel.replace(/\s+/g, '')}">${mapel}</label>
                </div>
            </div>
        `;
    });
    html += '</div>';
    mapelListContainer.innerHTML = html;
}

// Fungsi untuk membuka modal input nilai untuk satu siswa
async function openInputNilaiModal() {
    const siswa = nilaiState.siswaSedangDiedit;
    document.getElementById('inputNilaiModalTitle').textContent = `Input Nilai - ${siswa.nama}`;
    const formContainer = document.getElementById('form-nilai-container');
    
    // Reset form
    formContainer.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm"></div> <p>Memuat formulir...</p></div>`;
    
    $('#inputNilaiModal').modal('show');

    // Ambil data nilai yang sudah ada (jika ada)
    const nilaiDocId = `${siswa.nisn}_${nilaiState.kelas}_${nilaiState.semester}_${nilaiState.tahunAjaran}`;
    const nilaiRef = db.collection('siswa').doc(siswa.nisn).collection('nilai_rapor').doc(nilaiDocId);
    const nilaiDoc = await nilaiRef.get();
    const dataNilai = nilaiDoc.exists ? nilaiDoc.data() : {};
    
    let formHtml = '';
    nilaiState.konfigurasiMapel.forEach(mapel => {
        const nilai = dataNilai.daftarNilai ? (dataNilai.daftarNilai[mapel] || '') : '';
        formHtml += `
            <div class="form-group row">
                <label class="col-sm-4 col-form-label">${mapel}</label>
                <div class="col-sm-8">
                    <input type="number" class="form-control nilai-mapel-input" data-mapel="${mapel}" value="${nilai}" min="0" max="100">
                </div>
            </div>
        `;
    });
    
    // --- AWAL LOGIKA BARU ---
    // Tambahkan input link rapor, dan link ijazah jika kondisinya sesuai
    formHtml += `<hr>`;
    formHtml += `
        <div class="form-group">
            <label for="link-pdf-rapor"><strong>Link Unduh Rapor (PDF)</strong></label>
            <input type="url" id="link-pdf-rapor" class="form-control" placeholder="Tempel link Google Drive atau lainnya di sini" value="${dataNilai.linkPDF || ''}">
        </div>
    `;

    // Cek apakah ini Kelas 6 dan Semester 2
    if (nilaiState.kelas === '6' && nilaiState.semester === 2) {
        formHtml += `
            <div class="form-group">
                <label for="link-pdf-ijazah"><strong>Link Ijazah (PDF)</strong> <span class="badge badge-success">Khusus Kelas 6</span></label>
                <input type="url" id="link-pdf-ijazah" class="form-control" placeholder="Tempel link Google Drive atau lainnya di sini" value="${dataNilai.linkIjazah || ''}">
            </div>
        `;
    }
    // --- AKHIR LOGIKA BARU ---
    
    // Tampilkan semua elemen form yang sudah dibuat
    formContainer.innerHTML = formHtml;
    // Hapus baris ini karena link rapor sudah dimasukkan dalam blok HTML di atas
    // linkPdfInput.value = dataNilai.linkPDF || '';
}

async function saveMapelConfiguration() {
    const saveBtn = document.getElementById('saveMapelConfigBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';

    // Ambil semua mapel yang dicentang
    const mapelAktifBaru = [];
    document.querySelectorAll('#mapel-list-container .custom-control-input').forEach(checkbox => {
        if (checkbox.checked) {
            mapelAktifBaru.push(checkbox.value);
        }
    });

    try {
        const configDocId = `kelas_${nilaiState.kelas}_semester_${nilaiState.semester}_${nilaiState.tahunAjaran}`;
        const configRef = db.collection('konfigurasi_mapel').doc(configDocId);

        // Simpan konfigurasi baru ke Firestore
        await configRef.set({
            mapelAktif: mapelAktifBaru
        });

        // Update state lokal agar langsung bisa digunakan
        nilaiState.konfigurasiMapel = mapelAktifBaru;

        Toastify({ text: "Pengaturan mata pelajaran berhasil disimpan!", style: { background: "green" } }).showToast();
        $('#konfigurasiMapelModal').modal('hide');

    } catch (error) {
        console.error("Error saving mapel config:", error);
        Toastify({ text: `Gagal menyimpan: ${error.message}`, style: { background: "red" } }).showToast();
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'Simpan Pengaturan';
    }
}

async function saveNilaiSiswa() {
    const saveBtn = document.getElementById('saveNilaiSiswaBtn');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';

    try {
        const siswa = nilaiState.siswaSedangDiedit;
        
        // --- AWAL LOGIKA BARU ---
        // Ambil data dari semua input yang mungkin ada
        const linkPDF = document.getElementById('link-pdf-rapor').value;
        const linkIjazahInput = document.getElementById('link-pdf-ijazah'); // Cek apakah elemen ini ada
        const linkIjazah = linkIjazahInput ? linkIjazahInput.value : null; // Ambil nilainya jika ada
        // --- AKHIR LOGIKA BARU ---
        
        const daftarNilai = {};
        const nilaiInputs = document.querySelectorAll('#form-nilai-container .nilai-mapel-input');
        nilaiInputs.forEach(input => {
            const mapel = input.dataset.mapel;
            const nilai = input.value;
            if (nilai && nilai.trim() !== '') { 
                daftarNilai[mapel] = parseInt(nilai);
            }
        });

        const semuaNilai = Object.values(daftarNilai);
        let nilaiRataRata = 0;
        if (semuaNilai.length > 0) {
            const totalNilai = semuaNilai.reduce((sum, current) => sum + current, 0);
            nilaiRataRata = parseFloat((totalNilai / semuaNilai.length).toFixed(2));
        }

        const nilaiDocId = `${siswa.nisn}_${nilaiState.kelas}_${nilaiState.semester}_${nilaiState.tahunAjaran}`;
        const nilaiRef = db.collection('siswa').doc(siswa.nisn).collection('nilai_rapor').doc(nilaiDocId);
        
        // Siapkan data untuk disimpan
        const dataToSave = {
            nisn: siswa.nisn,
            nama: siswa.nama,
            kelas: nilaiState.kelas,
            semester: nilaiState.semester,
            tahunAjaran: nilaiState.tahunAjaran,
            daftarNilai: daftarNilai,
            nilaiRataRata: nilaiRataRata,
            linkPDF: linkPDF
        };

        // Tambahkan link ijazah ke data jika ada
        if (linkIjazah !== null) {
            dataToSave.linkIjazah = linkIjazah;
        }

        await nilaiRef.set(dataToSave);
        
        Toastify({ text: `Nilai untuk ${siswa.nama} berhasil disimpan!`, style: { background: "green" } }).showToast();
        $('#inputNilaiModal').modal('hide');

        await loadNilaiInputData(nilaiState.kelas, nilaiState.semester, nilaiState.tahunAjaran, nilaiState.daftarSiswa);

    } catch (error) {
        console.error("Error saving nilai siswa:", error);
        Toastify({ text: `Gagal menyimpan nilai: ${error.message}`, style: { background: "red" } }).showToast();
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'Simpan Nilai';
    }
}

async function syncJumlahSiswa() {
    const syncBtn = document.getElementById('btn-sync-jumlah-siswa');
    const originalIcon = syncBtn.innerHTML;
    syncBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
    syncBtn.disabled = true;

    try {
        const { kelas, semester, tahunAjaran } = nilaiState;
        
        // 1. Hitung ulang jumlah siswa aktif yang sebenarnya
        const siswaSnapshot = await db.collection('siswa')
            .where('kelas', '==', kelas)
            .where('status', '==', 'Aktif')
            .get();
        const totalSiswaAktual = siswaSnapshot.size;

        // 2. Perbarui dokumen penghitung
        const statusDocId = `kelas_${kelas}_semester_${semester}_${tahunAjaran}`;
        const statusRef = db.collection('status_input_nilai').doc(statusDocId);
        const statusDoc = await statusRef.get();
        
        const sudahDiisi = statusDoc.exists ? statusDoc.data().sudahDiisi || 0 : 0;
        const belumDiisi = totalSiswaAktual - sudahDiisi;

        await statusRef.set({
            totalSiswa: totalSiswaAktual,
            sudahDiisi: sudahDiisi,
            belumDiisi: belumDiisi
        }, { merge: true });

        Toastify({ text: "Jumlah siswa berhasil disinkronkan!", style: { background: "blue" } }).showToast();
        
        // Muat ulang data untuk me-refresh tampilan
        await loadNilaiInputData(kelas, semester, tahunAjaran);

    } catch (error) {
        console.error("Error syncing student count:", error);
        Toastify({ text: `Gagal sinkronisasi: ${error.message}`, style: { background: "red" } }).showToast();
    } finally {
        syncBtn.innerHTML = originalIcon;
        syncBtn.disabled = false;
    }
}

// GANTI FUNGSI LAMA DENGAN KODE LENGKAP INI
async function hitungDanSimpanRataRataKelas() {
    const hitungBtn = document.getElementById('btn-hitung-rata-rata');
    hitungBtn.disabled = true;
    hitungBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menghitung...';

    try {
        const { kelas, semester, tahunAjaran, daftarSiswa } = nilaiState;
        const nisnSiswa = daftarSiswa.map(s => s.nisn);

        // =====================================================================
        // ==== AWAL LOGIKA BARU (CHUNKING) ====================================
        // =====================================================================

        const rekapNilai = {}; // { Matematika: [90, 85, 88], ... }
        const promises = [];
        
        // Pecah 'nisnSiswa' menjadi kelompok-kelompok berisi 10
        for (let i = 0; i < nisnSiswa.length; i += 10) {
            const chunk = nisnSiswa.slice(i, i + 10);
            
            // Siapkan query untuk setiap kelompok
            const query = db.collectionGroup('nilai_rapor')
                .where('kelas', '==', kelas)
                .where('semester', '==', semester)
                .where('tahunAjaran', '==', tahunAjaran)
                .where('nisn', 'in', chunk);
            
            promises.push(query.get());
        }

        // Jalankan semua query secara paralel dan tunggu hasilnya
        const snapshotResults = await Promise.all(promises);

        // Gabungkan hasil dari semua query
        snapshotResults.forEach(snapshot => {
            snapshot.forEach(doc => {
                const data = doc.data();
                for (const mapel in data.daftarNilai) {
                    if (!rekapNilai[mapel]) {
                        rekapNilai[mapel] = [];
                    }
                    rekapNilai[mapel].push(data.daftarNilai[mapel]);
                }
            });
        });
        
        // =====================================================================
        // ==== AKHIR LOGIKA BARU (CHUNKING) ===================================
        // =====================================================================


        if (Object.keys(rekapNilai).length === 0) {
            throw new Error("Tidak ditemukan data nilai untuk dihitung.");
        }
        
        // Sisa dari fungsi ini tidak berubah: menghitung rata-rata
        const rataRataPerMapel = {};
        let totalSemuaRataRata = 0;
        let jumlahMapel = 0;

        for (const mapel in rekapNilai) {
            const totalNilai = rekapNilai[mapel].reduce((sum, current) => sum + current, 0);
            const rataRata = parseFloat((totalNilai / rekapNilai[mapel].length).toFixed(2));
            rataRataPerMapel[mapel] = rataRata;
            totalSemuaRataRata += rataRata;
            jumlahMapel++;
        }

        const rataRataKeseluruhan = jumlahMapel > 0 ? parseFloat((totalSemuaRataRata / jumlahMapel).toFixed(2)) : 0;

        // Simpan ke dokumen rekap_nilai_kelas
        const rekapDocId = `kelas_${kelas}_semester_${semester}_${tahunAjaran}`;
        const rekapRef = db.collection('rekap_nilai_kelas').doc(rekapDocId);
        
        await rekapRef.set({
            rataRataKeseluruhan: rataRataKeseluruhan,
            ...rataRataPerMapel
        });
        
        Toastify({ text: "Rata-rata kelas berhasil dihitung dan disimpan!", duration: 5000, style: { background: "green" } }).showToast();
        
    } catch (error) {
        console.error("Error calculating class average:", error);
        Toastify({ text: `Gagal menghitung: ${error.message}`, style: { background: "red" } }).showToast();
    } finally {
        hitungBtn.disabled = false;
        hitungBtn.innerHTML = '<i class="fas fa-calculator mr-2"></i>Selesaikan & Hitung Rata-rata';
    }
}

// --- KUMPULAN FUNGSI BARU UNTUK MODUL KEUANGAN ---

// GANTI FUNGSI INI DENGAN VERSI BARU
async function showKeuanganDashboard() {
    hideAllMainContentAreas();
    mainContentArea.style.display = 'block';
    mainContentArea.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div><p>Memuat data keuangan...</p></div>`;

    try {
        const rekeningSnapshot = await db.collection('rekening_sekolah').get();
        let cardsHtml = '';
        
        rekeningSnapshot.forEach(doc => {
            const rekening = doc.data();
            const saldoFormatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(rekening.saldo || 0);
            cardsHtml += `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title font-weight-bold text-primary">${rekening.namaRekening}</h5>
                            <h3 class="card-text font-weight-bolder">${saldoFormatted}</h3>
                            <button class="btn btn-outline-primary btn-sm stretched-link" onclick="showRiwayatTransaksi('${doc.id}', '${rekening.namaRekening}')">Lihat Riwayat</button>
                        </div>
                    </div>
                </div>
            `;
        });

        // --- AWAL PERUBAHAN: Membuat tombol menjadi responsif ---
        let buttonsHtml = '';
        if (currentUser.jabatan === 'Bendahara') {
            buttonsHtml = `
                <div class="col-12 mb-4 text-center">
                    <button class="btn btn-success" onclick="openTransaksiModal()">
                        <i class="fas fa-plus-circle"></i>
                        <span class="d-none d-sm-inline ml-2">Catat Transaksi</span>
                    </button>
                    <button class="btn btn-info" onclick="openRekeningModal()">
                        <i class="fas fa-university"></i>
                        <span class="d-none d-sm-inline ml-2">Buat Rekening</span>
                    </button>
                </div>
            `;
        }
        // --- AKHIR PERUBAHAN ---

        mainContentArea.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="font-weight-bolder">Dasbor Keuangan Sekolah</h4>
            </div>
            <div class="row">
                ${buttonsHtml}
                ${cardsHtml.length > 0 ? cardsHtml : '<p class="text-muted text-center col-12">Belum ada rekening dibuat.</p>'}
            </div>
        `;
    } catch (error) {
        mainContentArea.innerHTML = `<div class="alert alert-danger">Gagal memuat data keuangan: ${error.message}</div>`;
    }
}

// GANTI FUNGSI INI SEKALI LAGI
async function showRiwayatTransaksi(rekeningId, namaRekening) {
    mainContentArea.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div><p>Memuat riwayat...</p></div>`;
    
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;

    const renderHistory = async (y, m) => {
        try {
            const docId = `${rekeningId}_${y}_${String(m).padStart(2, '0')}`;
            const docSnap = await db.collection('transaksi_bulanan').doc(docId).get();
            
            const isBendahara = currentUser.jabatan === 'Bendahara';
            let tableRows = '';

            if (docSnap.exists) {
                const data = docSnap.data();
                const allTransactions = data.riwayat || [];
                allTransactions.sort((a,b) => new Date(a.tanggal) - new Date(b.tanggal));

                allTransactions.forEach((tx) => {
                    const isPemasukan = tx.tipe === 'Pemasukan';
                    
                    // --- MODIFIKASI DI SINI: Buat tombol Aksi (Edit & Hapus) ---
                    let actionButtons = '';
                    if (isBendahara) {
                        const txDataString = JSON.stringify(tx).replace(/"/g, '&quot;');
                        const editButton = `<button class="btn btn-sm btn-outline-warning mr-1" onclick='openEditTransaksiModal(${txDataString}, "${rekeningId}")'><i class="fas fa-edit"></i></button>`;
                        const deleteButton = `<button class="btn btn-sm btn-outline-danger" onclick='confirmDeleteTransaksi(${txDataString}, "${rekeningId}")'><i class="fas fa-trash"></i></button>`;
                        actionButtons = `<td class="text-center">${editButton}${deleteButton}</td>`;
                    }
                    
                    let keteranganHtml = tx.keterangan;
                    if (tx.dicatatOleh) {
                        keteranganHtml += `<br><small class="text-muted"><em>Oleh: ${tx.dicatatOleh}</em></small>`;
                    }

                    tableRows += `
                        <tr>
                            <td>${new Date(tx.tanggal).toLocaleDateString('id-ID')}</td>
                            <td>${keteranganHtml}</td>
                            <td class="text-right text-success">${isPemasukan ? new Intl.NumberFormat('id-ID').format(tx.jumlah) : '-'}</td>
                            <td class="text-right text-danger">${!isPemasukan ? new Intl.NumberFormat('id-ID').format(tx.jumlah) : '-'}</td>
                            ${actionButtons}
                        </tr>
                    `;
                });
            } else {
                tableRows = `<tr><td colspan="${isBendahara ? 5 : 4}" class="text-center text-muted">Tidak ada transaksi pada bulan ini.</td></tr>`;
            }

            // ... (sisa fungsi renderHistory tetap sama) ...
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            let monthOptions = '';
            for(let i = 1; i <= 12; i++) monthOptions += `<option value="${i}" ${i === m ? 'selected' : ''}>${monthNames[i-1]}</option>`;
            let yearOptions = '';
            for(let i = new Date().getFullYear(); i >= 2020; i--) yearOptions += `<option value="${i}" ${i === y ? 'selected' : ''}>${i}</option>`;

            mainContentArea.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <button class="btn btn-light" onclick="showKeuanganDashboard()"><i class="fas fa-arrow-left"></i></button>
                        <h4 class="font-weight-bolder d-inline-block ml-2 mb-0">Riwayat: ${namaRekening}</h4>
                    </div>
                    <div class="form-inline">
                        <select id="month-select" class="form-control mr-2">${monthOptions}</select>
                        <select id="year-select" class="form-control">${yearOptions}</select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="thead-light">
                            <tr>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th class="text-right">Pemasukan (Rp)</th>
                                <th class="text-right">Pengeluaran (Rp)</th>
                                ${isBendahara ? '<th class="text-center">Aksi</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            `;

            document.getElementById('month-select').addEventListener('change', (e) => renderHistory(parseInt(document.getElementById('year-select').value), parseInt(e.target.value)));
            document.getElementById('year-select').addEventListener('change', (e) => renderHistory(parseInt(e.target.value), parseInt(document.getElementById('month-select').value)));

        } catch (error) {
            mainContentArea.innerHTML = `<div class="alert alert-danger">Gagal memuat riwayat: ${error.message}</div>`;
        }
    };

    renderHistory(year, month);
}

// TAMBAHKAN FUNGSI BARU INI
function confirmDeleteTransaksi(txData, rekeningId) {
    // Tampilkan detail transaksi di modal untuk konfirmasi
    const detailP = document.getElementById('detailTransaksiHapus');
    const jumlahFormatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(txData.jumlah);
    detailP.innerHTML = `(${txData.tipe}) <strong>${jumlahFormatted}</strong> - ${txData.keterangan}`;

    // Simpan data yang akan dihapus ke tombol konfirmasi
    $('#confirmDeleteBtn').data('txData', txData);
    $('#confirmDeleteBtn').data('rekeningId', rekeningId);

    // Tampilkan modal
    $('#deleteConfirmModal').modal('show');
}

// TAMBAHKAN FUNGSI BARU INI
function openEditTransaksiModal(txData, rekeningId) {
    // Reset form dan isi dengan data transaksi yang akan diedit
    document.getElementById('formTransaksi').reset();
    document.getElementById('transaksiId').value = txData.id; // Simpan ID unik transaksi
    document.getElementById('jumlahUang').value = txData.jumlah;
    document.getElementById('tanggalTransaksi').value = txData.tanggal;
    document.getElementById('keteranganTransaksi').value = txData.keterangan;
    
    // Atur jenis transaksi (Pemasukan/Pengeluaran)
    if (txData.tipe === 'Pemasukan') {
        $('input[name="tipe"][value="Pemasukan"]').prop('checked', true).parent().addClass('active');
        $('input[name="tipe"][value="Pengeluaran"]').prop('checked', false).parent().removeClass('active');
    } else {
        $('input[name="tipe"][value="Pengeluaran"]').prop('checked', true).parent().addClass('active');
        $('input[name="tipe"][value="Pemasukan"]').prop('checked', false).parent().removeClass('active');
    }

    // Atur rekening yang dipilih
    const rekeningSelect = document.getElementById('rekeningSelect');
    // Kita perlu mengisi dropdown dulu jika belum ada, lalu pilih yang sesuai
    if (rekeningSelect.options.length <= 1) {
        // Jika dropdown kosong, panggil fungsi openTransaksiModal untuk mengisinya
        // lalu pilih rekening yang benar setelahnya
        openTransaksiModal().then(() => {
            rekeningSelect.value = rekeningId;
            rekeningSelect.disabled = true; // Non-aktifkan pilihan rekening saat mengedit
        });
    } else {
        rekeningSelect.value = rekeningId;
        rekeningSelect.disabled = true; // Non-aktifkan pilihan rekening saat mengedit
    }
    
    $('#transaksiModalTitle').text('Edit Transaksi');
    $('#transaksiModal').modal('show');
}

// GANTI FUNGSI INI
async function openTransaksiModal() {
    document.getElementById('formTransaksi').reset();
    document.getElementById('transaksiId').value = ''; // <-- Tambahan: Membersihkan ID edit secara eksplisit
    $('#transaksiModalTitle').text('Catat Transaksi Baru');
    
    const rekeningSelect = document.getElementById('rekeningSelect');
    rekeningSelect.innerHTML = '<option value="">Memuat...</option>';
    
    try {
        const snapshot = await db.collection('rekening_sekolah').get();
        rekeningSelect.innerHTML = '<option value="">-- Pilih Rekening --</option>';
        snapshot.forEach(doc => {
            rekeningSelect.innerHTML += `<option value="${doc.id}">${doc.data().namaRekening}</option>`;
        });
        document.getElementById('tanggalTransaksi').valueAsDate = new Date();
        $('#transaksiModal').modal('show');
    } catch(error) {
        Toastify({ text: "Gagal memuat daftar rekening.", style: { background: "red" } }).showToast();
    }
}

// Fungsi untuk membuka modal rekening baru
function openRekeningModal() {
     document.getElementById('formRekening').reset();
     $('#rekeningModal').modal('show');
}

// GANTI KESELURUHAN EVENT LISTENER INI DENGAN VERSI FINAL
document.getElementById('saveTransaksiBtn').addEventListener('click', async () => {
    const form = document.getElementById('formTransaksi');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const btn = document.getElementById('saveTransaksiBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';

    const txIdToEdit = document.getElementById('transaksiId').value;
    const isEditMode = !!txIdToEdit;
    const tipe = form.elements.tipe.value;
    const rekeningId = document.getElementById('rekeningSelect').value;
    const jumlah = parseInt(document.getElementById('jumlahUang').value);
    const tanggal = document.getElementById('tanggalTransaksi').value;
    const keterangan = document.getElementById('keteranganTransaksi').value;
    
    const txDate = new Date(tanggal);
    const year = txDate.getFullYear();
    const month = String(txDate.getMonth() + 1).padStart(2, '0');
    const docId = `${rekeningId}_${year}_${month}`;
    
    const docRef = db.collection('transaksi_bulanan').doc(docId);
    const rekeningRef = db.collection('rekening_sekolah').doc(rekeningId);

    try {
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(docRef);
            const rekeningDoc = await transaction.get(rekeningRef);

            if (!rekeningDoc.exists) throw "Rekening tidak ditemukan!";

            if (isEditMode) {
                if (!doc.exists) throw "Dokumen transaksi bulanan tidak ditemukan untuk diedit.";
                const dataBulanan = doc.data();
                const riwayatLama = dataBulanan.riwayat || [];
                const txLama = riwayatLama.find(tx => tx.id === txIdToEdit);
                if (!txLama) throw "Transaksi lama tidak ditemukan dalam riwayat.";

                const dampakLama = txLama.tipe === 'Pemasukan' ? txLama.jumlah : -txLama.jumlah;
                const dampakBaru = tipe === 'Pemasukan' ? jumlah : -jumlah;
                const selisihDampak = dampakBaru - dampakLama;

                const txBaru = { ...txLama, tipe, jumlah, tanggal, keterangan, dicatatOleh: currentUser.name };
                const riwayatBaru = riwayatLama.map(tx => tx.id === txIdToEdit ? txBaru : tx);
                
                const updateData = {
                    riwayat: riwayatBaru,
                    saldoAkhirBulan: firebase.firestore.FieldValue.increment(selisihDampak)
                };

                // Perbarui total pemasukan/pengeluaran bulanan
                if (txLama.tipe !== tipe) { // Jika tipe berubah (misal dari keluar jadi masuk)
                    updateData[txLama.tipe === 'Pemasukan' ? 'totalMasuk' : 'totalKeluar'] = firebase.firestore.FieldValue.increment(-txLama.jumlah);
                    updateData[tipe === 'Pemasukan' ? 'totalMasuk' : 'totalKeluar'] = firebase.firestore.FieldValue.increment(jumlah);
                } else { // Jika tipe sama, hanya jumlahnya yg berubah
                    updateData[tipe === 'Pemasukan' ? 'totalMasuk' : 'totalKeluar'] = firebase.firestore.FieldValue.increment(jumlah - txLama.jumlah);
                }
                
                transaction.update(docRef, updateData);
                transaction.update(rekeningRef, { saldo: firebase.firestore.FieldValue.increment(selisihDampak) });

            } else { // --- LOGIKA UNTUK BUAT BARU ---
                const newTx = { tanggal, keterangan, jumlah, tipe, id: new Date().getTime().toString(), dicatatOleh: currentUser.name };
                const saldoPerubahan = tipe === 'Pemasukan' ? jumlah : -jumlah;

                if (doc.exists) {
                    // JIKA DOKUMEN BULANAN SUDAH ADA, UPDATE
                    transaction.update(docRef, {
                        riwayat: firebase.firestore.FieldValue.arrayUnion(newTx),
                        saldoAkhirBulan: firebase.firestore.FieldValue.increment(saldoPerubahan),
                        ...(tipe === 'Pemasukan' ? { totalMasuk: firebase.firestore.FieldValue.increment(jumlah) } : { totalKeluar: firebase.firestore.FieldValue.increment(jumlah) })
                    });
                } else {
                    // JIKA DOKUMEN BULANAN BELUM ADA, BUAT BARU
                    const prevMonthDate = new Date(txDate.getFullYear(), txDate.getMonth(), 0);
                    const prevYear = prevMonthDate.getFullYear();
                    const prevMonth = String(prevMonthDate.getMonth() + 1).padStart(2, '0');
                    const prevDocId = `${rekeningId}_${prevYear}_${prevMonth}`;
                    const prevDocSnap = await db.collection('transaksi_bulanan').doc(prevDocId).get();
                    const saldoAwalBulan = prevDocSnap.exists ? prevDocSnap.data().saldoAkhirBulan : 0;
                    
                    transaction.set(docRef, {
                        idRekening: rekeningId, tahun: parseInt(year), bulan: parseInt(month),
                        saldoAwalBulan: saldoAwalBulan,
                        saldoAkhirBulan: saldoAwalBulan + saldoPerubahan,
                        totalMasuk: tipe === 'Pemasukan' ? jumlah : 0,
                        totalKeluar: tipe === 'Pengeluaran' ? jumlah : 0,
                        riwayat: [newTx]
                    });
                }
                transaction.update(rekeningRef, { saldo: firebase.firestore.FieldValue.increment(saldoPerubahan) });
            }
        });

        Toastify({ text: `Transaksi berhasil ${isEditMode ? 'diperbarui' : 'disimpan'}!`, style: { background: "green" } }).showToast();
        $('#transaksiModal').modal('hide');
        
        if (document.getElementById('month-select')) {
            const currentNamaRekening = document.querySelector('h4.font-weight-bolder').textContent.replace('Riwayat: ', '');
            showRiwayatTransaksi(rekeningId, currentNamaRekening);
        } else {
            showKeuanganDashboard();
        }

    } catch (error) {
        console.error("Error saving transaction: ", error);
        Toastify({ text: `Gagal menyimpan: ${error}`, style: { background: "red" } }).showToast();
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Simpan Transaksi';
        document.getElementById('rekeningSelect').disabled = false;
    }
});
// Event listener untuk simpan rekening baru
document.getElementById('saveRekeningBtn').addEventListener('click', async () => {
     const btn = document.getElementById('saveRekeningBtn');
     btn.disabled = true;
     btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';

     const namaRekening = document.getElementById('namaRekening').value;
     if (!namaRekening) {
         Toastify({ text: "Nama rekening tidak boleh kosong.", style: { background: "orange" } }).showToast();
         btn.disabled = false; btn.innerHTML = 'Simpan';
         return;
     }

     try {
        await db.collection('rekening_sekolah').add({
            namaRekening: namaRekening,
            saldo: 0
        });
        Toastify({ text: "Rekening baru berhasil dibuat!", style: { background: "green" } }).showToast();
        $('#rekeningModal').modal('hide');
        showKeuanganDashboard();
     } catch(error) {
        Toastify({ text: `Gagal membuat rekening: ${error.message}`, style: { background: "red" } }).showToast();
     } finally {
        btn.disabled = false; btn.innerHTML = 'Simpan';
     }
});
// TAMBAHKAN EVENT LISTENER BARU INI
document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menghapus...';

    const context = $(btn).data('context'); // Konteks: 'keuangan' atau 'tabungan'
    const txToDelete = $(btn).data('txData');
    const rekeningId = $(btn).data('rekeningId');

    // Logika Hapus untuk Tabungan Kelas
    if (context === 'tabungan') {
        const txDate = new Date(txToDelete.tanggal);
        const docId = `${rekeningId}_${txDate.getFullYear()}_${String(txDate.getMonth() + 1).padStart(2, '0')}`;
        const docRef = db.collection('tabungan_kelas').doc(docId);
        const rekapRef = db.collection('rekap_saldo_tabungan').doc(rekeningId);

        try {
            await db.runTransaction(async (transaction) => {
                const saldoPerubahan = txToDelete.tipe === 'Setor' ? -txToDelete.jumlah : txToDelete.jumlah;
                transaction.update(docRef, { riwayatTransaksi: firebase.firestore.FieldValue.arrayRemove(txToDelete) });
                transaction.update(rekapRef, { totalSaldoKelas: firebase.firestore.FieldValue.increment(saldoPerubahan) });
            });
            Toastify({ text: "Transaksi tabungan berhasil dihapus!", style: { background: "green" } }).showToast();
            $('#deleteConfirmModal').modal('hide');
            showTabunganKelas();
        } catch (error) {
            console.error("Error deleting saving transaction: ", error);
            Toastify({ text: `Gagal menghapus: ${error}`, style: { background: "red" } }).showToast();
        } finally {
            btn.disabled = false; btn.innerHTML = 'Ya, Hapus';
        }
        return; // Selesai
    }

    // Logika Hapus untuk Keuangan Sekolah (yang sudah ada sebelumnya)
    const txDate = new Date(txToDelete.tanggal);
    const year = txDate.getFullYear();
    const month = String(txDate.getMonth() + 1).padStart(2, '0');
    const docId = `${rekeningId}_${year}_${month}`;
    const docRef = db.collection('transaksi_bulanan').doc(docId);
    const rekeningRef = db.collection('rekening_sekolah').doc(rekeningId);

    try {
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(docRef);
            if (!doc.exists) throw "Dokumen transaksi bulanan tidak ditemukan.";
            const saldoPerubahan = txToDelete.tipe === 'Pemasukan' ? -txToDelete.jumlah : txToDelete.jumlah;
            const updateData = {
                riwayat: firebase.firestore.FieldValue.arrayRemove(txToDelete),
                saldoAkhirBulan: firebase.firestore.FieldValue.increment(saldoPerubahan),
                ...(txToDelete.tipe === 'Pemasukan' 
                    ? { totalMasuk: firebase.firestore.FieldValue.increment(-txToDelete.jumlah) } 
                    : { totalKeluar: firebase.firestore.FieldValue.increment(-txToDelete.jumlah) })
            };
            transaction.update(docRef, updateData);
            transaction.update(rekeningRef, { saldo: firebase.firestore.FieldValue.increment(saldoPerubahan) });
        });
        Toastify({ text: "Transaksi berhasil dihapus!", style: { background: "green" } }).showToast();
        $('#deleteConfirmModal').modal('hide');
        const currentNamaRekening = document.querySelector('h4.font-weight-bolder').textContent.replace('Riwayat: ', '');
        showRiwayatTransaksi(rekeningId, currentNamaRekening);
    } catch (error) {
        console.error("Error deleting transaction: ", error);
        Toastify({ text: `Gagal menghapus: ${error}`, style: { background: "red" } }).showToast();
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Ya, Hapus';
    }
});
// --- KUMPULAN FUNGSI BARU UNTUK TABUNGAN KELAS ---
// GANTI KESELURUHAN FUNGSI INI DENGAN VERSI FINAL
async function showTabunganKelas() {
    hideAllMainContentAreas();
    mainContentArea.style.display = 'block';
    mainContentArea.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div></div>`;

    const kelasId = currentUser.kelasDiampu;
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;
    const docId = `${kelasId}_${year}_${String(month).padStart(2, '0')}`;

    // --- AWAL PERUBAHAN: Dapatkan tanggal hari ini ---
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Reset waktu ke awal hari
    const todayString = today.toISOString().split('T')[0];
    // --- AKHIR PERUBAHAN ---

    try {
        const rekapRef = db.collection('rekap_saldo_tabungan').doc(kelasId);
        const rekapDoc = await rekapRef.get();
        const totalSaldo = rekapDoc.exists ? rekapDoc.data().totalSaldoKelas : 0;
        const saldoFormatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(totalSaldo);

        const docSnap = await db.collection('tabungan_kelas').doc(docId).get();
        let contentHtml = '';
        if (docSnap.exists) {
            const riwayat = docSnap.data().riwayatTransaksi || [];
            
            const groupedByDate = riwayat.reduce((acc, tx) => {
                const date = tx.tanggal;
                if (!acc[date]) acc[date] = { transactions: [], totalSetor: 0, totalTarik: 0 };
                acc[date].transactions.push(tx);
                if (tx.tipe === 'Setor') acc[date].totalSetor += tx.jumlah;
                else acc[date].totalTarik += tx.jumlah;
                return acc;
            }, {});

            const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
            
            // --- AWAL PERUBAHAN: Buat HTML untuk Akordeon ---
            let accordionHtml = '<div class="accordion" id="tabunganAccordion">';
            sortedDates.forEach((date) => {
                const group = groupedByDate[date];
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
                
                const totalSetorFormatted = new Intl.NumberFormat('id-ID').format(group.totalSetor);
                const totalTarikFormatted = new Intl.NumberFormat('id-ID').format(group.totalTarik);
                
                // Cek apakah tanggal ini adalah hari ini untuk membuatnya terbuka
                const isToday = date === todayString;
                const collapseId = `collapse-${date.replace(/-/g, '')}`;

                accordionHtml += `
                    <div class="card">
                        <div class="card-header p-0" id="heading-${collapseId}">
                            <button class="btn btn-light btn-block text-left p-3" data-toggle="collapse" data-target="#${collapseId}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong class="text-dark">${formattedDate}</strong>
                                    <div>
                                        <span class="badge badge-success mr-2">Setor: ${totalSetorFormatted}</span>
                                        <span class="badge badge-danger">Tarik: ${totalTarikFormatted}</span>
                                    </div>
                                </div>
                            </button>
                        </div>
                        <div id="${collapseId}" class="collapse ${isToday ? 'show' : ''}" data-parent="#tabunganAccordion">
                            <ul class="list-group list-group-flush">
                `;

                group.transactions.sort((a, b) => a.namaSiswa.localeCompare(b.namaSiswa));
                group.transactions.forEach(tx => {
                    const isSetor = tx.tipe === 'Setor';
                    const txDataString = JSON.stringify(tx).replace(/"/g, '&quot;');
                    const jumlahFormatted = new Intl.NumberFormat('id-ID').format(tx.jumlah);

                    accordionHtml += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                ${tx.namaSiswa}
                                <small class="d-block text-muted">${tx.keterangan || ''}</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="mr-3 font-weight-bold ${isSetor ? 'text-success' : 'text-danger'}">
                                    ${isSetor ? '+' : '-'} ${jumlahFormatted}
                                </span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-warning" onclick='openEditTabunganModal(${txDataString})'><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-outline-danger" onclick='confirmDeleteTabungan(${txDataString})'><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </li>
                    `;
                });

                accordionHtml += '</ul></div></div>';
            });
            accordionHtml += '</div>';
            contentHtml = accordionHtml;
            // --- AKHIR PERUBAHAN ---

        } else {
            contentHtml = `<p class="text-center text-muted">Belum ada transaksi bulan ini.</p>`;
        }

        mainContentArea.innerHTML = `
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="font-weight-bolder mb-0">Tabungan Kelas ${currentUser.kelasDiampu}</h4>
                            <div class="flex-shrink-0">
                                <button class="btn btn-success" onclick="openSetorTarikModal('Setor')" title="Setor Tunai"><i class="fas fa-plus"></i></button>
                                <button class="btn btn-warning ml-2" onclick="openSetorTarikModal('Tarik')" title="Tarik Tunai"><i class="fas fa-minus"></i></button>
                            </div>
                        </div>
                        <h5 class="text-muted mb-0">Total Saldo: <strong>${saldoFormatted}</strong></h5>
                    </div>
                    <p class="text-muted small">Menampilkan riwayat transaksi bulan ini.</p>
                    ${contentHtml}
                </div>
            </div>
        `;
    } catch (error) {
        mainContentArea.innerHTML = `<div class="alert alert-danger">Gagal memuat data tabungan: ${error.message}</div>`;
    }
}

// TAMBAHKAN DUA FUNGSI BARU INI
function openEditTabunganModal(txData) {
    document.getElementById('formTabungan').reset();
    document.getElementById('tabunganTxId').value = txData.id; // Simpan ID transaksi
    document.getElementById('tabunganTipe').value = txData.tipe;
    $('#tabunganModalTitle').text(`Edit ${txData.tipe} Tunai`);

    // Panggil openSetorTarikModal hanya untuk mengisi dropdown siswa
    openSetorTarikModal(txData.tipe).then(() => {
        // Setelah dropdown terisi, pilih siswa yang sesuai
        document.getElementById('siswaSelect').value = txData.nisn;
        document.getElementById('jumlahTabungan').value = txData.jumlah;
        document.getElementById('tanggalTabungan').value = txData.tanggal;
        document.getElementById('keteranganTabungan').value = txData.keterangan;
    });
}

function confirmDeleteTabungan(txData) {
    const detailP = document.getElementById('detailTransaksiHapus');
    const jumlahFormatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(txData.jumlah);
    detailP.innerHTML = `(${txData.tipe} ${txData.namaSiswa}) <strong>${jumlahFormatted}</strong> - ${txData.keterangan || 'Tanpa keterangan'}`;

    $('#confirmDeleteBtn').data('txData', txData);
    $('#confirmDeleteBtn').data('rekeningId', currentUser.kelasDiampu); // Untuk tabungan, rekeningId adalah kelasId
    $('#confirmDeleteBtn').data('context', 'tabungan'); // Tandai konteks sebagai 'tabungan'
    $('#deleteConfirmModal').modal('show');
}


// GANTI FUNGSI INI DENGAN VERSI BARU
async function showRekapSemuaTabungan() {
    hideAllMainContentAreas();
    mainContentArea.style.display = 'block';
    mainContentArea.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div></div>`;
    
    try {
        const rekapSnapshot = await db.collection('rekap_saldo_tabungan').get();
        let listHtml = '';
        let grandTotalSaldo = 0;

        if (rekapSnapshot.empty) {
            listHtml = '<div class="alert alert-info">Belum ada data tabungan dari kelas manapun.</div>';
        } else {
            rekapSnapshot.forEach(doc => {
                const data = doc.data();
                const saldoKelas = data.totalSaldoKelas || 0;
                grandTotalSaldo += saldoKelas;
                const saldoFormatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(saldoKelas);
                const namaWaliKelas = data.namaWaliKelas || 'N/A';

                listHtml += `
                    <a href="#" onclick="event.preventDefault(); showDetailRekapTabungan('${doc.id}', '${namaWaliKelas}')" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0 text-primary">Kelas ${doc.id}</h5>
                            <small class="text-muted">Wali Kelas: ${namaWaliKelas}</small>
                        </div>
                        <span class="badge badge-primary badge-pill p-2" style="font-size:1rem;">${saldoFormatted}</span>
                    </a>
                `;
            });
        }

        // --- AWAL PERUBAHAN ---
        const grandTotalFormatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(grandTotalSaldo);
        // Buat HTML untuk kartu total dan sisipkan CSS khusus untuknya
        const totalCardHtml = `
            <style>
                /* Ukuran font default untuk desktop */
                .grand-total-amount {
                    font-size: 3rem;
                    word-break: break-all;
                }
                /* Jika lebar layar 576px atau kurang (HP), kecilkan font */
                @media (max-width: 576px) {
                    .grand-total-amount {
                        font-size: 2.2rem;
                    }
                }
            </style>
            <div class="card bg-success text-white mb-4 shadow">
                <div class="card-body text-center">
                    <h6 class="card-title mb-0">TOTAL GABUNGAN TABUNGAN SISWA</h6>
                    <h2 class="font-weight-bolder grand-total-amount">${grandTotalFormatted}</h2>
                </div>
            </div>
        `;
        // --- AKHIR PERUBAHAN ---

        mainContentArea.innerHTML = `
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="font-weight-bolder mb-3">Rekapitulasi Saldo Tabungan</h4>
                    ${totalCardHtml}
                    <h5 class="font-weight-bold mt-4">Rincian per Kelas:</h5>
                    <div class="list-group">${listHtml}</div>
                </div>
            </div>
        `;
    } catch (error) {
        mainContentArea.innerHTML = `<div class="alert alert-danger">Gagal memuat rekap tabungan: ${error.message}</div>`;
    }
}

// GANTI KESELURUHAN FUNGSI INI DENGAN VERSI BARU
async function showDetailRekapTabungan(kelasId, namaWaliKelas) {
    mainContentArea.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div><p>Memuat detail rekap...</p></div>`;

    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1;

    const renderDetail = async (y, m) => {
        try {
            const docId = `${kelasId}_${y}_${String(m).padStart(2, '0')}`;
            const docSnap = await db.collection('tabungan_kelas').doc(docId).get();
            let tableRows = '';
            
            // --- AWAL MODIFIKASI ---
            let tfootHtml = ''; // 1. Siapkan variabel untuk footer tabel
            // --- AKHIR MODIFIKASI ---

            if (docSnap.exists) {
                const riwayat = docSnap.data().riwayatTransaksi || [];
                const groupedByDate = riwayat.reduce((acc, tx) => {
                    const date = tx.tanggal;
                    if (!acc[date]) {
                        acc[date] = { totalSetor: 0, totalTarik: 0 };
                    }
                    if (tx.tipe === 'Setor') acc[date].totalSetor += tx.jumlah;
                    else acc[date].totalTarik += tx.jumlah;
                    return acc;
                }, {});

                const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
                
                // --- AWAL MODIFIKASI ---
                let totalSetorBulanan = 0; // 2. Siapkan variabel untuk total bulanan
                let totalTarikBulanan = 0;
                // --- AKHIR MODIFIKASI ---

                sortedDates.forEach(date => {
                    const group = groupedByDate[date];
                    
                    // --- AWAL MODIFIKASI ---
                    totalSetorBulanan += group.totalSetor; // 3. Jumlahkan total harian ke total bulanan
                    totalTarikBulanan += group.totalTarik;
                    // --- AKHIR MODIFIKASI ---

                    const formattedDate = new Date(date).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
                    tableRows += `
                        <tr>
                            <td>${formattedDate}</td>
                            <td class="text-right text-success font-weight-bold">${new Intl.NumberFormat('id-ID').format(group.totalSetor)}</td>
                            <td class="text-right text-danger font-weight-bold">${new Intl.NumberFormat('id-ID').format(group.totalTarik)}</td>
                        </tr>
                    `;
                });
                
                // --- AWAL MODIFIKASI ---
                // 4. Buat HTML untuk footer tabel yang berisi total bulanan
                const totalSetorBulananFormatted = new Intl.NumberFormat('id-ID').format(totalSetorBulanan);
                const totalTarikBulananFormatted = new Intl.NumberFormat('id-ID').format(totalTarikBulanan);
                tfootHtml = `
                    <tfoot class="bg-light font-weight-bolder">
                        <tr>
                            <td>Total Bulan Ini</td>
                            <td class="text-right text-success">${totalSetorBulananFormatted}</td>
                            <td class="text-right text-danger">${totalTarikBulananFormatted}</td>
                        </tr>
                    </tfoot>
                `;
                // --- AKHIR MODIFIKASI ---

            } else {
                tableRows = '<tr><td colspan="3" class="text-center text-muted">Tidak ada transaksi pada bulan ini.</td></tr>';
            }

            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            let monthOptions = '';
            for(let i = 1; i <= 12; i++) monthOptions += `<option value="${i}" ${i === m ? 'selected' : ''}>${monthNames[i-1]}</option>`;
            let yearOptions = '';
            for(let i = new Date().getFullYear(); i >= 2020; i--) yearOptions += `<option value="${i}" ${i === y ? 'selected' : ''}>${i}</option>`;

            mainContentArea.innerHTML = `
                 <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <button class="btn btn-light" onclick="showRekapSemuaTabungan()"><i class="fas fa-arrow-left mr-2"></i>Kembali</button>
                                <h4 class="font-weight-bolder d-inline-block ml-2 mb-0">Rekap Harian Kelas ${kelasId}</h4>
                            </div>
                            <div class="form-inline">
                                <select id="month-select-rekap" class="form-control mr-2">${monthOptions}</select>
                                <select id="year-select-rekap" class="form-control">${yearOptions}</select>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Tanggal</th>
                                        <th class="text-right">Total Setoran (Rp)</th>
                                        <th class="text-right">Total Penarikan (Rp)</th>
                                    </tr>
                                </thead>
                                <tbody>${tableRows}</tbody>
                                ${tfootHtml} </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('month-select-rekap').addEventListener('change', (e) => renderDetail(parseInt(document.getElementById('year-select-rekap').value), parseInt(e.target.value)));
            document.getElementById('year-select-rekap').addEventListener('change', (e) => renderDetail(parseInt(e.target.value), parseInt(document.getElementById('month-select-rekap').value)));

        } catch (error) {
            mainContentArea.innerHTML = `<div class="alert alert-danger">Gagal memuat detail rekap: ${error.message}</div>`;
        }
    };

    renderDetail(year, month);
}

// Membuka modal untuk setor/tarik
async function openSetorTarikModal(tipe) {
    document.getElementById('formTabungan').reset();
    $('#tabunganModalTitle').text(`${tipe} Tunai`);
    document.getElementById('tabunganTipe').value = tipe;

    const siswaSelect = document.getElementById('siswaSelect');
    const refreshBtn = document.getElementById('refreshSiswaListBtn');
    siswaSelect.innerHTML = '<option value="">Memuat dari cache...</option>';

    // Fungsi untuk mengisi dropdown dari data
    const populateDropdown = (siswaList) => {
        if (!siswaList || siswaList.length === 0) {
            siswaSelect.innerHTML = '<option value="">Cache kosong, silakan refresh.</option>';
            return;
        }
        siswaSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';
        siswaList.forEach(siswa => {
            siswaSelect.innerHTML += `<option value="${siswa.nisn}" data-nama="${siswa.nama}">${siswa.nomorAbsen}. ${siswa.nama}</option>`;
        });
    };

    try {
        // 1. Coba baca dari cache (HANYA 1 READ)
        const kelasId = currentUser.kelasDiampu;
        const cacheRef = db.collection('cache_daftar_siswa').doc(kelasId);
        const cacheDoc = await cacheRef.get();

        if (cacheDoc.exists) {
            populateDropdown(cacheDoc.data().daftarSiswa);
        } else {
            siswaSelect.innerHTML = '<option value="">Cache belum ada, silakan refresh.</option>';
        }

        // 2. Tambahkan event listener ke tombol refresh
        refreshBtn.onclick = async () => {
            const refreshedList = await refreshSiswaCache(kelasId);
            if (refreshedList) {
                populateDropdown(refreshedList);
            }
        };

        document.getElementById('tanggalTabungan').valueAsDate = new Date();
        $('#tabunganModal').modal('show');
    } catch(error) {
        Toastify({ text: `Gagal memuat cache: ${error.message}`, style: { background: "red" } }).showToast();
    }
}

// Event listener untuk tombol simpan di modal tabungan
document.getElementById('saveTabunganBtn').addEventListener('click', async () => {
    const form = document.getElementById('formTabungan');
    if (!form.checkValidity()) { form.reportValidity(); return; }

    const btn = document.getElementById('saveTabunganBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Menyimpan...';

    const txIdToEdit = document.getElementById('tabunganTxId').value;
    const isEditMode = !!txIdToEdit;
    const tipe = document.getElementById('tabunganTipe').value;
    const siswaOption = document.getElementById('siswaSelect').selectedOptions[0];
    const nisn = siswaOption.value;
    const namaSiswa = siswaOption.dataset.nama;
    const jumlah = parseInt(document.getElementById('jumlahTabungan').value);
    const tanggal = document.getElementById('tanggalTabungan').value;
    const keterangan = document.getElementById('keteranganTabungan').value;

    const kelasId = currentUser.kelasDiampu;
    const txDate = new Date(tanggal);
    const docId = `${kelasId}_${txDate.getFullYear()}_${String(txDate.getMonth() + 1).padStart(2, '0')}`;

    const docRef = db.collection('tabungan_kelas').doc(docId);
    const rekapRef = db.collection('rekap_saldo_tabungan').doc(kelasId);

    try {
        await db.runTransaction(async (transaction) => {
            const doc = await transaction.get(docRef);

            if (isEditMode) {
                if (!doc.exists) throw "Dokumen bulanan tidak ditemukan.";
                const dataBulanan = doc.data();
                const riwayatLama = dataBulanan.riwayatTransaksi || [];
                const txLama = riwayatLama.find(tx => tx.id === txIdToEdit);
                if (!txLama) throw "Transaksi lama tidak ditemukan.";

                const dampakLama = txLama.tipe === 'Setor' ? txLama.jumlah : -txLama.jumlah;
                const dampakBaru = tipe === 'Setor' ? jumlah : -jumlah;
                const selisihDampak = dampakBaru - dampakLama;

                const txBaru = { ...txLama, nisn, namaSiswa, tipe, jumlah, tanggal, keterangan };
                const riwayatBaru = riwayatLama.map(tx => tx.id === txIdToEdit ? txBaru : tx);

                transaction.update(docRef, { riwayatTransaksi: riwayatBaru });
                transaction.update(rekapRef, { totalSaldoKelas: firebase.firestore.FieldValue.increment(selisihDampak) });

            } else { // Mode Buat Baru
                const newTx = { nisn, namaSiswa, tipe, jumlah, tanggal, keterangan, id: new Date().getTime().toString() };
                const saldoPerubahan = tipe === 'Setor' ? jumlah : -jumlah;

                if (doc.exists) {
                    transaction.update(docRef, { riwayatTransaksi: firebase.firestore.FieldValue.arrayUnion(newTx) });
                } else {
                    transaction.set(docRef, {
                        idKelas: kelasId,
                        tahun: txDate.getFullYear(),
                        bulan: txDate.getMonth() + 1,
                        riwayatTransaksi: [newTx]
                    });
                }
                transaction.set(rekapRef, {
                    totalSaldoKelas: firebase.firestore.FieldValue.increment(saldoPerubahan),
                    namaWaliKelas: currentUser.name,
                    terakhirUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
            }
        });

        Toastify({ text: `Transaksi tabungan berhasil ${isEditMode ? 'diperbarui' : 'disimpan'}!`, style: { background: "green" } }).showToast();
        $('#tabunganModal').modal('hide');
        showTabunganKelas();

    } catch (error) {
        console.error("Error saving saving transaction: ", error);
        Toastify({ text: `Gagal menyimpan: ${error}`, style: { background: "red" } }).showToast();
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Simpan';
    }
});

// TAMBAHKAN FUNGSI BARU INI
async function refreshSiswaCache(kelasId) {
    const refreshBtn = document.getElementById('refreshSiswaListBtn');
    const icon = refreshBtn.querySelector('i');

    // Tampilkan loading spinner
    icon.classList.add('fa-spin');
    refreshBtn.disabled = true;

    try {
        // 1. Ambil data siswa terbaru dari koleksi 'siswa' (ini adalah query yang "mahal")
        const snapshot = await db.collection('siswa')
            .where('kelas', '==', kelasId)
            .where('status', '==', 'Aktif')
            .orderBy('nomorAbsen')
            .get();

        // 2. Siapkan data untuk disimpan ke cache
        const daftarSiswa = snapshot.docs.map(doc => {
            const siswa = doc.data();
            return { nisn: siswa.nisn, nama: siswa.nama, nomorAbsen: siswa.nomorAbsen };
        });

        // 3. Simpan data baru ke dokumen cache
        const cacheRef = db.collection('cache_daftar_siswa').doc(kelasId);
        await cacheRef.set({
            idKelas: kelasId,
            terakhirUpdate: firebase.firestore.FieldValue.serverTimestamp(),
            daftarSiswa: daftarSiswa
        });

        Toastify({ text: "Daftar siswa berhasil diperbarui!", style: { background: "green" } }).showToast();
        return daftarSiswa; // Kembalikan data baru agar bisa langsung digunakan

    } catch (error) {
        console.error("Error refreshing student cache:", error);
        Toastify({ text: `Gagal memperbarui: ${error.message}`, style: { background: "red" } }).showToast();
        return null;
    } finally {
        // Hentikan loading spinner
        icon.classList.remove('fa-spin');
        refreshBtn.disabled = false;
    }
}
function setJumlahTabungan(amount) {
    document.getElementById('jumlahTabungan').value = amount;
}
// TAMBAHKAN FUNGSI BARU INI
async function refreshDaftarSiswaCache(kelasId, refreshBtnElement) {
    const originalHtml = refreshBtnElement.innerHTML;
    refreshBtnElement.disabled = true;
    refreshBtnElement.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Memperbarui...`;

    try {
        const snapshot = await db.collection('siswa')
            .where('kelas', '==', kelasId)
            // .where('status', '==', 'Aktif') // Dihapus agar siswa pindahan/lulus tetap masuk cache
            .orderBy('nomorAbsen')
            .get();

        const daftarSiswa = snapshot.docs.map(doc => doc.data());

        const cacheRef = db.collection('cache_daftar_siswa').doc(kelasId);
        await cacheRef.set({
            idKelas: kelasId,
            terakhirUpdate: firebase.firestore.FieldValue.serverTimestamp(),
            daftarSiswa: daftarSiswa
        });
        
        Toastify({ text: "Data siswa berhasil diperbarui!", style: { background: "green" } }).showToast();
        return daftarSiswa;

    } catch (error) {
        console.error("Error refreshing student cache:", error);
        Toastify({ text: `Gagal memperbarui: ${error.message}`, style: { background: "red" } }).showToast();
        return null;
    } finally {
        refreshBtnElement.disabled = false;
        refreshBtnElement.innerHTML = originalHtml;
    }
}

</script>
</body>
</html>
